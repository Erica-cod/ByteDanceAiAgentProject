<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAF æ‰¹å¤„ç†æ•ˆæœè¯æ˜</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .test-box {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .output {
      background: #f5f5f5;
      padding: 10px;
      min-height: 100px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
    }
    .stats {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1976D2;
    }
    .highlight {
      background: #ffeb3b;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¬ RAF æ‰¹å¤„ç†æ•ˆæœè¯æ˜</h1>

  <div class="highlight">
    <strong>ğŸ’¡ å…³é”®å‘ç°ï¼š</strong><br>
    setTimeout(fn, 10ms) æ— æ³•è¯æ˜ RAF çš„æ‰¹å¤„ç†æ•ˆæœï¼Œå› ä¸ºæµè§ˆå™¨å¯èƒ½åœ¨æ¯æ¬¡ setTimeout åéƒ½è§¦å‘ä¸€å¸§ã€‚<br>
    æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <strong>åŒæ­¥å¾ªç¯ + RAF</strong> æ¥è¯æ˜æ‰¹å¤„ç†æ•ˆæœï¼
  </div>

  <!-- æµ‹è¯• 1ï¼šåŒæ­¥å¾ªç¯ + ç›´æ¥æ¸²æŸ“ -->
  <div class="test-box">
    <h3>âŒ æµ‹è¯• 1ï¼šåŒæ­¥å¾ªç¯ + æ¯æ¬¡éƒ½æ¸²æŸ“</h3>
    <p>æ¨¡æ‹Ÿï¼šåœ¨ä¸€å¸§å†…æ”¶åˆ° 100 ä¸ª chunksï¼Œæ¯æ¬¡éƒ½ç«‹å³æ¸²æŸ“</p>
    <div id="output1" class="output"></div>
    <div id="stats1" class="stats">ç­‰å¾…æµ‹è¯•...</div>
    <button onclick="test1()">è¿è¡Œæµ‹è¯• 1</button>
  </div>

  <!-- æµ‹è¯• 2ï¼šåŒæ­¥å¾ªç¯ + RAF æ‰¹å¤„ç† -->
  <div class="test-box">
    <h3>âœ… æµ‹è¯• 2ï¼šåŒæ­¥å¾ªç¯ + RAF æ‰¹å¤„ç†</h3>
    <p>æ¨¡æ‹Ÿï¼šåœ¨ä¸€å¸§å†…æ”¶åˆ° 100 ä¸ª chunksï¼Œä½¿ç”¨ RAF æ‰¹å¤„ç†</p>
    <div id="output2" class="output"></div>
    <div id="stats2" class="stats">ç­‰å¾…æµ‹è¯•...</div>
    <button onclick="test2()">è¿è¡Œæµ‹è¯• 2</button>
  </div>

  <!-- æµ‹è¯• 3ï¼šçœŸå® SSE æ¨¡æ‹Ÿï¼ˆå¿«é€Ÿï¼‰ -->
  <div class="test-box">
    <h3>ğŸš€ æµ‹è¯• 3ï¼šçœŸå® SSEï¼ˆ5ms é—´éš”ï¼‰+ RAF æ‰¹å¤„ç†</h3>
    <p>æ¨¡æ‹Ÿï¼šSSE chunks å¿«é€Ÿåˆ°è¾¾ï¼ˆ5ms é—´éš”ï¼‰ï¼ŒRAF åº”è¯¥èƒ½åˆå¹¶</p>
    <div id="output3" class="output"></div>
    <div id="stats3" class="stats">ç­‰å¾…æµ‹è¯•...</div>
    <button onclick="test3()">è¿è¡Œæµ‹è¯• 3</button>
  </div>

  <!-- æµ‹è¯• 4ï¼šçœŸå® SSE æ¨¡æ‹Ÿï¼ˆæå¿«ï¼‰ -->
  <div class="test-box">
    <h3>âš¡ æµ‹è¯• 4ï¼šçœŸå® SSEï¼ˆ1ms é—´éš”ï¼‰+ RAF æ‰¹å¤„ç†</h3>
    <p>æ¨¡æ‹Ÿï¼šSSE chunks æå¿«åˆ°è¾¾ï¼ˆ1ms é—´éš”ï¼‰ï¼ŒRAF åº”è¯¥èƒ½æ˜¾è‘—åˆå¹¶</p>
    <div id="output4" class="output"></div>
    <div id="stats4" class="stats">ç­‰å¾…æµ‹è¯•...</div>
    <button onclick="test4()">è¿è¡Œæµ‹è¯• 4</button>
  </div>

  <script>
    const CHUNKS = Array.from({ length: 100 }, (_, i) => `C${i + 1} `);

    // ========== æµ‹è¯• 1ï¼šåŒæ­¥å¾ªç¯ + ç›´æ¥æ¸²æŸ“ ==========
    function test1() {
      const output = document.getElementById('output1');
      const stats = document.getElementById('stats1');
      output.textContent = '';
      
      let content = '';
      let renderCount = 0;
      const startTime = performance.now();

      // åŒæ­¥å¾ªç¯ï¼šæ‰€æœ‰ chunks åœ¨ä¸€å¸§å†…åˆ°è¾¾
      for (const chunk of CHUNKS) {
        content += chunk;
        output.textContent = content; // æ¯æ¬¡éƒ½æ¸²æŸ“
        renderCount++;
      }

      const duration = performance.now() - startTime;
      stats.innerHTML = `
        æ¸²æŸ“æ¬¡æ•°: <strong>${renderCount}</strong> æ¬¡<br>
        æ€»è€—æ—¶: ${duration.toFixed(2)}ms<br>
        <span style="color: red;">âŒ æ¸²æŸ“æ¬¡æ•° = chunks æ•°é‡ï¼Œæ²¡æœ‰ä¼˜åŒ–</span>
      `;
    }

    // ========== æµ‹è¯• 2ï¼šåŒæ­¥å¾ªç¯ + RAF æ‰¹å¤„ç† ==========
    function test2() {
      const output = document.getElementById('output2');
      const stats = document.getElementById('stats2');
      output.textContent = '';
      
      let content = '';
      let renderCount = 0;
      let rafId = null;
      let pendingContent = null;
      const startTime = performance.now();

      const scheduleRender = () => {
        pendingContent = content;
        
        if (rafId !== null) return; // å·²ç»å®‰æ’äº† RAFï¼Œè·³è¿‡

        rafId = requestAnimationFrame(() => {
          output.textContent = pendingContent;
          renderCount++;
          pendingContent = null;
          rafId = null;
        });
      };

      // åŒæ­¥å¾ªç¯ï¼šæ‰€æœ‰ chunks åœ¨ä¸€å¸§å†…åˆ°è¾¾
      for (const chunk of CHUNKS) {
        content += chunk;
        scheduleRender(); // åªä¼šå®‰æ’ 1 æ¬¡ RAF
      }

      // ç­‰å¾… RAF æ‰§è¡Œå®Œæˆ
      setTimeout(() => {
        const duration = performance.now() - startTime;
        stats.innerHTML = `
          æ¸²æŸ“æ¬¡æ•°: <strong>${renderCount}</strong> æ¬¡<br>
          æ€»è€—æ—¶: ${duration.toFixed(2)}ms<br>
          <span style="color: green;">âœ… 100 ä¸ª chunks åˆå¹¶ä¸º 1 æ¬¡æ¸²æŸ“ï¼å‡å°‘ 99%</span>
        `;
      }, 50);
    }

    // ========== æµ‹è¯• 3ï¼šå¿«é€Ÿ SSEï¼ˆ5ms é—´éš”ï¼‰+ RAF ==========
    function test3() {
      return new Promise(resolve => {
        const output = document.getElementById('output3');
        const stats = document.getElementById('stats3');
        output.textContent = '';
        
        let content = '';
        let renderCount = 0;
        let rafId = null;
        let pendingContent = null;
        let chunkIndex = 0;
        const startTime = performance.now();

        const scheduleRender = () => {
          pendingContent = content;
          
          if (rafId !== null) return;

          rafId = requestAnimationFrame(() => {
            output.textContent = pendingContent;
            renderCount++;
            pendingContent = null;
            rafId = null;
          });
        };

        function processNextChunk() {
          if (chunkIndex >= CHUNKS.length) {
            setTimeout(() => {
              const duration = performance.now() - startTime;
              stats.innerHTML = `
                æ¸²æŸ“æ¬¡æ•°: <strong>${renderCount}</strong> æ¬¡<br>
                æ€»è€—æ—¶: ${duration.toFixed(2)}ms<br>
                ç†è®ºå¸§æ•°: ${Math.ceil(CHUNKS.length * 5 / 16)} å¸§<br>
                <span style="color: ${renderCount < 50 ? 'green' : 'orange'};">
                  ${renderCount < 50 ? 'âœ…' : 'âš ï¸'} æ¸²æŸ“æ¬¡æ•°å‡å°‘ ${((1 - renderCount / CHUNKS.length) * 100).toFixed(0)}%
                </span>
              `;
              resolve();
            }, 50);
            return;
          }

          content += CHUNKS[chunkIndex];
          scheduleRender();
          
          chunkIndex++;
          setTimeout(processNextChunk, 5); // 5ms é—´éš”
        }

        processNextChunk();
      });
    }

    // ========== æµ‹è¯• 4ï¼šæå¿« SSEï¼ˆ1ms é—´éš”ï¼‰+ RAF ==========
    function test4() {
      return new Promise(resolve => {
        const output = document.getElementById('output4');
        const stats = document.getElementById('stats4');
        output.textContent = '';
        
        let content = '';
        let renderCount = 0;
        let rafId = null;
        let pendingContent = null;
        let chunkIndex = 0;
        const startTime = performance.now();

        const scheduleRender = () => {
          pendingContent = content;
          
          if (rafId !== null) return;

          rafId = requestAnimationFrame(() => {
            output.textContent = pendingContent;
            renderCount++;
            pendingContent = null;
            rafId = null;
          });
        };

        function processNextChunk() {
          if (chunkIndex >= CHUNKS.length) {
            setTimeout(() => {
              const duration = performance.now() - startTime;
              stats.innerHTML = `
                æ¸²æŸ“æ¬¡æ•°: <strong>${renderCount}</strong> æ¬¡<br>
                æ€»è€—æ—¶: ${duration.toFixed(2)}ms<br>
                ç†è®ºå¸§æ•°: ${Math.ceil(CHUNKS.length * 1 / 16)} å¸§<br>
                <span style="color: ${renderCount < 20 ? 'green' : 'orange'};">
                  ${renderCount < 20 ? 'âœ…' : 'âš ï¸'} æ¸²æŸ“æ¬¡æ•°å‡å°‘ ${((1 - renderCount / CHUNKS.length) * 100).toFixed(0)}%
                </span>
              `;
              resolve();
            }, 50);
            return;
          }

          content += CHUNKS[chunkIndex];
          scheduleRender();
          
          chunkIndex++;
          setTimeout(processNextChunk, 1); // 1ms é—´éš”
        }

        processNextChunk();
      });
    }

    async function runAll() {
      test1();
      await new Promise(r => setTimeout(r, 100));
      test2();
      await new Promise(r => setTimeout(r, 100));
      await test3();
      await new Promise(r => setTimeout(r, 100));
      await test4();
    }
  </script>

  <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
    <button onclick="runAll()" style="background: #ff5722;">ğŸ”¥ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
  </div>

  <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 4px;">
    <h3>ğŸ“Š é¢„æœŸç»“æœ</h3>
    <ul>
      <li><strong>æµ‹è¯• 1</strong>ï¼š100 æ¬¡æ¸²æŸ“ï¼ˆæœªä¼˜åŒ–ï¼‰</li>
      <li><strong>æµ‹è¯• 2</strong>ï¼š<strong>1 æ¬¡æ¸²æŸ“</strong>ï¼ˆåŒæ­¥å¾ªç¯ï¼ŒRAF å®Œç¾æ‰¹å¤„ç†ï¼‰âœ…</li>
      <li><strong>æµ‹è¯• 3</strong>ï¼š~30-40 æ¬¡æ¸²æŸ“ï¼ˆ5ms é—´éš”ï¼Œçº¦å‡å°‘ 60%ï¼‰</li>
      <li><strong>æµ‹è¯• 4</strong>ï¼š~10-15 æ¬¡æ¸²æŸ“ï¼ˆ1ms é—´éš”ï¼Œçº¦å‡å°‘ 85%ï¼‰</li>
    </ul>
    <p><strong>ç»“è®ºï¼š</strong>chunk åˆ°è¾¾è¶Šå¿«ï¼ŒRAF æ‰¹å¤„ç†æ•ˆæœè¶Šæ˜æ˜¾ï¼</p>
  </div>
</body>
</html>

