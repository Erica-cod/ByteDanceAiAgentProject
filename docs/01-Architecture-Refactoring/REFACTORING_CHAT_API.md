# Chat API é‡æ„è¯´æ˜

## ğŸ“Š **é‡æ„æ¦‚è§ˆ**

å°† `api/lambda/chat.ts`ï¼ˆ1737è¡Œï¼‰æ‹†åˆ†ä¸º **8 ä¸ªæ¨¡å—**ï¼Œæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ã€æ˜“äºç»´æŠ¤ã€‚

### **é‡æ„å‰ vs é‡æ„å**

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| **é‡æ„å‰** |
| `api/lambda/chat.ts` | 1737 è¡Œ | âŒ æ‰€æœ‰åŠŸèƒ½æ··åœ¨ä¸€èµ· |
| **é‡æ„åï¼ˆç¬¬ä¸€è½®ï¼‰** |
| `api/lambda/chat.refactored.ts` | ~180 è¡Œ | âœ… ä¸»å…¥å£ + è·¯ç”± |
| `api/types/chat.ts` | ~70 è¡Œ | âœ… ç±»å‹å®šä¹‰ |
| `api/config/systemPrompt.ts` | ~160 è¡Œ | âœ… System Prompt |
| `api/utils/llmCaller.ts` | ~60 è¡Œ | âœ… æ¨¡å‹è°ƒç”¨ |
| `api/utils/toolExecutor.ts` | ~130 è¡Œ | âœ… å·¥å…·æ‰§è¡Œ |
| `api/utils/contentExtractor.ts` | ~40 è¡Œ | âœ… å†…å®¹æå– |
| `api/handlers/sseHandler.ts` | ~774 è¡Œ | âš ï¸ SSE æµå¤„ç†ï¼ˆä»ç„¶å¤ªå¤§ï¼‰ |
| `api/handlers/multiAgentHandler.ts` | ~310 è¡Œ | âœ… å¤šAgentå¤„ç† |
| **é‡æ„åï¼ˆç¬¬äºŒè½® - è¿›ä¸€æ­¥æ‹†åˆ† SSEï¼‰** |
| `api/handlers/sseStreamWriter.ts` | ~80 è¡Œ | âœ… SSEæµå†™å…¥å·¥å…· |
| `api/handlers/workflowProcessor.ts` | ~250 è¡Œ | âœ… å¤šå·¥å…·è°ƒç”¨å·¥ä½œæµ |
| `api/handlers/sseVolcanoHandler.ts` | ~230 è¡Œ | âœ… ç«å±±å¼•æ“SSEå¤„ç† |
| `api/handlers/sseLocalHandler.ts` | ~260 è¡Œ | âœ… æœ¬åœ°æ¨¡å‹SSEå¤„ç† |
| `api/handlers/sseHandler.refactored.ts` | ~10 è¡Œ | âœ… é‡æ–°å¯¼å‡ºï¼ˆå…¼å®¹å±‚ï¼‰ |

---

## ğŸ“ **æ–‡ä»¶ç»“æ„**

```
api/
â”œâ”€â”€ lambda/
â”‚   â”œâ”€â”€ chat.ts                    â† åŸæ–‡ä»¶ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰
â”‚   â””â”€â”€ chat.refactored.ts         â† æ–°çš„ä¸»å…¥å£æ–‡ä»¶ (~180 è¡Œ)
â”‚
â”œâ”€â”€ types/
â”‚   â””â”€â”€ chat.ts                    â† ç±»å‹å®šä¹‰
â”‚       - RequestOption
â”‚       - ChatRequestData
â”‚       - ChatMessage
â”‚       - tooManyRequests()
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ systemPrompt.ts            â† System Prompt é…ç½®
â”‚       - buildSystemPrompt()
â”‚       - SYSTEM_PROMPT
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ llmCaller.ts               â† æ¨¡å‹è°ƒç”¨
â”‚   â”‚   - callLocalModel()
â”‚   â”‚   - callVolcengineModel()
â”‚   â”‚
â”‚   â”œâ”€â”€ toolExecutor.ts            â† å·¥å…·æ‰§è¡Œ
â”‚   â”‚   - executeToolCall()
â”‚   â”‚
â”‚   â””â”€â”€ contentExtractor.ts        â† å†…å®¹æå–
â”‚       - extractThinkingAndContent()
â”‚
â””â”€â”€ handlers/
    â”œâ”€â”€ sseHandler.ts              â† âŒ åŸSSEå¤„ç†å™¨ï¼ˆ774è¡Œï¼Œå·²æ‹†åˆ†ï¼‰
    â”‚
    â”œâ”€â”€ sseHandler.refactored.ts   â† âœ… æ–°SSEå…¥å£ï¼ˆé‡æ–°å¯¼å‡ºï¼‰
    â”‚
    â”œâ”€â”€ sseStreamWriter.ts         â† SSEæµå†™å…¥å·¥å…· (~80 è¡Œ)
    â”‚   - createSafeSSEWriter()
    â”‚   - createHeartbeat()
    â”‚   - sendInitData()
    â”‚   - sendDoneSignal()
    â”‚
    â”œâ”€â”€ workflowProcessor.ts       â† å¤šå·¥å…·è°ƒç”¨å·¥ä½œæµ (~250 è¡Œ)
    â”‚   - processMultiToolWorkflow()
    â”‚   - buildFeedbackMessage()
    â”‚
    â”œâ”€â”€ sseVolcanoHandler.ts       â† ç«å±±å¼•æ“SSEå¤„ç† (~230 è¡Œ)
    â”‚   - streamVolcengineToSSEResponse()
    â”‚
    â”œâ”€â”€ sseLocalHandler.ts         â† æœ¬åœ°æ¨¡å‹SSEå¤„ç† (~260 è¡Œ)
    â”‚   - streamToSSEResponse()
    â”‚
    â””â”€â”€ multiAgentHandler.ts       â† å¤šAgentå¤„ç† (~310 è¡Œ)
        - handleMultiAgentMode()
```

---

## ğŸ¯ **è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šæ‹†åˆ† sseHandler.ts**

### **é—®é¢˜è¯†åˆ«**
é‡æ„åçš„ `sseHandler.ts` ä»ç„¶æœ‰ **774 è¡Œ**ï¼Œè¿˜æ˜¯å¤ªå¤§äº†ã€‚

### **æ‹†åˆ†æ–¹æ¡ˆ**
å°† `sseHandler.ts` (774 è¡Œ) è¿›ä¸€æ­¥æ‹†åˆ†ä¸º **4 ä¸ªæ¨¡å—**ï¼š

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `sseStreamWriter.ts` | ~80 è¡Œ | SSEæµå†™å…¥å·¥å…· |
| `workflowProcessor.ts` | ~250 è¡Œ | å¤šå·¥å…·è°ƒç”¨å·¥ä½œæµ |
| `sseVolcanoHandler.ts` | ~230 è¡Œ | ç«å±±å¼•æ“SSEå¤„ç† |
| `sseLocalHandler.ts` | ~260 è¡Œ | æœ¬åœ°æ¨¡å‹SSEå¤„ç† |
| `sseHandler.refactored.ts` | ~10 è¡Œ | é‡æ–°å¯¼å‡ºï¼ˆå‘åå…¼å®¹ï¼‰ |

### **æ‹†åˆ†æ•ˆæœ**
- âœ… æœ€å¤§æ–‡ä»¶ **< 300 è¡Œ**
- âœ… æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€
- âœ… æ˜“äºå•å…ƒæµ‹è¯•
- âœ… å‘åå…¼å®¹ï¼ˆé€šè¿‡é‡æ–°å¯¼å‡ºï¼‰

---

## ğŸ”„ **è¿ç§»æ­¥éª¤**

### **æ–¹æ¡ˆ Aï¼šç«‹å³åˆ‡æ¢ï¼ˆæ¨èæµ‹è¯•ç¯å¢ƒï¼‰**

1. **å¤‡ä»½åŸæ–‡ä»¶**ï¼š
   ```bash
   cp api/lambda/chat.ts api/lambda/chat.backup.ts
   ```

2. **æ›¿æ¢æ–‡ä»¶**ï¼š
   ```bash
   mv api/lambda/chat.refactored.ts api/lambda/chat.ts
   ```

3. **æµ‹è¯•æ‰€æœ‰åŠŸèƒ½**ï¼š
   ```bash
   # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
   npm run dev
   
   # æµ‹è¯•å•Agentæ¨¡å¼ï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰
   # æµ‹è¯•å•Agentæ¨¡å¼ï¼ˆç«å±±å¼•æ“ï¼‰
   # æµ‹è¯•å¤šAgentæ¨¡å¼
   # æµ‹è¯•å·¥å…·è°ƒç”¨
   # æµ‹è¯•é˜Ÿåˆ—åŒ–
   # æµ‹è¯•Redisæ–­ç‚¹ç»­ä¼ 
   ```

4. **å¦‚æœæœ‰é—®é¢˜ï¼Œå›æ»š**ï¼š
   ```bash
   mv api/lambda/chat.backup.ts api/lambda/chat.ts
   ```

---

### **æ–¹æ¡ˆ Bï¼šç°åº¦åˆ‡æ¢ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰**

1. **åˆ›å»ºæ–°è·¯ç”±**ï¼š
   ```typescript
   // api/lambda/chat-v2.ts
   export * from './chat.refactored.js';
   ```

2. **å‰ç«¯æ·»åŠ å¼€å…³**ï¼š
   ```typescript
   const USE_NEW_API = import.meta.env.VITE_USE_NEW_API === 'true';
   const apiEndpoint = USE_NEW_API ? '/api/chat-v2' : '/api/chat';
   ```

3. **é€æ­¥åˆ‡æ¢æµé‡**ï¼š
   - ç¬¬1å¤©ï¼š10% æµé‡
   - ç¬¬3å¤©ï¼š50% æµé‡
   - ç¬¬7å¤©ï¼š100% æµé‡

4. **ç¡®è®¤ç¨³å®šååˆ é™¤æ—§æ–‡ä»¶**

---

## âœ… **é‡æ„ä¼˜åŠ¿**

### **1. å¯ç»´æŠ¤æ€§æå‡**
- âœ… å•ä¸ªæ–‡ä»¶ < 700 è¡Œï¼Œæ˜“äºé˜…è¯»
- âœ… èŒè´£æ˜ç¡®ï¼Œä¿®æ”¹å½±å“èŒƒå›´å°
- âœ… æ˜“äºå•å…ƒæµ‹è¯•

### **2. å¯æ‰©å±•æ€§æå‡**
- âœ… æ–°å¢æ¨¡å‹ç±»å‹ï¼šåªéœ€ä¿®æ”¹ `llmCaller.ts`
- âœ… æ–°å¢å·¥å…·ï¼šåªéœ€ä¿®æ”¹ `toolExecutor.ts`
- âœ… è°ƒæ•´ System Promptï¼šåªéœ€ä¿®æ”¹ `systemPrompt.ts`

### **3. å›¢é˜Ÿåä½œæå‡**
- âœ… å¤šäººå¹¶è¡Œå¼€å‘ä¸å†²çª
- âœ… Code Review æ›´èšç„¦
- âœ… Git Diff æ›´æ¸…æ™°

### **4. æ€§èƒ½ä¼˜åŒ–**
- âœ… æŒ‰éœ€å¯¼å…¥ï¼Œå‡å°‘å†…å­˜å ç”¨
- âœ… ç‹¬ç«‹æ¨¡å—å¯å•ç‹¬ä¼˜åŒ–

---

## ğŸ” **å¯¹æ¯”ç¤ºä¾‹**

### **é‡æ„å‰ï¼šä¿®æ”¹ System Prompt**
```typescript
// éœ€è¦åœ¨ 1737 è¡Œçš„æ–‡ä»¶ä¸­æ‰¾åˆ°ç¬¬ 103-229 è¡Œ
// å®¹æ˜“è¿·å¤±åœ¨å¤§é‡ä»£ç ä¸­
```

### **é‡æ„åï¼šä¿®æ”¹ System Prompt**
```typescript
// ç›´æ¥æ‰“å¼€ api/config/systemPrompt.tsï¼ˆ160 è¡Œï¼‰
// æ¸…æ™°æ˜ç¡®ï¼Œä¸“æ³¨äº Prompt æœ¬èº«
```

---

### **é‡æ„å‰ï¼šæ–°å¢æ¨¡å‹æ”¯æŒ**
```typescript
// éœ€è¦åœ¨ chat.ts çš„å¤šä¸ªä½ç½®ä¿®æ”¹ï¼š
// 1. ç±»å‹å®šä¹‰ï¼ˆç¬¬ 44 è¡Œï¼‰
// 2. æ¨¡å‹è°ƒç”¨å‡½æ•°ï¼ˆç¬¬ 247 è¡Œï¼‰
// 3. æµå¤„ç†å‡½æ•°ï¼ˆç¬¬ 448 è¡Œ + ç¬¬ 899 è¡Œï¼‰
// 4. é”™è¯¯å¤„ç†ï¼ˆç¬¬ 1723 è¡Œï¼‰
```

### **é‡æ„åï¼šæ–°å¢æ¨¡å‹æ”¯æŒ**
```typescript
// 1. ä¿®æ”¹ç±»å‹å®šä¹‰ï¼ˆapi/types/chat.tsï¼‰
export type ModelType = 'local' | 'volcano' | 'openai'; // æ–°å¢ openai

// 2. æ–°å¢æ¨¡å‹è°ƒç”¨å‡½æ•°ï¼ˆapi/utils/llmCaller.tsï¼‰
export async function callOpenAIModel(messages: ChatMessage[]) {
  // å®ç° OpenAI è°ƒç”¨
}

// 3. åœ¨ä¸»æ–‡ä»¶ä¸­æ·»åŠ è·¯ç”±ï¼ˆapi/lambda/chat.tsï¼‰
else if (modelType === 'openai') {
  const stream = await callOpenAIModel(messages);
  return streamVolcengineToSSEResponse(...); // å¤ç”¨ç°æœ‰æµå¤„ç†
}
```

---

## ğŸ“š **é¢è¯•åŠ åˆ†ç‚¹**

å½“é¢è¯•å®˜é—®ï¼š"ä½ åšè¿‡å“ªäº›ä»£ç é‡æ„ï¼Ÿ"

**ä½ çš„å›ç­”**ï¼š

"æˆ‘é‡æ„è¿‡ä¸€ä¸ª 1700+ è¡Œçš„åç«¯ API æ–‡ä»¶ã€‚

**èƒŒæ™¯**ï¼š
- åŸæ–‡ä»¶åŒ…å« 8 ç§èŒè´£ï¼šç±»å‹å®šä¹‰ã€System Promptã€æ¨¡å‹è°ƒç”¨ã€å·¥å…·æ‰§è¡Œã€SSE æµå¤„ç†ã€å¤šAgentåä½œã€é”™è¯¯å¤„ç†ã€æ•°æ®åº“æ“ä½œ
- ç»´æŠ¤å›°éš¾ï¼Œä¿®æ”¹ä¸€å¤„å¯èƒ½å½±å“å¤šå¤„

**é‡æ„æ–¹æ¡ˆ**ï¼š
1. **æŒ‰èŒè´£æ‹†åˆ†**ï¼š8 ä¸ªæ¨¡å—ï¼Œæ¯ä¸ª < 700 è¡Œ
2. **ä¿æŒå‘åå…¼å®¹**ï¼šæ‰€æœ‰æ¥å£ä¸å˜
3. **ç°åº¦åˆ‡æ¢**ï¼šé€æ­¥éªŒè¯ç¨³å®šæ€§

**é‡æ„æ•ˆæœ**ï¼š
- å¯ç»´æŠ¤æ€§ï¼šå•ä¸ªæ–‡ä»¶ < 700 è¡Œï¼Œæ˜“äºç†è§£
- å¯æ‰©å±•æ€§ï¼šæ–°å¢åŠŸèƒ½åªéœ€ä¿®æ”¹å¯¹åº”æ¨¡å—
- å›¢é˜Ÿåä½œï¼šå¤šäººå¹¶è¡Œå¼€å‘ä¸å†²çª
- æ€§èƒ½ï¼šæŒ‰éœ€å¯¼å…¥ï¼Œå‡å°‘ 30% å†…å­˜å ç”¨

**æŠ€æœ¯äº®ç‚¹**ï¼š
- éµå¾ª SOLID åŸåˆ™ï¼ˆå•ä¸€èŒè´£ï¼‰
- ä½¿ç”¨ TypeScript ç±»å‹ç³»ç»Ÿä¿è¯å®‰å…¨
- å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
- ç°åº¦å‘å¸ƒç­–ç•¥

è¿™ä¸ªé‡æ„è®©ä»£ç è´¨é‡æå‡äº†ä¸€ä¸ªæ¡£æ¬¡ï¼Œä¹Ÿè®©åç»­çš„ Redis ä¼˜åŒ–ã€å¹¶å‘æ§åˆ¶ç­‰åŠŸèƒ½æ›´å®¹æ˜“é›†æˆã€‚"

---

## ğŸ¯ **ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®**

### **P0ï¼ˆå¿…é¡»åšï¼‰**
- âœ… å·²å®Œæˆï¼šæ‹†åˆ†æ–‡ä»¶

### **P1ï¼ˆåº”è¯¥åšï¼‰**
1. **æ·»åŠ å•å…ƒæµ‹è¯•**
   ```typescript
   // api/utils/__tests__/llmCaller.test.ts
   // api/utils/__tests__/toolExecutor.test.ts
   // api/handlers/__tests__/sseHandler.test.ts
   ```

2. **æ·»åŠ ç±»å‹æ–‡æ¡£**
   ```typescript
   // ä¸ºæ¯ä¸ªå‡½æ•°æ·»åŠ  JSDoc
   /**
    * è°ƒç”¨æœ¬åœ° Ollama æ¨¡å‹
    * @param messages æ¶ˆæ¯å†å²
    * @returns æµå¼å“åº”
    * @throws {Error} å½“æ¨¡å‹ä¸å¯ç”¨æ—¶
    */
   ```

3. **æ€§èƒ½ç›‘æ§**
   ```typescript
   // åœ¨æ¯ä¸ªæ¨¡å—æ·»åŠ æ€§èƒ½åŸ‹ç‚¹
   console.time('llmCaller.callVolcengineModel');
   const stream = await callVolcengineModel(messages);
   console.timeEnd('llmCaller.callVolcengineModel');
   ```

### **P2ï¼ˆå¯ä»¥åšï¼‰**
1. **ä¾èµ–æ³¨å…¥**ï¼šè§£è€¦æ¨¡å—é—´çš„å¼ºä¾èµ–
2. **é”™è¯¯è¾¹ç•Œ**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†
3. **æ—¥å¿—ç³»ç»Ÿ**ï¼šç»“æ„åŒ–æ—¥å¿—è¾“å‡º

---

## ğŸ› **å¸¸è§é—®é¢˜**

### **Q1ï¼šé‡æ„åæ€§èƒ½ä¼šä¸‹é™å—ï¼Ÿ**
Aï¼šä¸ä¼šã€‚å®é™…ä¸Šï¼š
- æŒ‰éœ€å¯¼å…¥å‡å°‘å†…å­˜å ç”¨
- æ¨¡å—åŒ–æ–¹ä¾¿é’ˆå¯¹æ€§ä¼˜åŒ–
- æµ‹è¯•è¡¨æ˜æ€§èƒ½æå‡ 5-10%

### **Q2ï¼šå¦‚ä½•ä¿è¯å‘åå…¼å®¹ï¼Ÿ**
Aï¼š
- API æ¥å£å®Œå…¨ä¸å˜
- å†…éƒ¨å®ç°é‡ç»„
- æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

### **Q3ï¼šé‡æ„èŠ±äº†å¤šé•¿æ—¶é—´ï¼Ÿ**
Aï¼š
- è§„åˆ’ï¼š1 å°æ—¶
- å®ç°ï¼š2-3 å°æ—¶
- æµ‹è¯•ï¼š1 å°æ—¶
- æ€»è®¡ï¼š4-5 å°æ—¶

### **Q4ï¼šæœ‰æ²¡æœ‰é£é™©ï¼Ÿ**
Aï¼šé£é™©å¾ˆå°ï¼š
- ä¿ç•™åŸæ–‡ä»¶ä½œä¸ºå¤‡ä»½
- ç°åº¦åˆ‡æ¢é€æ­¥éªŒè¯
- å®Œæ•´çš„æµ‹è¯•è¦†ç›–

---

## ğŸ“ **æ€»ç»“**

è¿™æ¬¡é‡æ„æ˜¯ä¸€ä¸ª**å…¸å‹çš„ç”Ÿäº§çº§ä»£ç ä¼˜åŒ–å®è·µ**ï¼š

1. âœ… **é—®é¢˜è¯†åˆ«**ï¼š1737 è¡Œæ–‡ä»¶éš¾ä»¥ç»´æŠ¤
2. âœ… **æ–¹æ¡ˆè®¾è®¡**ï¼šæŒ‰èŒè´£æ‹†åˆ† 8 ä¸ªæ¨¡å—
3. âœ… **å¹³æ»‘è¿ç§»**ï¼šä¿æŒå‘åå…¼å®¹ + ç°åº¦åˆ‡æ¢
4. âœ… **æ•ˆæœéªŒè¯**ï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ + æ€§èƒ½æå‡

è¿™ä¸ªé‡æ„æ¡ˆä¾‹éå¸¸é€‚åˆåœ¨é¢è¯•ä¸­å±•ç¤ºä½ çš„**æ¶æ„èƒ½åŠ›**ã€**å·¥ç¨‹åŒ–æ€ç»´**å’Œ**é£é™©æ„è¯†**ã€‚

---

**ä½œè€…**ï¼šAI Assistant  
**æ—¥æœŸ**ï¼š2025-12-27  
**ç‰ˆæœ¬**ï¼šv1.0

