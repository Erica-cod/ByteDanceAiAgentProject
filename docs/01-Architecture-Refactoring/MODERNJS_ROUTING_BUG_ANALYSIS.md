# Modern.js è·¯ç”±è§£æé—®é¢˜æ·±åº¦åˆ†æ

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨åç«¯é‡æ„è¿‡ç¨‹ä¸­ï¼Œå°è¯•å°†ç°æœ‰æ¨¡å—è¿ç§»åˆ° Clean Architectureï¼ˆ`api/_clean/` ç›®å½•ï¼‰ï¼Œå¹¶ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼Œé‡åˆ°äº†ä¸€ä¸ªä¸¥é‡é—®é¢˜ï¼š

**å³ä½¿ä½¿ç”¨äº†ä¸‹åˆ’çº¿å‰ç¼€ `_clean`ï¼ŒModern.js æ¡†æ¶ä»ç„¶å°è¯•å°†è¯¥æ–‡ä»¶å¤¹è§£æä¸º BFF è·¯ç”±ã€‚**

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

### 1. Modern.js çš„ä¸¤å¥—è·¯ç”±ç³»ç»Ÿ

Modern.js å®é™…ä¸Šæœ‰**ä¸¤å¥—ç‹¬ç«‹çš„è·¯ç”±è§£æç³»ç»Ÿ**ï¼š

#### ç³»ç»Ÿ Aï¼šå‰ç«¯è·¯ç”±ï¼ˆsrc/routes/ï¼‰
- **æ‰«æç›®å½•**ï¼š`src/routes/`
- **æ–‡ä»¶ç±»å‹**ï¼š`layout.[tj]sx`ã€`page.[tj]sx`
- **å¿½ç•¥è§„åˆ™**ï¼š
  - âœ… ä»¥ `_` å¼€å¤´çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
  - âœ… æµ‹è¯•æ–‡ä»¶ `*.test.ts`
  - âœ… ç±»å‹å£°æ˜æ–‡ä»¶ `*.d.ts`
  - âœ… `node_modules`

#### ç³»ç»Ÿ Bï¼šBFF åç«¯è·¯ç”±ï¼ˆapi/lambda/ï¼‰
- **æ‰«æç›®å½•**ï¼š`api/lambda/`ï¼ˆæˆ–é…ç½®çš„ BFF ç›®å½•ï¼‰
- **æ–‡ä»¶ç±»å‹**ï¼šæ‰€æœ‰ `.ts`ã€`.js` æ–‡ä»¶
- **å¿½ç•¥è§„åˆ™**ï¼š
  - âœ… ä»¥ `_` å¼€å¤´çš„æ–‡ä»¶ï¼ˆå¦‚ `_utils.ts`ï¼‰
  - âœ… ä»¥ `_` å¼€å¤´çš„æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼ˆå¦‚ `_utils/index.ts`ï¼‰
  - âœ… æµ‹è¯•æ–‡ä»¶
  - âœ… ç±»å‹å£°æ˜æ–‡ä»¶
  - âœ… `node_modules`

### 2. å…³é”®é—®é¢˜ï¼šBFF æ‰«æèŒƒå›´è¿‡å¤§

**é—®é¢˜æ ¸å¿ƒ**ï¼šModern.js çš„ `bffPlugin` ä¼šæ‰«æ**æ•´ä¸ª `api/` ç›®å½•**ï¼Œè€Œä¸ä»…ä»…æ˜¯ `api/lambda/`ï¼

```typescript
// modern.config.ts
export default defineConfig({
  plugins: [
    appTools(),
    bffPlugin(), // âš ï¸ è¿™ä¸ªæ’ä»¶ä¼šæ‰«ææ•´ä¸ª api/ ç›®å½•ï¼
  ],
  bff: {
    prefix: '/api', // è¿™åªæ˜¯è®¾ç½® URL å‰ç¼€ï¼Œä¸é™åˆ¶æ‰«æèŒƒå›´
  },
});
```

### 3. ä¸‹åˆ’çº¿è§„åˆ™çš„å±€é™æ€§

è™½ç„¶ Modern.js æ–‡æ¡£è¯´æ˜äº†ä¸‹åˆ’çº¿å‰ç¼€ä¼šè¢«å¿½ç•¥ï¼Œä½†è¿™ä¸ªè§„åˆ™æœ‰**é‡è¦çš„é™åˆ¶**ï¼š

```
api/
â”œâ”€â”€ lambda/              âœ… BFF è·¯ç”±ç›®å½•
â”‚   â”œâ”€â”€ chat.ts         âœ… ä¼šè¢«è§£æä¸º /api/chat
â”‚   â”œâ”€â”€ _utils/         âœ… ä¼šè¢«å¿½ç•¥ï¼ˆä¸‹åˆ’çº¿è§„åˆ™ç”Ÿæ•ˆï¼‰
â”‚   â”‚   â””â”€â”€ cors.ts
â”‚   â””â”€â”€ user.ts         âœ… ä¼šè¢«è§£æä¸º /api/user
â”‚
â”œâ”€â”€ _clean/             âŒ ç†è®ºä¸Šåº”è¯¥è¢«å¿½ç•¥ï¼Œä½†å®é™…ä¸Š...
â”‚   â”œâ”€â”€ domain/         âš ï¸ åŒ…å« .ts æ–‡ä»¶
â”‚   â”œâ”€â”€ application/    âš ï¸ åŒ…å« .ts æ–‡ä»¶
â”‚   â””â”€â”€ infrastructure/ âš ï¸ åŒ…å« .ts æ–‡ä»¶
```

## ğŸ› Bug çš„æŠ€æœ¯ç»†èŠ‚

### é—®é¢˜ 1ï¼šBFF æ’ä»¶çš„æ‰«æé€»è¾‘

Modern.js çš„ `bffPlugin` åœ¨æ‰«ææ—¶ï¼š

1. **é¦–å…ˆ**ï¼šæ‰«ææ•´ä¸ª `api/` ç›®å½•
2. **ç„¶å**ï¼šå¯¹æ¯ä¸ªæ–‡ä»¶åº”ç”¨å¿½ç•¥è§„åˆ™
3. **ä½†æ˜¯**ï¼šåœ¨åº”ç”¨å¿½ç•¥è§„åˆ™ä¹‹å‰ï¼Œå¯èƒ½å·²ç»å°è¯•è§£æäº†æ–‡ä»¶

### é—®é¢˜ 2ï¼šTypeScript æ¨¡å—è§£æå†²çª

å½“ `bffPlugin` æ‰«æåˆ° `api/_clean/` æ—¶ï¼š

```typescript
// api/_clean/infrastructure/repositories/user.repository.ts
import { Repository } from '../../shared/decorators/index.js';

@Repository() // âš ï¸ è£…é¥°å™¨ï¼
export class MongoUserRepository implements IUserRepository {
  // ...
}
```

**å†²çªç‚¹**ï¼š
- BFF æ’ä»¶å°è¯•å°†è¿™ä¸ªæ–‡ä»¶å½“ä½œ API è·¯ç”±å¤„ç†
- æ–‡ä»¶ä¸­ä½¿ç”¨äº†è£…é¥°å™¨å’Œå¤æ‚çš„ä¾èµ–æ³¨å…¥
- è£…é¥°å™¨éœ€è¦ `reflect-metadata` å’Œç‰¹å®šçš„ TypeScript é…ç½®
- BFF æ’ä»¶çš„ç¼–è¯‘ç¯å¢ƒå¯èƒ½ä¸æ”¯æŒè¿™äº›ç‰¹æ€§

### é—®é¢˜ 3ï¼šESM æ¨¡å—ç³»ç»Ÿçš„å¤æ‚æ€§

```typescript
// api/_clean/ ä½¿ç”¨ ESM æ¨¡å—
import { Service, Inject } from '../../../shared/decorators/index.js';

// api/lambda/ ä¹Ÿä½¿ç”¨ ESM æ¨¡å—
import { getContainer } from '../_clean/di-container.js';
```

**é—®é¢˜**ï¼š
- Modern.js åœ¨æ‰«æé˜¶æ®µä¼šå°è¯•é™æ€åˆ†ææ‰€æœ‰ `.ts` æ–‡ä»¶
- å³ä½¿æ–‡ä»¶åœ¨ `_clean/` ä¸‹ï¼Œå¦‚æœè¢«å…¶ä»–æ–‡ä»¶ importï¼Œä»å¯èƒ½è¢«æ‰«æ
- è£…é¥°å™¨å…ƒæ•°æ®åœ¨æ‰«æé˜¶æ®µå¯èƒ½å¯¼è‡´è§£æé”™è¯¯

## ğŸ“Š å®é™…è¡¨ç°

### ä½ é‡åˆ°çš„é—®é¢˜

```bash
# å¯åŠ¨ Modern.js é¡¹ç›®æ—¶
npm run dev

# é”™è¯¯ä¿¡æ¯ï¼ˆæ¨æµ‹ï¼‰
Error: Cannot resolve module '../../shared/decorators/index.js'
æˆ–
Error: Decorators are not valid here
æˆ–
Error: reflect-metadata is not defined
æˆ–
TypeError: Cannot read property 'getMetadata' of undefined
```

### ä¸ºä»€ä¹ˆä¸‹åˆ’çº¿å‰ç¼€æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

**åŸå› åˆ†æ**ï¼š

1. **æ–‡æ¡£ä¸å®Œæ•´**ï¼šModern.js æ–‡æ¡£ä¸»è¦è¯´æ˜äº† `api/lambda/_utils/` çš„æƒ…å†µï¼Œä½†æ²¡æœ‰æ˜ç¡®è¯´æ˜ `api/_clean/` è¿™ç§é¡¶çº§ç›®å½•çš„å¤„ç†

2. **æ‰«ææ—¶æœºé—®é¢˜**ï¼š
   ```
   æ‰«ææµç¨‹ï¼š
   1. bffPlugin å¯åŠ¨
   2. æ‰«æ api/ ç›®å½• â† è¿™é‡Œå°±å¼€å§‹äº†
   3. å‘ç° api/_clean/
   4. æ£€æŸ¥æ˜¯å¦ä»¥ _ å¼€å¤´ â† åº”è¯¥åœ¨è¿™é‡Œå¿½ç•¥
   5. ä½†æ˜¯... å·²ç»å°è¯•è¯»å–äº†æ–‡ä»¶å†…å®¹
   6. é‡åˆ°è£…é¥°å™¨è¯­æ³• â†’ æŠ¥é”™
   ```

3. **ä¾èµ–å…³ç³»è¿½è¸ª**ï¼š
   ```typescript
   // api/lambda/chat.ts
   import { getContainer } from '../_clean/di-container.js';
   //                           â†‘ 
   //                           è¿™ä¸ª import å¯¼è‡´ BFF æ’ä»¶è¿½è¸ªåˆ° _clean/
   ```

## ğŸ”§ ä¸ºä»€ä¹ˆç°åœ¨èƒ½å·¥ä½œäº†ï¼Ÿ

### å½“å‰çš„è§£å†³æ–¹æ¡ˆ

ä½ ç°åœ¨çš„é¡¹ç›®ç»“æ„ï¼š

```
api/
â”œâ”€â”€ _clean/              â† Clean Architecture ä»£ç 
â”‚   â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ shared/
â”‚       â””â”€â”€ decorators/  â† è£…é¥°å™¨ç³»ç»Ÿ
â”‚
â”œâ”€â”€ lambda/              â† BFF API è·¯ç”±
â”‚   â”œâ”€â”€ chat.ts
â”‚   â””â”€â”€ user.ts
â”‚
â””â”€â”€ handlers/            â† ä¸šåŠ¡å¤„ç†å™¨
    â””â”€â”€ singleAgentHandler.ts
```

**èƒ½å·¥ä½œçš„åŸå› **ï¼š

1. **è£…é¥°å™¨ä¿®å¤**ï¼š
   - ä»å‚æ•°è£…é¥°å™¨æ”¹ä¸ºç±»è£…é¥°å™¨
   - æé«˜äº†å…¼å®¹æ€§
   - å‡å°‘äº†å¯¹ `emitDecoratorMetadata` çš„ä¾èµ–

2. **TypeScript é…ç½®**ï¼š
   ```json
   // api/tsconfig.json
   {
     "compilerOptions": {
       "experimentalDecorators": true,
       "emitDecoratorMetadata": true
     }
   }
   ```

3. **Modern.js ç‰ˆæœ¬**ï¼š
   - å¯èƒ½ä½ ä½¿ç”¨çš„ Modern.js ç‰ˆæœ¬å·²ç»ä¿®å¤äº†éƒ¨åˆ†æ‰«æé—®é¢˜
   - æˆ–è€…ä¸‹åˆ’çº¿è§„åˆ™åœ¨æ–°ç‰ˆæœ¬ä¸­æ›´ä¸¥æ ¼

4. **å»¶è¿Ÿåˆå§‹åŒ–**ï¼š
   ```typescript
   // api/_clean/di-container.ts æ³¨é‡Šè¯´æ˜
   /**
    * âš ï¸ é‡è¦ï¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å… Modern.js BFF æ‰«æé—®é¢˜
    */
   ```

## ğŸ¯ æ ¹æœ¬åŸå› æ€»ç»“

### Modern.js BFF æ’ä»¶çš„è®¾è®¡ç¼ºé™·

1. **æ‰«æèŒƒå›´ä¸å¯é…ç½®**ï¼š
   - æ— æ³•æ˜ç¡®æŒ‡å®šåªæ‰«æ `api/lambda/`
   - `bff.prefix` åªå½±å“ URLï¼Œä¸å½±å“æ‰«æ

2. **ä¸‹åˆ’çº¿è§„åˆ™ä¸å¤Ÿå¼º**ï¼š
   - ç†è®ºä¸Š `_` å¼€å¤´çš„æ–‡ä»¶å¤¹åº”è¯¥å®Œå…¨å¿½ç•¥
   - å®é™…ä¸Šåœ¨ä¾èµ–è¿½è¸ªæ—¶ä»å¯èƒ½è¢«æ‰«æ

3. **é™æ€åˆ†æè¿‡äºæ¿€è¿›**ï¼š
   - åœ¨æ‰«æé˜¶æ®µå°±å°è¯•è§£æ TypeScript è¯­æ³•
   - å¯¹è£…é¥°å™¨ç­‰é«˜çº§ç‰¹æ€§æ”¯æŒä¸è¶³

4. **æ–‡æ¡£ä¸æ¸…æ™°**ï¼š
   - æ²¡æœ‰æ˜ç¡®è¯´æ˜ BFF æ’ä»¶çš„æ‰«æè¾¹ç•Œ
   - æ²¡æœ‰è¯´æ˜å¦‚ä½•å®Œå…¨æ’é™¤æŸäº›ç›®å½•

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### æ–¹æ¡ˆ 1ï¼šç‰©ç†éš”ç¦»ï¼ˆæ¨èï¼‰

```
project/
â”œâ”€â”€ api/                 â† åªæ”¾ BFF è·¯ç”±
â”‚   â””â”€â”€ lambda/
â”‚       â”œâ”€â”€ chat.ts
â”‚       â””â”€â”€ user.ts
â”‚
â””â”€â”€ backend/             â† Clean Architectureï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
    â”œâ”€â”€ domain/
    â”œâ”€â”€ application/
    â””â”€â”€ infrastructure/
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ .modernrc é…ç½®ï¼ˆå¦‚æœæ”¯æŒï¼‰

```json
{
  "bff": {
    "include": ["api/lambda/**/*"],
    "exclude": ["api/_clean/**/*"]
  }
}
```

### æ–¹æ¡ˆ 3ï¼šMonorepo ç»“æ„

```
packages/
â”œâ”€â”€ web-app/             â† Modern.js åº”ç”¨
â”‚   â””â”€â”€ api/lambda/
â”‚
â””â”€â”€ backend-core/        â† ç‹¬ç«‹çš„åç«¯åŒ…
    â”œâ”€â”€ domain/
    â”œâ”€â”€ application/
    â””â”€â”€ infrastructure/
```

### æ–¹æ¡ˆ 4ï¼šå½“å‰æ–¹æ¡ˆï¼ˆä½ æ­£åœ¨ä½¿ç”¨ï¼‰

```
api/
â”œâ”€â”€ _clean/              â† ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€
â”‚   â””â”€â”€ ...
â””â”€â”€ lambda/              â† BFF è·¯ç”±
    â””â”€â”€ ...
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•ï¼Œä¸éœ€è¦å¤§è§„æ¨¡é‡æ„
- âœ… æ‰€æœ‰ä»£ç åœ¨ä¸€ä¸ªç›®å½•ä¸‹

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¾èµ– Modern.js çš„ä¸‹åˆ’çº¿è§„åˆ™
- âš ï¸ å¯èƒ½åœ¨æŸäº›ç‰ˆæœ¬æˆ–é…ç½®ä¸‹å¤±æ•ˆ
- âš ï¸ éœ€è¦å°å¿ƒå¤„ç† import è·¯å¾„

## ğŸ” å¦‚ä½•éªŒè¯é—®é¢˜

### æµ‹è¯• 1ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶

```typescript
// api/_test_scan/test.ts
export function testFunction() {
  return 'This should not be scanned';
}
```

å¯åŠ¨é¡¹ç›®ï¼Œçœ‹æ˜¯å¦æŠ¥é”™æˆ–è¢«è§£æä¸ºè·¯ç”±ã€‚

### æµ‹è¯• 2ï¼šæ£€æŸ¥ Modern.js æ„å»ºè¾“å‡º

```bash
npm run build -- --verbose
```

æŸ¥çœ‹æ„å»ºæ—¥å¿—ä¸­æ˜¯å¦æ‰«æäº† `_clean/` ç›®å½•ã€‚

### æµ‹è¯• 3ï¼šä½¿ç”¨ Modern.js è°ƒè¯•æ¨¡å¼

```bash
DEBUG=modern:bff npm run dev
```

æŸ¥çœ‹ BFF æ’ä»¶çš„æ‰«ææ—¥å¿—ã€‚

## ğŸ“š ç›¸å…³èµ„æº

### Modern.js å®˜æ–¹æ–‡æ¡£

- [BFF å‡½æ•°çº¦å®š](https://modernjs.dev/zh/guides/advanced-features/bff/function)
- [è·¯ç”±çº¦å®š](https://modernjs.dev/zh/apis/app/hooks/src/routes.html)

### ç›¸å…³ Issueï¼ˆå¯èƒ½å­˜åœ¨ï¼‰

- Modern.js GitHub Issues ä¸­æœç´¢ "BFF scan" "underscore" "_clean"
- å¯èƒ½æœ‰å…¶ä»–å¼€å‘è€…é‡åˆ°ç±»ä¼¼é—®é¢˜

## ğŸ“ ç»éªŒæ•™è®­

### 1. æ¡†æ¶çº¦å®šçš„éšè—è§„åˆ™

- æ–‡æ¡£å¯èƒ½ä¸å®Œæ•´
- éœ€è¦é€šè¿‡å®è·µå‘ç°è¾¹ç•Œæƒ…å†µ
- æºç æ˜¯æœ€å‡†ç¡®çš„æ–‡æ¡£

### 2. æ–‡ä»¶ç³»ç»Ÿçº¦å®šçš„å±€é™æ€§

- åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„çº¦å®šå¾ˆæ–¹ä¾¿
- ä½†åœ¨å¤æ‚é¡¹ç›®ä¸­å¯èƒ½ä¸å¤Ÿçµæ´»
- éœ€è¦æ˜ç¡®çš„é…ç½®é€‰é¡¹

### 3. è£…é¥°å™¨çš„å…¼å®¹æ€§

- å‚æ•°è£…é¥°å™¨å…¼å®¹æ€§è¾ƒå·®
- ç±»è£…é¥°å™¨æ›´ç¨³å®š
- éœ€è¦æ­£ç¡®çš„ TypeScript é…ç½®

## âœ… ç»“è®º

**Modern.js çš„ BFF æ’ä»¶ç¡®å®å­˜åœ¨æ‰«æèŒƒå›´è¿‡å¤§çš„é—®é¢˜**ï¼š

1. **è®¾è®¡é—®é¢˜**ï¼šæ— æ³•ç²¾ç¡®æ§åˆ¶æ‰«æèŒƒå›´
2. **æ–‡æ¡£é—®é¢˜**ï¼šä¸‹åˆ’çº¿è§„åˆ™çš„è¾¹ç•Œä¸æ¸…æ™°
3. **å®ç°é—®é¢˜**ï¼šä¾èµ–è¿½è¸ªå¯èƒ½ç»•è¿‡å¿½ç•¥è§„åˆ™

**ä½ çš„è§£å†³æ–¹æ¡ˆæ˜¯åˆç†çš„**ï¼š

- âœ… ä½¿ç”¨ `_clean/` å‰ç¼€
- âœ… æ”¹ç”¨ç±»è£…é¥°å™¨æé«˜å…¼å®¹æ€§
- âœ… é…ç½®æ­£ç¡®çš„ TypeScript é€‰é¡¹
- âœ… å»¶è¿Ÿåˆå§‹åŒ–é¿å…æ‰«ææ—¶æ‰§è¡Œ

**æœªæ¥å»ºè®®**ï¼š

- è€ƒè™‘å‘ Modern.js å›¢é˜Ÿæ Issue
- æˆ–è€…åœ¨é¡¹ç›®ç¨³å®šåè¿ç§»åˆ°ç‰©ç†éš”ç¦»çš„ç»“æ„
- æŒç»­å…³æ³¨ Modern.js çš„æ›´æ–°å’Œæ”¹è¿›

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-01-02  
**é—®é¢˜çŠ¶æ€**ï¼šå·²é€šè¿‡ workaround è§£å†³  
**æ˜¯å¦éœ€è¦ä¸ŠæŠ¥**ï¼šå»ºè®®å‘ Modern.js å›¢é˜Ÿåé¦ˆ

