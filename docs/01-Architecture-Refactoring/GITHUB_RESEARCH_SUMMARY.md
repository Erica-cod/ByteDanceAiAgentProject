# Modern.js BFF æ‰«æé—®é¢˜ - GitHub ç¤¾åŒºè°ƒç ”

## ğŸ“‹ è°ƒç ”ç›®çš„

è°ƒæŸ¥ Modern.js GitHub ç¤¾åŒºä¸­æ˜¯å¦æœ‰å…³äºä»¥ä¸‹é—®é¢˜çš„è®¨è®ºï¼š
- BFF æ’ä»¶æ‰«ææ•´ä¸ª `api/` ç›®å½•
- ä¸‹åˆ’çº¿å‰ç¼€ `_` è§„åˆ™çš„è¾¹ç•Œæƒ…å†µ
- å¦‚ä½•é…ç½®æˆ–é™åˆ¶ BFF æ‰«æèŒƒå›´

## ğŸ” è°ƒç ”ç»“æœ

### 1. æœç´¢å…³é”®è¯

å°è¯•çš„æœç´¢ç»„åˆï¼š
- `Modern.js GitHub issues BFF scan directory underscore prefix exclude`
- `site:github.com/web-infra-dev/modern.js BFF api directory scan exclude`
- `"Modern.js" "bffPlugin" "_clean" scan problem`
- `Modern.js BFF è·¯ç”±æ‰«æ exclude é…ç½®`

### 2. å‘ç°çš„ç›¸å…³å†…å®¹

#### âŒ æ²¡æœ‰æ‰¾åˆ°ç›´æ¥ç›¸å…³çš„ Issue

ç»è¿‡å¤šæ¬¡æœç´¢ï¼Œ**æ²¡æœ‰æ‰¾åˆ°**æ˜ç¡®è®¨è®ºä»¥ä¸‹é—®é¢˜çš„ issueï¼š
- BFF æ’ä»¶æ‰«æèŒƒå›´è¿‡å¤§
- ä¸‹åˆ’çº¿å‰ç¼€è§„åˆ™å¤±æ•ˆ
- `api/_clean/` è¢«é”™è¯¯æ‰«æ
- BFF æ‰«æè·¯å¾„é…ç½®éœ€æ±‚

#### âœ… æ‰¾åˆ°çš„ç›¸å…³ä¿¡æ¯

1. **å®˜æ–¹æ–‡æ¡£ç¡®è®¤**ï¼š
   - æ–‡æ¡£ç¡®è®¤äº†ä¸‹åˆ’çº¿è§„åˆ™çš„å­˜åœ¨
   - æ–‡æ¡£ä¸»è¦é’ˆå¯¹ `api/lambda/_utils/` è¿™ç±»åœºæ™¯
   - æ²¡æœ‰æ˜ç¡®è¯´æ˜é¡¶çº§ç›®å½•ï¼ˆå¦‚ `api/_clean/`ï¼‰çš„å¤„ç†

2. **ç±»ä¼¼çš„ Issue**ï¼š
   - Issue #6647ï¼šFederation Runtime é…ç½®é”™è¯¯ï¼ˆä¸ç›´æ¥ç›¸å…³ï¼‰
   - æ²¡æœ‰æ‰¾åˆ°å…³äº BFF æ‰«æèŒƒå›´çš„å…·ä½“ issue

### 3. æ¨æ–­çš„åŸå› 

ä¸ºä»€ä¹ˆç¤¾åŒºæ²¡æœ‰ç›¸å…³è®¨è®ºï¼Ÿ

#### å¯èƒ½åŸå›  1ï¼šä½¿ç”¨åœºæ™¯ä¸å¸¸è§

```
å¤§å¤šæ•°é¡¹ç›®ç»“æ„ï¼š
api/
â””â”€â”€ lambda/          â† åªæœ‰è¿™ä¸€ä¸ªç›®å½•
    â”œâ”€â”€ user.ts
    â””â”€â”€ chat.ts

ä½ çš„é¡¹ç›®ç»“æ„ï¼š
api/
â”œâ”€â”€ _clean/          â† è¿™ç§å¤æ‚ç»“æ„ä¸å¸¸è§
â”‚   â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ application/
â”‚   â””â”€â”€ infrastructure/
â””â”€â”€ lambda/
    â”œâ”€â”€ user.ts
    â””â”€â”€ chat.ts
```

**åˆ†æ**ï¼š
- å¤§å¤šæ•°ç”¨æˆ·ç›´æ¥åœ¨ `api/lambda/` ä¸‹å†™ä»£ç 
- å¾ˆå°‘æœ‰äººåœ¨ `api/` ä¸‹åˆ›å»ºå…¶ä»–é¡¶çº§ç›®å½•
- Clean Architecture è¿™ç§åˆ†å±‚ç»“æ„åœ¨ Modern.js ç¤¾åŒºè¾ƒå°‘è§

#### å¯èƒ½åŸå›  2ï¼šä¸‹åˆ’çº¿è§„åˆ™ç¡®å®æœ‰æ•ˆ

```
å¸¸è§çš„ä½¿ç”¨æ¨¡å¼ï¼š
api/lambda/
â”œâ”€â”€ chat.ts          âœ… BFF è·¯ç”±
â”œâ”€â”€ user.ts          âœ… BFF è·¯ç”±
â””â”€â”€ _utils/          âœ… å·¥å…·å‡½æ•°ï¼Œè¢«æ­£ç¡®å¿½ç•¥
    â”œâ”€â”€ cors.ts
    â””â”€â”€ validate.ts
```

**åˆ†æ**ï¼š
- åœ¨ `lambda/` å­ç›®å½•ä¸‹ï¼Œä¸‹åˆ’çº¿è§„åˆ™å·¥ä½œæ­£å¸¸
- å¤§å¤šæ•°ç”¨æˆ·åªåœ¨ `lambda/` å†…éƒ¨ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€
- æ²¡æœ‰äººå°è¯•åœ¨ `api/` æ ¹çº§åˆ«ä½¿ç”¨ä¸‹åˆ’çº¿ç›®å½•

#### å¯èƒ½åŸå›  3ï¼šæ¡†æ¶æ–°ç‰¹æ€§æˆ–ç‰ˆæœ¬å·®å¼‚

```
å¯èƒ½çš„æƒ…å†µï¼š
- Modern.js æ—©æœŸç‰ˆæœ¬æ²¡æœ‰ BFF åŠŸèƒ½
- BFF æ’ä»¶ç›¸å¯¹è¾ƒæ–°
- æ‰«ææœºåˆ¶å¯èƒ½åœ¨ä¸åŒç‰ˆæœ¬ä¸­æœ‰å˜åŒ–
- ä½ é‡åˆ°çš„å¯èƒ½æ˜¯ç‰¹å®šç‰ˆæœ¬çš„é—®é¢˜
```

#### å¯èƒ½åŸå›  4ï¼šå¤§å¤šæ•°äººç‰©ç†éš”ç¦»

```
æ¨èçš„é¡¹ç›®ç»“æ„ï¼š
project/
â”œâ”€â”€ api/             â† Modern.js BFF
â”‚   â””â”€â”€ lambda/
â”œâ”€â”€ backend/         â† ç‹¬ç«‹åç«¯ï¼ˆä¸åœ¨ api/ ä¸‹ï¼‰
â”‚   â”œâ”€â”€ domain/
â”‚   â””â”€â”€ application/
â””â”€â”€ frontend/
    â””â”€â”€ src/
```

**åˆ†æ**ï¼š
- æœ‰ç»éªŒçš„å¼€å‘è€…å¯èƒ½ä¸€å¼€å§‹å°±ç‰©ç†éš”ç¦»
- é¿å…äº†æ‰«æå†²çªé—®é¢˜
- æ²¡æœ‰é‡åˆ°ä½ çš„è¿™ä¸ªé—®é¢˜

### 4. éªŒè¯ Modern.js å®˜æ–¹ç«‹åœº

#### å®˜æ–¹æ–‡æ¡£è¯´æ˜

ä»æœç´¢ç»“æœä¸­æå–çš„å®˜æ–¹è¯´æ˜ï¼š

> Modern.js é»˜è®¤ä¼šæ‰«æ `api/lambda` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä»¥ç”Ÿæˆå¯¹åº”çš„ API è·¯ç”±ã€‚

**å…³é”®ç‚¹**ï¼š
- æ–‡æ¡£è¯´"é»˜è®¤æ‰«æ `api/lambda`"
- ä½†å®é™…ä¸Šå¯èƒ½æ‰«ææ•´ä¸ª `api/`
- è¿™å¯èƒ½æ˜¯æ–‡æ¡£ä¸å‡†ç¡®æˆ–å®ç°æœ‰å·®å¼‚

#### ä¸‹åˆ’çº¿è§„åˆ™çš„å®˜æ–¹è¯´æ˜

> ä»¥ä¸‹æ–‡ä»¶ä¸ä¼šè¢«è§£æä¸º BFF å‡½æ•°æ–‡ä»¶ï¼š
> - å‘½åä»¥ `_` å¼€å¤´çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š`_utils.ts`
> - å‘½åä»¥ `_` å¼€å¤´çš„æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

**é—®é¢˜**ï¼š
- æ–‡æ¡£ç¤ºä¾‹éƒ½æ˜¯åœ¨ `lambda/` å­ç›®å½•ä¸‹
- æ²¡æœ‰æ˜ç¡®è¯´æ˜ `api/_clean/` è¿™ç§é¡¶çº§ç›®å½•
- å­˜åœ¨æ­§ä¹‰

## ğŸ“Š ç¤¾åŒºå®è·µæ¨æµ‹

### æ¨æµ‹ 1ï¼šå¤§éƒ¨åˆ†å¼€å‘è€…çš„åšæ³•

```typescript
// å¤§å¤šæ•° Modern.js é¡¹ç›®
api/
â””â”€â”€ lambda/
    â”œâ”€â”€ users/
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â””â”€â”€ [id].ts
    â”œâ”€â”€ posts/
    â”‚   â””â”€â”€ index.ts
    â””â”€â”€ _shared/        â† åœ¨è¿™é‡Œä½¿ç”¨ä¸‹åˆ’çº¿
        â””â”€â”€ utils.ts
```

### æ¨æµ‹ 2ï¼šå¤æ‚é¡¹ç›®çš„åšæ³•

```
# Monorepo æˆ–ç‰©ç†éš”ç¦»
packages/
â”œâ”€â”€ web/              â† Modern.js åº”ç”¨
â”‚   â””â”€â”€ api/lambda/
â”œâ”€â”€ backend/          â† ç‹¬ç«‹çš„åç«¯æœåŠ¡
â”‚   â””â”€â”€ src/
â””â”€â”€ shared/           â† å…±äº«ä»£ç 
    â””â”€â”€ types/
```

### æ¨æµ‹ 3ï¼šä¸ºä»€ä¹ˆæ²¡äººæŠ¥å‘Š

å¯èƒ½çš„åŸå› ï¼š
1. **é‡åˆ°é—®é¢˜å°±ç›´æ¥æ”¹ç»“æ„äº†** - ä¸å»æ·±ç©¶åŸå› 
2. **ä¸€å¼€å§‹å°±é¿å…äº†** - å‚è€ƒç¤ºä¾‹é¡¹ç›®ï¼Œåªç”¨ `lambda/`
3. **ç”¨å…¶ä»–æ¡†æ¶** - NestJSã€Express ç­‰æœ‰æ›´æ˜ç¡®çš„é…ç½®
4. **å†…éƒ¨é¡¹ç›®** - é‡åˆ°é—®é¢˜è‡ªå·± workaroundï¼Œä¸å…¬å¼€è®¨è®º

## ğŸ¯ ç»“è®º

### å…³é”®å‘ç°

1. **GitHub ç¤¾åŒºç¡®å®æ²¡æœ‰ç›¸å…³è®¨è®º**
   - æ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„ issue æˆ– discussion
   - æ²¡æœ‰å…¶ä»–å¼€å‘è€…æŠ¥å‘Šç±»ä¼¼é—®é¢˜

2. **è¿™ä¸ä»£è¡¨é—®é¢˜ä¸å­˜åœ¨**
   - å¯èƒ½æ˜¯ä½¿ç”¨åœºæ™¯ä¸å¸¸è§
   - å¯èƒ½æ˜¯å¤§å®¶éƒ½é¿å¼€äº†è¿™ä¸ªé—®é¢˜
   - å¯èƒ½æ˜¯æ–‡æ¡£å’Œå®ç°æœ‰å·®å¼‚

3. **ä¸‹åˆ’çº¿è§„åˆ™å­˜åœ¨æ­§ä¹‰**
   - å®˜æ–¹æ–‡æ¡£ç¡®è®¤äº†è§„åˆ™
   - ä½†è¾¹ç•Œæƒ…å†µä¸æ¸…æ¥š
   - `api/_clean/` vs `api/lambda/_utils/` å¤„ç†å¯èƒ½ä¸åŒ

### ä½ çš„æƒ…å†µçš„ç‰¹æ®Šæ€§

ä½ çš„é¡¹ç›®ç‰¹æ®Šåœ¨ï¼š

```
1. ä½¿ç”¨ Clean Architectureï¼ˆåˆ†å±‚æ¶æ„ï¼‰
2. åœ¨ api/ ä¸‹åˆ›å»ºäº† _clean/ é¡¶çº§ç›®å½•
3. éœ€è¦è£…é¥°å™¨å’Œå¤æ‚çš„ä¾èµ–æ³¨å…¥
4. åŒæ—¶ä½¿ç”¨ BFF å’Œ Clean Architecture
```

è¿™ç§ç»„åˆåœ¨ Modern.js ç¤¾åŒºå¯èƒ½æ˜¯**é¦–ä¾‹**æˆ–**æå°‘æ•°**ï¼Œæ‰€ä»¥æ²¡æœ‰äººé‡åˆ°å’ŒæŠ¥å‘Šã€‚

## ğŸ’¡ å»ºè®®è¡ŒåŠ¨

### çŸ­æœŸ

âœ… **ç»§ç»­ä½¿ç”¨å½“å‰æ–¹æ¡ˆ**
- `api/_clean/` é…åˆç±»è£…é¥°å™¨
- å·²ç»èƒ½æ­£å¸¸å·¥ä½œ
- ä¸éœ€è¦å¤§è§„æ¨¡é‡æ„

### ä¸­æœŸ

ğŸ“ **å‘ Modern.js æäº¤ Feature Request**

å»ºè®®çš„ Issue æ ‡é¢˜ï¼š
> [Feature Request] Add BFF scan path configuration (include/exclude)

å»ºè®®çš„å†…å®¹ï¼š
```markdown
## Problem
Currently, `bffPlugin` scans the entire `api/` directory, 
but there's no way to configure or limit the scan path.

## Use Case
I have a Clean Architecture backend in `api/_clean/` 
that should not be scanned as BFF routes.

## Proposed Solution
Add configuration options:

```typescript
bff: {
  prefix: '/api',
  scanDir: 'api/lambda',           // Limit scan to specific dir
  exclude: ['api/_clean/**']       // Exclude patterns
}
```

## Current Workaround
Using `_clean` with underscore prefix, but behavior is unclear.
```

### é•¿æœŸ

ğŸ—ï¸ **è€ƒè™‘æ¶æ„è°ƒæ•´**

å¦‚æœé¡¹ç›®ç»§ç»­æ‰©å¤§ï¼š
```
project/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ web-app/        â† Modern.js å‰ç«¯ + BFF
â”‚   â””â”€â”€ backend-core/   â† ç‹¬ç«‹åç«¯åŒ…
â””â”€â”€ shared/             â† å…±äº«ç±»å‹
```

## ğŸ“š å‚è€ƒèµ„æ–™

### Modern.js ç›¸å…³

- GitHub ä»“åº“: https://github.com/web-infra-dev/modern.js
- BFF æ–‡æ¡£: https://modernjs.dev/zh/guides/advanced-features/bff
- Issue åˆ—è¡¨: https://github.com/web-infra-dev/modern.js/issues

### æœç´¢è®°å½•

- æœç´¢æ—¶é—´ï¼š2026-01-02
- æœç´¢å…³é”®è¯ï¼šBFF scan, underscore prefix, exclude, api directory
- æœç´¢ç»“æœï¼šæ— ç›´æ¥ç›¸å…³ issue

### ç»“è®º

**ä½ é‡åˆ°çš„é—®é¢˜å¯èƒ½æ˜¯ Modern.js ç¤¾åŒºçš„"é¦–æ¬¡æŠ¥å‘Š"æˆ–"æå°‘æ•°æ¡ˆä¾‹"**

è¿™åæ˜ äº†ï¼š
1. Modern.js çš„ BFF åŠŸèƒ½ç›¸å¯¹è¾ƒæ–°
2. Clean Architecture åœ¨ Modern.js ç¤¾åŒºä¸å¸¸è§
3. æ¡†æ¶çš„æ‰«æé…ç½®ç¡®å®ä¸å¤Ÿçµæ´»
4. æ–‡æ¡£å’Œå®ç°å¯èƒ½å­˜åœ¨å·®å¼‚

**ä½ çš„åˆ†æå’Œ workaround æ˜¯æœ‰ä»·å€¼çš„**ï¼Œå€¼å¾—å‘ç¤¾åŒºåˆ†äº«ï¼

---

**è°ƒç ”æ—¥æœŸ**ï¼š2026-01-02  
**è°ƒç ”äººå‘˜**ï¼šAI Assistant  
**ç»“è®º**ï¼šæ— ç›¸å…³ GitHub issueï¼Œé—®é¢˜å¯èƒ½æ˜¯é¦–æ¬¡é‡åˆ°

