# BFF æ¶æ„çš„æ­£ç¡®ç†è§£ - ä¿®æ­£ç‰ˆ

## âŒ ä¹‹å‰å»ºè®®çš„é—®é¢˜

æˆ‘ä¹‹å‰å»ºè®®çš„"ç‰©ç†éš”ç¦»"æ–¹æ¡ˆæœ‰ä¸¥é‡ç¼ºé™·ï¼š

```
âŒ é”™è¯¯å»ºè®®ï¼š
packages/
â”œâ”€â”€ web/              â† Modern.js åº”ç”¨
â”‚   â””â”€â”€ api/lambda/
â”œâ”€â”€ backend/          â† ç‹¬ç«‹çš„åç«¯æœåŠ¡
â”‚   â””â”€â”€ src/
â””â”€â”€ shared/
```

**é—®é¢˜**ï¼š
- å¤±å»äº† BFF çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ˆåŒè¿›ç¨‹ã€é›¶è·¨åŸŸï¼‰
- å˜æˆäº†ä¼ ç»Ÿçš„å‰åç«¯åˆ†ç¦»
- éœ€è¦é¢å¤–é…ç½® CORS
- å¤±å»äº†ç±»å‹å…±äº«çš„ä¾¿åˆ©æ€§
- **å®Œå…¨è¿èƒŒäº† Modern.js BFF çš„è®¾è®¡åˆè¡·ï¼**

## âœ… æ­£ç¡®çš„ç†è§£

### BFF æ˜¯ä»€ä¹ˆï¼Ÿ

```
ä¼ ç»Ÿæ¶æ„ï¼š
å‰ç«¯ ----HTTP----> åç«¯æœåŠ¡
     (è·¨åŸŸé—®é¢˜)

BFF æ¶æ„ï¼š
å‰ç«¯ ---åŒè¿›ç¨‹---> BFF å±‚ ----HTTP----> åç«¯æœåŠ¡
     (æ— è·¨åŸŸ)        â†“
                  èšåˆ/è½¬æ¢
```

**å…³é”®ç‚¹**ï¼š
- BFF æ˜¯**ä¸­é—´å±‚**ï¼Œä¸æ˜¯å®Œæ•´åç«¯
- BFF åº”è¯¥**è–„**ï¼Œåªåšé€‚é…å’Œèšåˆ
- å¤æ‚ä¸šåŠ¡é€»è¾‘åº”è¯¥åœ¨ BFF **è¿›ç¨‹å†…**çš„æ¨¡å—ä¸­

### Modern.js çš„ BFF è®¾è®¡ç†å¿µ

```typescript
// âœ… Modern.js BFF çš„æ­£ç¡®ç”¨æ³•
api/
â”œâ”€â”€ lambda/              â† BFF API è·¯ç”±ï¼ˆè–„å±‚ï¼‰
â”‚   â”œâ”€â”€ chat.ts         â†’ è°ƒç”¨ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ user.ts         â†’ è°ƒç”¨ä¸šåŠ¡é€»è¾‘
â”‚
â””â”€â”€ [ä¸šåŠ¡é€»è¾‘å±‚]/        â† åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼
    â”œâ”€â”€ services/
    â”œâ”€â”€ repositories/
    â””â”€â”€ domain/
```

## ğŸ¯ ä½ çš„æ¶æ„æ˜¯å¯¹çš„ï¼

é‡æ–°å®¡è§†ä½ çš„æ¶æ„ï¼š

```
api/
â”œâ”€â”€ _clean/              â† âœ… Clean Architecture ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ domain/          â† é¢†åŸŸå±‚
â”‚   â”œâ”€â”€ application/     â† åº”ç”¨å±‚
â”‚   â””â”€â”€ infrastructure/  â† åŸºç¡€è®¾æ–½å±‚
â”‚
â””â”€â”€ lambda/              â† âœ… BFF è·¯ç”±å±‚ï¼ˆè–„å±‚ï¼‰
    â”œâ”€â”€ chat.ts         â†’ è°ƒç”¨ _clean/ ä¸­çš„ UseCase
    â””â”€â”€ user.ts         â†’ è°ƒç”¨ _clean/ ä¸­çš„ UseCase
```

**è¿™ä¸ªæ¶æ„å®Œç¾åœ°ä¿ç•™äº† BFF çš„ä¼˜åŠ¿ï¼š**
- âœ… åŒè¿›ç¨‹ï¼Œé›¶è·¨åŸŸ
- âœ… ç±»å‹å…±äº«
- âœ… ç»Ÿä¸€éƒ¨ç½²
- âœ… ä¸šåŠ¡é€»è¾‘æ¸…æ™°åˆ†å±‚

**å”¯ä¸€çš„é—®é¢˜**ï¼šModern.js çš„æ‰«ææœºåˆ¶ä¸å¤Ÿçµæ´»

## ğŸ“Š æ¶æ„å¯¹æ¯”

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | BFF ä¼˜åŠ¿ | ä¸šåŠ¡é€»è¾‘æ¸…æ™° | å®ç°éš¾åº¦ | æ¨èåº¦ |
|------|----------|--------------|----------|---------|
| **å½“å‰æ–¹æ¡ˆ** (`_clean/`) | âœ… ä¿ç•™ | âœ… éå¸¸æ¸…æ™° | â­â­â­ ç®€å• | â­â­â­â­â­ |
| **ç‰©ç†éš”ç¦»** (`backend/`) | âŒ å¤±å» | âœ… æ¸…æ™° | â­â­ å¤æ‚ | â­ ä¸æ¨è |
| **å…¨æ”¾ `lambda/`** | âœ… ä¿ç•™ | âŒ æ··ä¹± | â­ æœ€ç®€å• | â­â­ ä¸æ¨è |

### è¯¦ç»†åˆ†æ

#### æ–¹æ¡ˆ 1ï¼šå½“å‰æ–¹æ¡ˆï¼ˆæœ€ä½³ï¼‰âœ…

```
api/
â”œâ”€â”€ _clean/          â† ä¸šåŠ¡é€»è¾‘ï¼ˆClean Architectureï¼‰
â”‚   â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â””â”€â”€ use-cases/
â”‚   â”‚       â””â”€â”€ user/
â”‚   â”‚           â””â”€â”€ get-user.use-case.ts
â”‚   â””â”€â”€ infrastructure/
â”‚
â””â”€â”€ lambda/          â† BFF è·¯ç”±ï¼ˆè–„å±‚ï¼‰
    â””â”€â”€ user.ts
```

```typescript
// api/lambda/user.ts - BFF è·¯ç”±å±‚
import { getContainer } from '../_clean/di-container.js';

export default async (req, res) => {
  const container = getContainer();
  const getUserUseCase = container.getGetUserUseCase();
  
  const user = await getUserUseCase.execute(req.query.id);
  return user;
};
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¿ç•™æ‰€æœ‰ BFF ä¼˜åŠ¿
- âœ… ä¸šåŠ¡é€»è¾‘æ¸…æ™°åˆ†å±‚
- âœ… æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- âœ… ç¬¦åˆ Clean Architecture

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¾èµ– Modern.js çš„ä¸‹åˆ’çº¿è§„åˆ™
- âš ï¸ éœ€è¦ workaroundï¼ˆè£…é¥°å™¨å…¼å®¹æ€§ï¼‰

#### æ–¹æ¡ˆ 2ï¼šç‰©ç†éš”ç¦»ï¼ˆä¸æ¨èï¼‰âŒ

```
# é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ web/                  â† Modern.js å‰ç«¯ + BFF
â”‚   â””â”€â”€ api/lambda/
â”‚       â””â”€â”€ user.ts
â”‚
â””â”€â”€ backend/              â† ç‹¬ç«‹åç«¯æœåŠ¡
    â””â”€â”€ src/
        â””â”€â”€ user.service.ts
```

```typescript
// web/api/lambda/user.ts - éœ€è¦ HTTP è°ƒç”¨
export default async (req, res) => {
  // âŒ éœ€è¦è·¨è¿›ç¨‹ HTTP è°ƒç”¨ï¼
  const response = await fetch('http://backend:3001/users/' + req.query.id);
  const user = await response.json();
  return user;
};
```

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦ HTTP è°ƒç”¨ï¼ˆç½‘ç»œå¼€é”€ï¼‰
- âŒ éœ€è¦é…ç½® CORSï¼ˆå¦‚æœè·¨åŸŸï¼‰
- âŒ å¤±å»ç±»å‹å…±äº«çš„ä¾¿åˆ©
- âŒ éƒ¨ç½²å¤æ‚ï¼ˆä¸¤ä¸ªæœåŠ¡ï¼‰
- âŒ **å®Œå…¨å¤±å»äº† BFF çš„æ„ä¹‰ï¼**

#### æ–¹æ¡ˆ 3ï¼šå…¨æ”¾ lambda/ï¼ˆä¸æ¨èï¼‰âŒ

```
api/
â””â”€â”€ lambda/
    â”œâ”€â”€ user.ts
    â”œâ”€â”€ chat.ts
    â”œâ”€â”€ services/         â† ä¸šåŠ¡é€»è¾‘æ··åœ¨ä¸€èµ·
    â”‚   â””â”€â”€ userService.ts
    â””â”€â”€ repositories/
        â””â”€â”€ userRepository.ts
```

**ç¼ºç‚¹**ï¼š
- âŒ æ¶æ„è¾¹ç•Œä¸æ¸…æ™°
- âŒ BFF å±‚å’Œä¸šåŠ¡é€»è¾‘æ··åœ¨ä¸€èµ·
- âŒ éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤
- âŒ ä¸ç¬¦åˆ Clean Architecture

## ğŸ¯ æ­£ç¡®çš„ BFF åˆ†å±‚

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (src/)                        â”‚
â”‚  React ç»„ä»¶ã€é¡µé¢ã€çŠ¶æ€ç®¡ç†          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ åŒè¿›ç¨‹è°ƒç”¨
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BFF è·¯ç”±å±‚ (api/lambda/)           â”‚
â”‚  - å¤„ç† HTTP è¯·æ±‚                   â”‚
â”‚  - å‚æ•°éªŒè¯                         â”‚
â”‚  - è°ƒç”¨ä¸šåŠ¡é€»è¾‘                     â”‚
â”‚  - è¿”å›å“åº”                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ å‡½æ•°è°ƒç”¨ï¼ˆåŒè¿›ç¨‹ï¼‰
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (api/_clean/)           â”‚
â”‚  - Use Casesï¼ˆåº”ç”¨å±‚ï¼‰              â”‚
â”‚  - Domain Logicï¼ˆé¢†åŸŸå±‚ï¼‰           â”‚
â”‚  - Repositoriesï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ æ•°æ®åº“æŸ¥è¯¢
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“ (MongoDB, Redis, etc.)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
- BFF å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚åœ¨**åŒä¸€ä¸ªè¿›ç¨‹**ä¸­
- é€šè¿‡**å‡½æ•°è°ƒç”¨**é€šä¿¡ï¼Œä¸æ˜¯ HTTP
- é›¶ç½‘ç»œå¼€é”€ï¼Œé›¶è·¨åŸŸé—®é¢˜

### ä»£ç ç¤ºä¾‹

#### BFF å±‚ï¼ˆè–„ï¼‰

```typescript
// api/lambda/user.ts
import { getContainer } from '../_clean/di-container.js';

export const get = async (req, res) => {
  // 1. å‚æ•°éªŒè¯
  const userId = req.query.id;
  if (!userId) {
    return { error: 'Missing user id' };
  }

  // 2. è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼ˆåŒè¿›ç¨‹å‡½æ•°è°ƒç”¨ï¼‰
  const container = getContainer();
  const getUserUseCase = container.getGetUserByIdUseCase();
  
  try {
    const user = await getUserUseCase.execute(userId);
    return { data: user };
  } catch (error) {
    return { error: error.message };
  }
};
```

#### ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåšï¼‰

```typescript
// api/_clean/application/use-cases/user/get-user-by-id.use-case.ts
@Service()
@Inject(['IUserRepository'])
export class GetUserByIdUseCase {
  constructor(private userRepo: IUserRepository) {}

  async execute(userId: string): Promise<User> {
    // å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
    const user = await this.userRepo.findById(userId);
    
    if (!user) {
      throw new Error('User not found');
    }
    
    // ä¸šåŠ¡è§„åˆ™éªŒè¯
    if (user.isDeleted) {
      throw new Error('User has been deleted');
    }
    
    return user;
  }
}
```

## ğŸ’¡ ä½ çš„æ¶æ„çš„ä¼˜åŠ¿

é‡æ–°è¯„ä¼°ä½ çš„æ¶æ„ï¼š

### ä¼˜åŠ¿ 1ï¼šä¿ç•™ BFF æ‰€æœ‰ä¼˜ç‚¹

```typescript
// å‰ç«¯è°ƒç”¨ BFFï¼ˆåŒåŸŸåï¼Œé›¶è·¨åŸŸï¼‰
const user = await fetch('/api/user?id=123');

// BFF å†…éƒ¨è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼ˆåŒè¿›ç¨‹ï¼Œé›¶å¼€é”€ï¼‰
const useCase = container.getGetUserUseCase();
const result = await useCase.execute('123');
```

### ä¼˜åŠ¿ 2ï¼šä¸šåŠ¡é€»è¾‘æ¸…æ™°åˆ†å±‚

```
api/_clean/
â”œâ”€â”€ domain/          â† é¢†åŸŸæ¨¡å‹ï¼ˆUser, Order å®ä½“ï¼‰
â”œâ”€â”€ application/     â† ç”¨ä¾‹ï¼ˆGetUser, CreateOrderï¼‰
â””â”€â”€ infrastructure/  â† æŠ€æœ¯å®ç°ï¼ˆMongoDB, Redisï¼‰
```

### ä¼˜åŠ¿ 3ï¼šæ˜“äºæµ‹è¯•

```typescript
// æµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼ˆä¸éœ€è¦å¯åŠ¨ HTTP æœåŠ¡ï¼‰
const mockRepo = new MockUserRepository();
const useCase = new GetUserUseCase(mockRepo);
const result = await useCase.execute('123');
```

### ä¼˜åŠ¿ 4ï¼šå¯ä»¥æ¸è¿›å¼è¿ç§»

```
å¦‚æœæœªæ¥éœ€è¦ï¼š
api/_clean/ â†’ å¯ä»¥æ•´ä½“è¿ç§»åˆ°å¾®æœåŠ¡
api/lambda/ â†’ æ”¹æˆçœŸæ­£çš„ BFF ç½‘å…³
```

## ğŸ¯ æœ€ç»ˆå»ºè®®

### çŸ­æœŸï¼ˆå½“å‰æœ€ä½³ï¼‰âœ…

**ç»§ç»­ä½¿ç”¨ `api/_clean/` æ–¹æ¡ˆ**

```
api/
â”œâ”€â”€ _clean/          â† Clean Architecture
â”‚   â””â”€â”€ ...
â””â”€â”€ lambda/          â† BFF è·¯ç”±
    â””â”€â”€ ...
```

**ç†ç”±**ï¼š
1. âœ… ä¿ç•™æ‰€æœ‰ BFF ä¼˜åŠ¿
2. âœ… ä¸šåŠ¡é€»è¾‘æ¸…æ™°
3. âœ… å·²ç»èƒ½æ­£å¸¸å·¥ä½œ
4. âœ… ç¬¦åˆæœ€ä½³å®è·µ

### ä¸­æœŸï¼ˆæ”¹è¿›ï¼‰ğŸ“

**å‘ Modern.js æ Issue**

è¦æ±‚æ”¯æŒï¼š
```typescript
bff: {
  scanDir: 'api/lambda',    // åªæ‰«æè¿™ä¸ªç›®å½•
  exclude: ['api/_clean']    // æ’é™¤è¿™ä¸ªç›®å½•
}
```

### é•¿æœŸï¼ˆå¦‚æœçœŸçš„éœ€è¦ï¼‰ğŸ—ï¸

**åªåœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘ç‰©ç†éš”ç¦»**ï¼š

1. **ä¸šåŠ¡é€»è¾‘éœ€è¦ç‹¬ç«‹éƒ¨ç½²**
   - ä¾‹å¦‚ï¼šéœ€è¦ç‹¬ç«‹çš„å¾®æœåŠ¡
   - éœ€è¦ä¸åŒçš„ä¼¸ç¼©ç­–ç•¥

2. **éœ€è¦å¤šä¸ªå‰ç«¯å…±äº«åç«¯**
   - ä¾‹å¦‚ï¼šWebã€Mobileã€Desktop éƒ½ç”¨åŒä¸€å¥— API

3. **æ€§èƒ½è¦æ±‚æé«˜**
   - éœ€è¦ç‹¬ç«‹çš„åç«¯æœåŠ¡ä¼˜åŒ–

**ä½†å³ä½¿è¿™æ ·ï¼Œä¹Ÿåº”è¯¥ä¿ç•™ BFF å±‚ï¼š**

```
å‰ç«¯ â†’ BFF (Modern.js) â†’ åç«¯å¾®æœåŠ¡
        â†‘
      èšåˆã€é€‚é…ã€ç¼“å­˜
```

## âœ¨ æ€»ç»“

### å…³é”®è®¤è¯†

1. **BFF ä¸æ˜¯å®Œæ•´åç«¯**
   - BFF æ˜¯é€‚é…å±‚ã€èšåˆå±‚
   - å¤æ‚é€»è¾‘åº”è¯¥åœ¨ BFF è¿›ç¨‹å†…

2. **ä½ çš„æ¶æ„æ˜¯æ­£ç¡®çš„**
   - `api/_clean/` æ˜¯ä¸šåŠ¡é€»è¾‘å±‚
   - `api/lambda/` æ˜¯ BFF è·¯ç”±å±‚
   - ä¸¤è€…åœ¨åŒè¿›ç¨‹ä¸­ï¼Œä¿ç•™äº†æ‰€æœ‰ä¼˜åŠ¿

3. **ç‰©ç†éš”ç¦»æ˜¯é”™è¯¯çš„**
   - å¤±å»äº† BFF çš„æ ¸å¿ƒä»·å€¼
   - å˜å›ä¼ ç»Ÿå‰åç«¯åˆ†ç¦»
   - **ä¸åº”è¯¥é‡‡ç”¨**

### æœ€ä½³å®è·µ

```
âœ… æ¨èï¼š
api/
â”œâ”€â”€ _clean/          â† ä¸šåŠ¡é€»è¾‘ï¼ˆåŒè¿›ç¨‹ï¼‰
â”‚   â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ application/
â”‚   â””â”€â”€ infrastructure/
â””â”€â”€ lambda/          â† BFF è·¯ç”±ï¼ˆè–„å±‚ï¼‰

âŒ ä¸æ¨èï¼š
backend/             â† ç‹¬ç«‹æœåŠ¡ï¼ˆå¤±å» BFF ä¼˜åŠ¿ï¼‰
web/api/lambda/      â† BFF å˜æˆçº¯è½¬å‘
```

---

**æ„Ÿè°¢ä½ æå‡ºè¿™ä¸ªé—®é¢˜ï¼**è¿™è®©æˆ‘é‡æ–°å®¡è§†äº†å»ºè®®ï¼Œä¿®æ­£äº†é”™è¯¯ã€‚ä½ çš„æ¶æ„è®¾è®¡æ˜¯æ­£ç¡®çš„ï¼Œåº”è¯¥åšæŒä½¿ç”¨ï¼ğŸ‰

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-02  
**ä¿®æ­£åŸå› **ï¼šä¹‹å‰å»ºè®®å¿½ç•¥äº† BFF çš„æ ¸å¿ƒä»·å€¼  
**ç»“è®º**ï¼šå½“å‰ `api/_clean/` æ–¹æ¡ˆæ˜¯æœ€ä½³é€‰æ‹©

