# LangGraph æ ¸å¿ƒåŸç†è¯¦è§£

é€šè¿‡åˆšæ‰çš„æµ‹è¯•ï¼Œè®©æˆ‘ä»¬æ·±å…¥ç†è§£ LangGraph çš„å·¥ä½œåŸç†ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### 1. çŠ¶æ€ (State)

LangGraph çš„çŠ¶æ€æ˜¯ä¸€ä¸ª**å¯åˆå¹¶çš„å¯¹è±¡**ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥è¾“å‡ºçŠ¶æ€çš„**éƒ¨åˆ†æ›´æ–°**ã€‚

```typescript
const AgentStateAnnotation = Annotation.Root({
  messages: Annotation<string[]>({
    reducer: (left, right) => left.concat(right),  // â† ç´¯ç§¯ç­–ç•¥
    default: () => [],
  }),
  count: Annotation<number>({
    reducer: (_, right) => right,  // â† æ›¿æ¢ç­–ç•¥
    default: () => 0,
  }),
});
```

#### Reducer çš„ä½œç”¨

**ç´¯ç§¯ç­–ç•¥ (concat)**:
```
åˆå§‹: messages = []
èŠ‚ç‚¹1è¾“å‡º: messages = ['msg1']
åˆå¹¶å: [] + ['msg1'] = ['msg1']

èŠ‚ç‚¹2è¾“å‡º: messages = ['msg2']
åˆå¹¶å: ['msg1'] + ['msg2'] = ['msg1', 'msg2']
```

**æ›¿æ¢ç­–ç•¥ (è¦†ç›–)**:
```
åˆå§‹: count = 0
èŠ‚ç‚¹1è¾“å‡º: count = 1
åˆå¹¶å: count = 1

èŠ‚ç‚¹2è¾“å‡º: count = 2
åˆå¹¶å: count = 2
```

---

### 2. èŠ‚ç‚¹ (Node)

èŠ‚ç‚¹æ˜¯**çº¯å‡½æ•°**ï¼Œæ¥æ”¶çŠ¶æ€ï¼Œè¿”å›çŠ¶æ€æ›´æ–°ï¼š

```typescript
function counterNode(state: TestState): Partial<TestState> {
  // è¯»å–å½“å‰çŠ¶æ€
  const currentCount = state.count;
  
  // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
  console.log(`å½“å‰è®¡æ•°: ${currentCount}`);
  
  // è¿”å›çŠ¶æ€æ›´æ–°ï¼ˆéƒ¨åˆ†ï¼‰
  return {
    messages: [`æ‰§è¡Œç¬¬ ${currentCount + 1} æ¬¡`],
    count: currentCount + 1,
  };
}
```

**å…³é”®ç‚¹**:
- âœ… ä¸ä¿®æ”¹åŸçŠ¶æ€ï¼ˆä¸å¯å˜æ€§ï¼‰
- âœ… åªè¿”å›éœ€è¦æ›´æ–°çš„å­—æ®µ
- âœ… å¯ä»¥å¼‚æ­¥ (async)

---

### 3. è¾¹ (Edge)

#### å›ºå®šè¾¹

```typescript
workflow.addEdge('nodeA', 'nodeB');
```

**å«ä¹‰**: A æ‰§è¡Œå®Œæˆå**æ€»æ˜¯**è·³è½¬åˆ° B

#### æ¡ä»¶è¾¹

```typescript
workflow.addConditionalEdges(
  'nodeA',
  (state) => {
    if (state.count >= 3) return '__end__';
    return 'nodeA';  // å¾ªç¯å›è‡ªå·±
  }
);
```

**å«ä¹‰**: æ ¹æ®çŠ¶æ€**åŠ¨æ€å†³å®š**ä¸‹ä¸€æ­¥

---

## ğŸ”„ å®Œæ•´æ‰§è¡Œæµç¨‹

è®©æˆ‘ä»¬è·Ÿè¸ªåˆšæ‰çš„æµ‹è¯•ï¼š

### åˆå§‹åŒ–

```
åˆ›å»º StateGraph â†’ æ·»åŠ èŠ‚ç‚¹ â†’ è®¾ç½®è¾¹ â†’ ç¼–è¯‘ â†’ å¾—åˆ°å¯æ‰§è¡Œçš„ app
```

### æ‰§è¡Œé˜¶æ®µ

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 0 æ­¥: åˆå§‹åŒ–
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
åˆå§‹çŠ¶æ€: { messages: [], count: 0 }

      â†“ setEntryPoint('counter')

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 1 è½®: æ‰§è¡Œ counter èŠ‚ç‚¹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¾“å…¥çŠ¶æ€: { messages: [], count: 0 }

counterNode æ‰§è¡Œ:
  - è¯»å– count = 0
  - è¿”å› { messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡'], count: 1 }

åº”ç”¨ reducer:
  - messages: [] + ['æ‰§è¡Œç¬¬ 1 æ¬¡'] = ['æ‰§è¡Œç¬¬ 1 æ¬¡']
  - count: 1 (æ›¿æ¢)

æ›´æ–°åçŠ¶æ€: { messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡'], count: 1 }

      â†“ shouldContinue å†³ç­–

shouldContinue(state):
  - count (1) >= 3? âŒ
  - è¿”å› 'counter' (ç»§ç»­å¾ªç¯)

      â†“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 2 è½®: å†æ¬¡æ‰§è¡Œ counter èŠ‚ç‚¹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¾“å…¥çŠ¶æ€: { messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡'], count: 1 }

counterNode æ‰§è¡Œ:
  - è¯»å– count = 1
  - è¿”å› { messages: ['æ‰§è¡Œç¬¬ 2 æ¬¡'], count: 2 }

åº”ç”¨ reducer:
  - messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡'] + ['æ‰§è¡Œç¬¬ 2 æ¬¡'] = ['æ‰§è¡Œç¬¬ 1 æ¬¡', 'æ‰§è¡Œç¬¬ 2 æ¬¡']
  - count: 2

æ›´æ–°åçŠ¶æ€: { messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡', 'æ‰§è¡Œç¬¬ 2 æ¬¡'], count: 2 }

      â†“ shouldContinue å†³ç­–

shouldContinue(state):
  - count (2) >= 3? âŒ
  - è¿”å› 'counter'

      â†“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ 3 è½®: æœ€åä¸€æ¬¡æ‰§è¡Œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¾“å…¥çŠ¶æ€: { messages: ['...', '...'], count: 2 }

counterNode æ‰§è¡Œ:
  - è¯»å– count = 2
  - è¿”å› { messages: ['æ‰§è¡Œç¬¬ 3 æ¬¡'], count: 3 }

åº”ç”¨ reducer:
  - messages: ['...', '...'] + ['æ‰§è¡Œç¬¬ 3 æ¬¡'] = ['...', '...', '...']
  - count: 3

æ›´æ–°åçŠ¶æ€: { messages: [3æ¡æ¶ˆæ¯], count: 3 }

      â†“ shouldContinue å†³ç­–

shouldContinue(state):
  - count (3) >= 3? âœ…
  - è¿”å› '__end__' (ç»“æŸ)

      â†“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç»“æŸ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æœ€ç»ˆçŠ¶æ€: { messages: [3æ¡æ¶ˆæ¯], count: 3 }
```

---

## ğŸ¨ ä¸ºä»€ä¹ˆ LangGraph å¼ºå¤§ï¼Ÿ

### ä¼ ç»Ÿæ–¹å¼ vs LangGraph

#### âŒ ä¼ ç»Ÿå¾ªç¯æ–¹å¼

```typescript
let messages = [];
let count = 0;

while (count < 3) {
  // æ‰§è¡Œé€»è¾‘
  const newMessage = `æ‰§è¡Œç¬¬ ${count + 1} æ¬¡`;
  messages.push(newMessage);
  count++;
  
  // å†³ç­–é€»è¾‘æ··åœ¨ä¸€èµ·
  if (count >= 3) break;
}
```

**é—®é¢˜**:
- çŠ¶æ€ç®¡ç†æ··ä¹±
- é€»è¾‘è€¦åˆ
- éš¾ä»¥å¯è§†åŒ–
- æ— æ³•æŒä¹…åŒ–

#### âœ… LangGraph æ–¹å¼

```typescript
// 1. å®šä¹‰çŠ¶æ€
const State = Annotation.Root({ ... });

// 2. å®šä¹‰èŠ‚ç‚¹ï¼ˆçº¯å‡½æ•°ï¼‰
function counterNode(state) { return { ... }; }

// 3. å®šä¹‰å†³ç­–
function shouldContinue(state) { return '...' }

// 4. ç¼–æ’å›¾
workflow.addNode('counter', counterNode);
workflow.addConditionalEdges('counter', shouldContinue);

// 5. æ‰§è¡Œ
const app = workflow.compile();
await app.stream(initialState);
```

**ä¼˜åŠ¿**:
- âœ… å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆçŠ¶æ€ã€èŠ‚ç‚¹ã€å†³ç­–ç‹¬ç«‹ï¼‰
- âœ… å¯è§†åŒ–ï¼ˆå¯ä»¥ç”»å›¾ï¼‰
- âœ… å¯æµ‹è¯•ï¼ˆèŠ‚ç‚¹æ˜¯çº¯å‡½æ•°ï¼‰
- âœ… å¯æ‰©å±•ï¼ˆè½»æ¾æ·»åŠ æ–°èŠ‚ç‚¹ï¼‰
- âœ… å¯æŒä¹…åŒ–ï¼ˆä¿å­˜æ£€æŸ¥ç‚¹ï¼‰

---

## ğŸ”„ åº”ç”¨åˆ°æˆ‘ä»¬çš„åœºæ™¯

### å•å·¥å…·è°ƒç”¨ â†’ ç®€å•æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ AIå›å¤(å«tool_call) â†’ toolExecutor â†’ ç»“æŸ
```

### å¤šå·¥å…·è°ƒç”¨ â†’ å¾ªç¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ AIå›å¤(tool_call 1)
          â†“
    toolExecutor (æ‰§è¡Œå·¥å…·1)
          â†“
    shouldContinue (æ£€æŸ¥)
          â†“ æœ‰æ›´å¤šå·¥å…·
    AIå›å¤(tool_call 2) â† å°†å·¥å…·ç»“æœåé¦ˆç»™AI
          â†“
    toolExecutor (æ‰§è¡Œå·¥å…·2)
          â†“
    shouldContinue (æ£€æŸ¥)
          â†“ æ— æ›´å¤šå·¥å…·
        ç»“æŸ
```

### å¤š Agent åä½œ â†’ å¤æ‚å›¾ç»“æ„

```
            ç”¨æˆ·è¾“å…¥
               â†“
          SearchAgent (æœç´¢ä¿¡æ¯)
               â†“
          å†³ç­–ç½‘å…³
         â†™         â†˜
    PlanAgent    ExecuteAgent
   (åˆ›å»ºè®¡åˆ’)    (æ‰§è¡Œä»»åŠ¡)
         â†˜         â†™
          ReviewAgent (å®¡æŸ¥ç»“æœ)
               â†“
             ç»“æŸ
```

---

## ğŸ“Š çŠ¶æ€æµè½¬ç¤ºæ„å›¾

```
æ—¶åˆ» 0: { messages: [], count: 0 }
            â†“ è¿›å…¥ counter èŠ‚ç‚¹
æ—¶åˆ» 1: { messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡'], count: 1 }
            â†“ shouldContinue â†’ ç»§ç»­
æ—¶åˆ» 2: { messages: ['æ‰§è¡Œç¬¬ 1 æ¬¡', 'æ‰§è¡Œç¬¬ 2 æ¬¡'], count: 2 }
            â†“ shouldContinue â†’ ç»§ç»­
æ—¶åˆ» 3: { messages: ['...', '...', 'æ‰§è¡Œç¬¬ 3 æ¬¡'], count: 3 }
            â†“ shouldContinue â†’ ç»“æŸ
æœ€ç»ˆ: { messages: [3æ¡], count: 3 }
```

---

## ğŸ’¡ å…³é”®ç†è§£

### 1. Reducer æ˜¯çŠ¶æ€åˆå¹¶çš„æ ¸å¿ƒ

```typescript
reducer: (left, right) => left.concat(right)
```

- `left`: ä¹‹å‰ç´¯ç§¯çš„çŠ¶æ€
- `right`: èŠ‚ç‚¹æ–°è¾“å‡ºçš„çŠ¶æ€
- è¿”å›å€¼: åˆå¹¶åçš„çŠ¶æ€

### 2. èŠ‚ç‚¹è¿”å›çš„æ˜¯"æ›´æ–°"è€Œä¸æ˜¯"å®Œæ•´çŠ¶æ€"

```typescript
// âŒ é”™è¯¯: è¿”å›å®Œæ•´çŠ¶æ€
return {
  messages: state.messages.concat(['æ–°æ¶ˆæ¯']),  // æ‰‹åŠ¨åˆå¹¶
  count: state.count + 1,
};

// âœ… æ­£ç¡®: åªè¿”å›æ–°å¢éƒ¨åˆ†
return {
  messages: ['æ–°æ¶ˆæ¯'],  // reducer ä¼šè‡ªåŠ¨åˆå¹¶
  count: state.count + 1,
};
```

### 3. æ¡ä»¶è¾¹å®ç°å¾ªç¯

```typescript
workflow.addConditionalEdges('nodeA', (state) => {
  if (condition) return 'nodeA';  // å¾ªç¯å›è‡ªå·±
  return '__end__';
});
```

è¿™å°±åƒä¸€ä¸ª while å¾ªç¯ï¼Œä½†æ›´çµæ´»ï¼

---

## ğŸ“ æ€»ç»“

**LangGraph çš„æœ¬è´¨**:
- **æœ‰å‘å›¾** + **çŠ¶æ€æœº** + **å‡½æ•°å¼ç¼–ç¨‹**

**æ ¸å¿ƒæ€æƒ³**:
1. çŠ¶æ€æ˜¯ä¸å¯å˜çš„
2. èŠ‚ç‚¹æ˜¯çº¯å‡½æ•°
3. è¾¹å®šä¹‰æµç¨‹
4. Reducer è´Ÿè´£åˆå¹¶

**ä¸ºä»€ä¹ˆé€‚åˆ AI Agent?**
- AI å¤©ç„¶éœ€è¦å¤šè½®äº¤äº’
- å·¥å…·è°ƒç”¨éœ€è¦çŠ¶æ€è¿½è¸ª
- å¤æ‚ä»»åŠ¡éœ€è¦åˆ†æ”¯å’Œå¾ªç¯
- å¤š Agent éœ€è¦æ¸…æ™°çš„ç¼–æ’

---

ç°åœ¨ä½ ç†è§£åŸç†äº†å—ï¼Ÿæƒ³ç»§ç»­ï¼š
1. é›†æˆåˆ° chat.ts å®ç°çœŸå®çš„å¤šå·¥å…·è°ƒç”¨ï¼Ÿ
2. æ·»åŠ æ›´å¤šæµ‹è¯•åœºæ™¯ï¼Ÿ
3. å®ç°å¤š Agent åä½œï¼Ÿ

ğŸš€
