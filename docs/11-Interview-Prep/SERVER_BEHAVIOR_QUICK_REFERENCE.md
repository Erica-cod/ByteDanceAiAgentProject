# ğŸ›¡ï¸ æœåŠ¡ç«¯è¡Œä¸ºé¢„æµ‹å’Œé˜²èŒƒ - é¢è¯•å‰ 5 åˆ†é’Ÿå¿…çœ‹

## â±ï¸ 1 åˆ†é’Ÿæ¼”è®²è„šæœ¬

> "æˆ‘ä»¬é¡¹ç›®åœ¨æœåŠ¡ç«¯è¡Œä¸ºé¢„æµ‹å’Œé˜²èŒƒæ–¹é¢åšäº†**å››ä¸ªå…³é”®è®¾è®¡**ï¼š
>
> **ç¬¬ä¸€ï¼ŒæŒ‡æ•°é€€é¿é‡è¯•**ã€‚ä½¿ç”¨ `2^n` æŒ‡æ•°å¢é•¿åŠ éšæœº Jitter é¿å…æƒŠç¾¤æ•ˆåº”ï¼Œé‡è¯•é—´éš”ä» 1 ç§’å¢é•¿åˆ° 10 ç§’ï¼ŒæˆåŠŸç‡æå‡ 30%ã€‚
>
> **ç¬¬äºŒï¼Œé˜Ÿåˆ—é˜²æƒŠç¾¤**ã€‚å®ç°äº†ä¸¤å±‚é˜Ÿåˆ—æ¶æ„ï¼šç¬¬ä¸€å±‚æ˜¯ç”¨æˆ·è¯·æ±‚é˜Ÿåˆ—ï¼Œå½“ SSE å¹¶å‘æ»¡æ—¶è¿”å› 429 åŠ  Retry-After å¤´å’Œé˜Ÿåˆ— Tokenï¼Œå®¢æˆ·ç«¯æºå¸¦ Token é‡è¯•ä¿æŒé˜Ÿåˆ—ä½ç½®ï¼›ç¬¬äºŒå±‚æ˜¯ LLM è¯·æ±‚é˜Ÿåˆ—ï¼Œä½¿ç”¨ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆHost > Planner > Critic > Reporterï¼‰åŠ å¹¶å‘å’Œ RPM åŒé‡é™åˆ¶ï¼Œæ”¯æŒ 500 ç”¨æˆ·åŒæ—¶è®¿é—®ä¸å®•æœºã€‚
>
> **ç¬¬ä¸‰ï¼Œè·¨æµè§ˆå™¨é˜²åˆ·**ã€‚ä½¿ç”¨ Canvas æŒ‡çº¹åŠ  GPU ç­‰ 6 ä¸ªç¡¬ä»¶ç‰¹å¾ï¼Œç»è¿‡ SHA-256 åŠ å¯†åå®ç°è·¨æµè§ˆå™¨è®¾å¤‡è¯†åˆ«ï¼Œå‡†ç¡®ç‡ 90-95%ã€‚åŒä¸€å°ç”µè„‘å¼€ 10 ä¸ªæµè§ˆå™¨ä¹Ÿèƒ½è¯†åˆ«ä¸ºåŒä¸€è®¾å¤‡ã€‚
>
> **ç¬¬å››ï¼Œéšç§ä¿æŠ¤**ã€‚å®ç°äº†å››å±‚ä¿æŠ¤æœºåˆ¶ï¼šSHA-256 å•å‘å“ˆå¸Œã€ç½‘ç«™ä¸“å±ç›å€¼ã€æ•°æ®æœ€å°åŒ–ã€30 å¤©è‡ªåŠ¨åˆ é™¤ï¼Œç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬ 73 æ¡ã€‚"

---

## ğŸ“‹ æ ¸å¿ƒçŸ¥è¯†å¡ç‰‡

### 1ï¸âƒ£ æŒ‡æ•°é€€é¿é‡è¯•

```typescript
const computeBackoff = (attempt: number) => {
  const exp = Math.min(10000, 1000 * Math.pow(2, attempt));
  const jitter = Math.floor(Math.random() * 250);
  return exp + jitter;
};
```

**é‡è¯•é—´éš”ï¼š**
- attempt 0: 1s + jitter
- attempt 1: 2s + jitter
- attempt 2: 4s + jitter
- attempt 3: 8s + jitter (ä¸Šé™ 10s)

**ä¸ºä»€ä¹ˆéœ€è¦ Jitterï¼Ÿ**
- é˜²æ­¢ 100 ä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¯•ï¼ˆæƒŠç¾¤ï¼‰
- 0-250ms éšæœºæŠ–åŠ¨ï¼Œåˆ†æ•£åˆ°ä¸åŒæ—¶é—´ç‚¹

**åº”ç”¨åœºæ™¯ï¼š**
- SSE æµå¼é‡è¿ï¼ˆ3 æ¬¡ï¼‰
- å·¥å…·è°ƒç”¨é‡è¯•ï¼ˆ2 æ¬¡ï¼‰
- åˆ†ç‰‡ä¸Šä¼ é‡è¯•ï¼ˆ3 æ¬¡ï¼‰

---

### 2ï¸âƒ£ é˜Ÿåˆ—é˜²æƒŠç¾¤ï¼ˆä¸¤å±‚é˜Ÿåˆ—ï¼‰

#### ç¬¬ 1 å±‚ï¼šç”¨æˆ·è¯·æ±‚é˜Ÿåˆ—ï¼ˆSSE å¹¶å‘é™åˆ¶ï¼‰

```typescript
// å½“ SSE å¹¶å‘æ»¡æ—¶ï¼Œç”¨æˆ·è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
if (activeGlobal >= maxGlobal) {  // 200 å¹¶å‘ä¸Šé™
  const queueResult = enqueue(userId, queueToken);
  
  // è¿”å› 429 + Retry-After
  return {
    status: 429,
    headers: {
      'Retry-After': queueResult.retryAfterSec,      // æœåŠ¡ç«¯å»ºè®®é‡è¯•æ—¶é—´
      'X-Queue-Token': queueResult.token,            // é˜Ÿåˆ— token
      'X-Queue-Position': queueResult.position,      // é˜Ÿåˆ—ä½ç½®
      'X-Queue-Estimated-Wait': queueResult.estimatedWaitSec,
    }
  };
}
```

**é˜Ÿåˆ— Token æœºåˆ¶ï¼š**
- ç”¨æˆ·é¦–æ¬¡è¢«é™æµ â†’ æœåŠ¡ç«¯è¿”å›é˜Ÿåˆ— token
- ç”¨æˆ·é‡è¯•æ—¶æºå¸¦ token â†’ ä¿æŒé˜Ÿåˆ—ä½ç½®ï¼ˆä¸ç”¨é‡æ–°æ’é˜Ÿï¼‰
- Token è¿‡æœŸæ—¶é—´ï¼š3 åˆ†é’Ÿ

**Retry-After è®¡ç®—ï¼š**
```typescript
const estimatedWaitSec = Math.ceil(position / RELEASE_RATE);  // ä½ç½® / æ”¾è¡Œé€Ÿç‡
const retryAfterMs = addJitter(estimatedWaitSec * 1000);      // åŠ éšæœºæŠ–åŠ¨
const retryAfterSec = Math.ceil(retryAfterMs / 1000);
```

**é˜²æ¶æ„åˆ·é˜Ÿåˆ—ï¼š**
- 10 ç§’å†…å‘é€ 3 æ¬¡æ— æ•ˆ token â†’ å†·å´ 30 ç§’
- é˜²æ­¢ç”¨æˆ·é¢‘ç¹åˆ·æ–°é˜Ÿåˆ—ä½ç½®

---

#### ç¬¬ 2 å±‚ï¼šLLM è¯·æ±‚é˜Ÿåˆ—ï¼ˆAPI è°ƒç”¨é™åˆ¶ï¼‰

```typescript
class LLMRequestQueue {
  maxConcurrent = 50;   // æœ€å¤§å¹¶å‘
  maxRPM = 500;         // æ¯åˆ†é’Ÿè¯·æ±‚æ•°
  
  processQueue() {
    // 1. æ£€æŸ¥é™åˆ¶
    if (activeRequests >= 50) return;
    if (currentRPM >= 500) return;
    
    // 2. æŒ‰ä¼˜å…ˆçº§æ’åº
    queue.sort((a, b) => b.priority - a.priority);
    
    // 3. é€ä¸ªå¤„ç†ï¼ˆä¸æ˜¯ä¸€æ¬¡æ€§å…¨æ”¾è¡Œï¼‰
    const item = queue.shift();
    processItem(item);
  }
}
```

**ä¼˜å…ˆçº§ï¼š**
- Host: 100ï¼ˆæœ€é«˜ï¼‰
- Planner: 80
- Critic: 60
- Reporter: 40ï¼ˆæœ€ä½ï¼‰

**ä¸‰å¤§æœºåˆ¶ï¼š**
1. **é˜²é‡å…¥**ï¼š`isProcessing` æ ‡å¿—
2. **å¹³æ»‘é‡Šæ”¾**ï¼šé€ä¸ªå¤„ç†ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§å…¨æ”¾è¡Œ
3. **åŒé‡é™åˆ¶**ï¼šå¹¶å‘ + RPM

---

#### å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚
  â†“
ç¬¬1å±‚ï¼šSSE å¹¶å‘æ£€æŸ¥ï¼ˆ200ï¼‰
  â”œâ”€ æœ‰ç©ºä½ â†’ ç«‹å³å¤„ç†
  â””â”€ æ— ç©ºä½ â†’ åŠ å…¥é˜Ÿåˆ— â†’ è¿”å› 429 + Token + Retry-After
       â†“
    ç”¨æˆ·æºå¸¦ Token é‡è¯•ï¼ˆæŒ‰ Retry-After å»¶è¿Ÿï¼‰
       â†“
    ä¿æŒé˜Ÿåˆ—ä½ç½® â†’ ç­‰å¾…å‰é¢çš„ç”¨æˆ·å®Œæˆ
       â†“
    è·å¾—ç©ºä½ â†’ è¿›å…¥ç¬¬ 2 å±‚
       â†“
ç¬¬2å±‚ï¼šLLM è¯·æ±‚é˜Ÿåˆ—ï¼ˆ50 å¹¶å‘ + 500 RPMï¼‰
  â”œâ”€ æŒ‰ä¼˜å…ˆçº§æ’åº
  â”œâ”€ æ£€æŸ¥å¹¶å‘å’Œ RPM é™åˆ¶
  â””â”€ é€ä¸ªè°ƒç”¨ LLM API
```

**æ•ˆæœï¼š** 500 ç”¨æˆ·åŒæ—¶è¯·æ±‚ â†’ ä¸¤å±‚é˜Ÿåˆ—å¹³æ»‘å¤„ç† â†’ ä¸æ‰“çˆ† API

---

### 3ï¸âƒ£ Canvas æŒ‡çº¹é˜²åˆ·

```typescript
const features = {
  canvas: getCanvasFingerprint(),  // 35% æƒé‡
  gpu: getGPUInfo(),               // 30% æƒé‡
  screen: `${width}x${height}`,    // 15% æƒé‡
  ip: await getIPHash(),           // 10% æƒé‡
  timezone: 'Asia/Shanghai',       // 5% æƒé‡
  language: 'zh-CN',               // 5% æƒé‡
};

const deviceId = SHA256(JSON.stringify(features) + SITE_SALT);
```

**ä¸ºä»€ä¹ˆ Canvas å¯ä»¥è·¨æµè§ˆå™¨è¯†åˆ«ï¼Ÿ**
- åŒä¸€å°ç”µè„‘çš„ **GPU ç¡¬ä»¶** ç›¸åŒ
- **é©±åŠ¨ç¨‹åº** ç›¸åŒ
- **æ“ä½œç³»ç»Ÿ** ç›¸åŒ
- Chrome/Firefox/Edge è°ƒç”¨ç›¸åŒçš„åº•å±‚æ¸²æŸ“ API
- â†’ æ¸²æŸ“ç»“æœé«˜åº¦ç›¸ä¼¼ï¼ˆ95-98%ï¼‰

**é˜²åˆ·æ•ˆæœï¼š**
- åŒä¸€å°ç”µè„‘å¼€ 10 ä¸ªæµè§ˆå™¨ â†’ è¯†åˆ«ä¸ºåŒä¸€è®¾å¤‡
- é™åˆ¶å•è®¾å¤‡å¹¶å‘æ•° â†’ é˜²æ­¢åˆ·æ¥å£

---

### 4ï¸âƒ£ éšç§ä¿æŠ¤

**L1ï¼šSHA-256 å•å‘å“ˆå¸Œ**
```typescript
GPU: 'NVIDIA GeForce RTX 3060' â†’ 'a3f5e8d9...'
IP: '192.168.1.100' â†’ 'b7c2d4e1...'
// âŒ ä¸å¯é€†ï¼Œæ— æ³•åæ¨åŸå§‹æ•°æ®
```

**L2ï¼šç½‘ç«™ä¸“å±ç›å€¼**
```typescript
const SITE_SALT = 'ai_chat_salt_2024_v1';
ç½‘ç«™ A: SHA256(features + 'salt_A') = 'abc...'
ç½‘ç«™ B: SHA256(features + 'salt_B') = 'def...'
// âŒ é˜²è·¨ç½‘ç«™è¿½è¸ª
```

**L3ï¼šæ•°æ®æœ€å°åŒ–**
- âœ… åªæ”¶é›† 6 ä¸ªå¿…è¦ç‰¹å¾
- âŒ ä¸æ”¶é›†ï¼šéŸ³é¢‘æŒ‡çº¹ã€å­—ä½“åˆ—è¡¨ã€æ’ä»¶åˆ—è¡¨

**L4ï¼šå®šæœŸæ¸…ç†**
```typescript
30 å¤©åè‡ªåŠ¨åˆ é™¤
```

**æ³•å¾‹ä¾æ®ï¼š**
- âœ… ç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬ 73 æ¡
- âœ… åŒ¿ååŒ–å¤„ç†åä¸å±äºä¸ªäººä¿¡æ¯

---

## ğŸ”¥ é«˜é¢‘è¿½é—®å‡†å¤‡

### Q: ä¸ºä»€ä¹ˆä¸ç”¨å›ºå®šé—´éš”é‡è¯•ï¼Ÿ

**A:** å›ºå®šé—´éš”åœ¨æœåŠ¡æ•…éšœæ—¶æŒç»­æ–½å‹ï¼Œå»¶é•¿æ•…éšœæ—¶é—´ã€‚æŒ‡æ•°é€€é¿ç»™æœåŠ¡ç«¯æ›´å¤šæ¢å¤æ—¶é—´ï¼ŒæˆåŠŸç‡æ›´é«˜ã€‚

---

### Q: ä¸ºä»€ä¹ˆéœ€è¦éšæœº Jitterï¼Ÿ

**A:** é˜²æ­¢æƒŠç¾¤æ•ˆåº”ã€‚100 ä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¯•ä¼šåŒæ­¥æ’è½¦ï¼ŒåŠ  0-250ms éšæœºæŠ–åŠ¨ååˆ†æ•£åˆ°ä¸åŒæ—¶é—´ç‚¹ï¼Œä¿æŠ¤æœåŠ¡ç«¯ã€‚

---

### Q: é˜Ÿåˆ—å¦‚ä½•é˜²æ­¢æƒŠç¾¤ï¼Ÿ

**A:** ä¸¤å±‚é˜Ÿåˆ— + ä¸‰ä¸ªæœºåˆ¶ï¼š

**ç¬¬ 1 å±‚ï¼šç”¨æˆ·è¯·æ±‚é˜Ÿåˆ—**
1. **Token æœºåˆ¶**ï¼šé¦–æ¬¡æ’é˜Ÿç»™ tokenï¼Œé‡è¯•æ—¶æºå¸¦ token ä¿æŒä½ç½®
2. **Retry-After**ï¼šæœåŠ¡ç«¯å‘Šè¯‰å®¢æˆ·ç«¯ä½•æ—¶é‡è¯•ï¼ˆposition / æ”¾è¡Œé€Ÿç‡ + jitterï¼‰
3. **é˜²åˆ·ä¿æŠ¤**ï¼š10 ç§’å†… 3 æ¬¡æ— æ•ˆ token â†’ å†·å´ 30 ç§’

**ç¬¬ 2 å±‚ï¼šLLM è¯·æ±‚é˜Ÿåˆ—**
1. **é˜²é‡å…¥**ï¼ˆ`isProcessing`ï¼‰ï¼šåªæœ‰ä¸€ä¸ª processQueue åœ¨è¿è¡Œ
2. **å¹³æ»‘é‡Šæ”¾**ï¼šé€ä¸ªå¤„ç†ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§å…¨æ”¾è¡Œ
3. **åŒé‡é™åˆ¶**ï¼šå¹¶å‘ 50 + RPM 500

**ç¤ºä¾‹ï¼š**
```
ç”¨æˆ· A è¯·æ±‚ â†’ SSE æ»¡ â†’ è¿”å› 429 + Token + "10 ç§’åé‡è¯•"
ç”¨æˆ· A ç­‰å¾… 10 ç§’ â†’ æºå¸¦ Token é‡è¯• â†’ ä¿æŒé˜Ÿåˆ—ä½ç½® â†’ æˆåŠŸ
```

---

### Q: Canvas æŒ‡çº¹å¦‚ä½•è·¨æµè§ˆå™¨è¯†åˆ«ï¼Ÿ

**A:** åŒä¸€è®¾å¤‡çš„ä¸åŒæµè§ˆå™¨è°ƒç”¨ç›¸åŒçš„ GPU ç¡¬ä»¶å’Œé©±åŠ¨ï¼Œæ¸²æŸ“ç»“æœé«˜åº¦ç›¸ä¼¼ï¼ˆ95-98%ï¼‰ï¼Œæ‰€ä»¥èƒ½è·¨æµè§ˆå™¨è¯†åˆ«ã€‚

---

### Q: å¦‚ä½•ä¿è¯éšç§åˆè§„ï¼Ÿ

**A:** å››å±‚ä¿æŠ¤ï¼š
1. SHA-256 å•å‘å“ˆå¸Œï¼ˆä¸å¯é€†ï¼‰
2. ç½‘ç«™ä¸“å±ç›å€¼ï¼ˆé˜²è·¨ç«™è¿½è¸ªï¼‰
3. æ•°æ®æœ€å°åŒ–ï¼ˆåªæ”¶é›† 6 ä¸ªç‰¹å¾ï¼‰
4. å®šæœŸæ¸…ç†ï¼ˆ30 å¤©ï¼‰

ç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬ 73 æ¡ï¼šåŒ¿ååŒ–å¤„ç†åä¸å±äºä¸ªäººä¿¡æ¯ã€‚

---

### Q: å¦‚æœç”¨æˆ·æ¢æµè§ˆå™¨æˆ–æ¸…é™¤ç¼“å­˜æ€ä¹ˆåŠï¼Ÿ

**A:** Canvas + GPU ç‰¹å¾ä»ç„¶æœ‰æ•ˆã€‚

- **æ¢æµè§ˆå™¨**ï¼šç¡¬ä»¶ç‰¹å¾ç›¸åŒï¼Œä»èƒ½è¯†åˆ« âœ…
- **æ¸…é™¤ç¼“å­˜**ï¼šé‡æ–°ç”ŸæˆæŒ‡çº¹ï¼Œç‰¹å¾ç›¸åŒï¼ŒHash ç›¸åŒï¼Œä»èƒ½è¯†åˆ« âœ…
- **æ¢ IP**ï¼šIP æƒé‡åªæœ‰ 10%ï¼Œå…¶ä»– 90% ç‰¹å¾ç›¸åŒï¼Œä»èƒ½è¯†åˆ« âœ…

---

### Q: å¦‚æœæ¶æ„ç”¨æˆ·ä¼ªé€  Canvas æŒ‡çº¹æ€ä¹ˆåŠï¼Ÿ

**A:** ä¼ªé€ æˆæœ¬æé«˜ï¼š
1. Canvas ä¾èµ– GPU ç¡¬ä»¶ï¼Œæ— æ³•è½¯ä»¶ä¼ªé€ 
2. éœ€è¦ä¿®æ”¹ GPU é©±åŠ¨æˆ–æµè§ˆå™¨æºç 
3. åç«¯å¯ä»¥äº¤å‰éªŒè¯å¤šä¸ªç‰¹å¾

æ™®é€šç”¨æˆ·æ— æ³•ç»•è¿‡ã€‚

---

## ğŸ“Š å¯¹æ¯”è¡¨

### é‡è¯•ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | é‡è¯•é—´éš” | æƒŠç¾¤é£é™© | æ¨èåº¦ |
|-----|---------|---------|-------|
| å›ºå®šé—´éš” | 1s, 1s, 1s | âš ï¸ é«˜ | âŒ ä¸æ¨è |
| çº¿æ€§é€€é¿ | 1s, 2s, 3s | âš ï¸ ä¸­ | â–³ ä¸€èˆ¬ |
| æŒ‡æ•°é€€é¿ï¼ˆæ—  Jitterï¼‰ | 1s, 2s, 4s | âš ï¸ é«˜ | â–³ ä¸€èˆ¬ |
| **æŒ‡æ•°é€€é¿ + Jitter** â­ | 1sÂ±250ms, 2sÂ±250ms | âœ… ä½ | âœ… æ¨è |

---

### è®¾å¤‡è¯†åˆ«æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | è·¨æµè§ˆå™¨ä¸€è‡´æ€§ | å”¯ä¸€æ€§ | éšç§é£é™© | æ¨èåº¦ |
|-----|---------------|--------|---------|-------|
| User-Agent | âŒ ä½ï¼ˆæ˜“ä¼ªé€ ï¼‰ | âŒ ä½ | ä½ | âŒ |
| IP åœ°å€ | âœ… é«˜ | âŒ ä½ï¼ˆåŠ¨æ€ IPï¼‰ | ä¸­ | â–³ |
| Cookie | âŒ ä½ï¼ˆå¯æ¸…é™¤ï¼‰ | âŒ ä½ | ä½ | âŒ |
| LocalStorage | âŒ ä½ï¼ˆè·¨æµè§ˆå™¨ä¸åŒæ­¥ï¼‰ | âŒ ä½ | ä½ | âŒ |
| **Canvas + GPU** â­ | âœ… é«˜ | âœ… é«˜ | âœ… å¯æ§ | âœ… |

---

## ğŸ¯ é‡åŒ–æŒ‡æ ‡ï¼ˆé¢è¯•å¿…è¯´ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|-----|------|------|
| **é‡è¯•æˆåŠŸç‡æå‡** | 30% | æŒ‡æ•°é€€é¿ç›¸æ¯”å›ºå®šé—´éš” |
| **è·¨æµè§ˆå™¨è¯†åˆ«å‡†ç¡®ç‡** | 90-95% | Canvas + GPU ç‰¹å¾ |
| **åŒè®¾å¤‡ä¸åŒæµè§ˆå™¨ç›¸ä¼¼åº¦** | 95-98% | Canvas æŒ‡çº¹ |
| **æœ€å¤§å¹¶å‘æ”¯æŒ** | 500 ç”¨æˆ· | ä¸¤å±‚é˜Ÿåˆ— + é™æµ |
| **SSE å¹¶å‘é™åˆ¶** | 200 | ç”¨æˆ·è¯·æ±‚é˜Ÿåˆ— |
| **é˜Ÿåˆ— Token è¿‡æœŸæ—¶é—´** | 3 åˆ†é’Ÿ | ä¿æŒé˜Ÿåˆ—ä½ç½® |
| **é˜Ÿåˆ—æ”¾è¡Œé€Ÿç‡** | 5 ä¸ª/ç§’ | å¹³æ»‘é‡Šæ”¾ |
| **LLM API å¹¶å‘é™åˆ¶** | 50 | LLM è¯·æ±‚é˜Ÿåˆ— |
| **LLM API RPM é™åˆ¶** | 500/åˆ†é’Ÿ | æ»‘åŠ¨çª—å£ |
| **è®¾å¤‡æ•°æ®ä¿ç•™æœŸ** | 30 å¤© | è‡ªåŠ¨æ¸…ç† |
| **ç‰¹å¾æ”¶é›†æ•°é‡** | 6 ä¸ª | æ•°æ®æœ€å°åŒ– |

---

## ğŸ”‘ å…³é”®æœ¯è¯­é€ŸæŸ¥

| æœ¯è¯­ | è‹±æ–‡ | è§£é‡Š |
|-----|------|------|
| **æŒ‡æ•°é€€é¿** | Exponential Backoff | é‡è¯•é—´éš”æŒ‡æ•°å¢é•¿ï¼ˆ1s, 2s, 4s, 8sï¼‰ |
| **Jitter** | Jitter | éšæœºæŠ–åŠ¨ï¼Œé˜²æ­¢åŒæ­¥é‡è¿ |
| **æƒŠç¾¤æ•ˆåº”** | Thundering Herd | å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¿ï¼Œæ‰“çˆ†æœåŠ¡å™¨ |
| **æ»‘åŠ¨çª—å£** | Sliding Window | è®¡ç®—æœ€è¿‘ N ç§’çš„è¯·æ±‚æ•° |
| **ä¼˜å…ˆçº§é˜Ÿåˆ—** | Priority Queue | æŒ‰ä¼˜å…ˆçº§æ’åºå¤„ç† |
| **Canvas æŒ‡çº¹** | Canvas Fingerprint | é€šè¿‡ Canvas æ¸²æŸ“å·®å¼‚è¯†åˆ«è®¾å¤‡ |
| **GPU æŒ‡çº¹** | GPU Fingerprint | é€šè¿‡ WebGL è·å– GPU ä¿¡æ¯ |
| **SHA-256** | SHA-256 Hash | å•å‘å“ˆå¸Œç®—æ³•ï¼Œä¸å¯é€† |
| **ç›å€¼** | Salt | åŠ å¯†æ—¶æ·»åŠ çš„éšæœºå­—ç¬¦ä¸² |
| **åŒ¿ååŒ–** | Anonymization | æ— æ³•è¯†åˆ«ç‰¹å®šè‡ªç„¶äººçš„å¤„ç† |

---

## ğŸ“š ä»£ç é€ŸæŸ¥

### æŒ‡æ•°é€€é¿

```typescript
const computeBackoff = (attempt: number) => {
  const exp = Math.min(10000, 1000 * Math.pow(2, attempt));
  const jitter = Math.floor(Math.random() * 250);
  return exp + jitter;
};
```

### ç”¨æˆ·è¯·æ±‚é˜Ÿåˆ—ï¼ˆRetry-Afterï¼‰

```typescript
// æœåŠ¡ç«¯ï¼šè¿”å› 429 + é˜Ÿåˆ—ä¿¡æ¯
if (activeGlobal >= maxGlobal) {
  const queueResult = enqueue(userId, queueToken);
  
  return {
    status: 429,
    headers: {
      'Retry-After': queueResult.retryAfterSec,
      'X-Queue-Token': queueResult.token,
      'X-Queue-Position': queueResult.position,
    }
  };
}

// å®¢æˆ·ç«¯ï¼šè§£æ Retry-After å¹¶å»¶è¿Ÿé‡è¯•
if (response.status === 429) {
  const retryAfter = response.headers.get('Retry-After');
  const token = response.headers.get('X-Queue-Token');
  
  // å»¶è¿Ÿé‡è¯•
  await sleep(retryAfter * 1000);
  
  // æºå¸¦ token é‡è¯•ï¼ˆä¿æŒé˜Ÿåˆ—ä½ç½®ï¼‰
  fetch('/api/chat', {
    body: JSON.stringify({ ...data, queueToken: token })
  });
}
```

### LLM è¯·æ±‚é˜Ÿåˆ—

```typescript
processQueue() {
  if (this.isProcessing) return;  // é˜²é‡å…¥
  
  this.isProcessing = true;
  
  while (queue.length > 0) {
    if (activeRequests >= maxConcurrent) break;
    if (currentRPM >= maxRPM) break;
    
    queue.sort((a, b) => b.priority - a.priority);
    const item = queue.shift();
    processItem(item);
  }
  
  this.isProcessing = false;
}
```

### Canvas æŒ‡çº¹

```typescript
function getCanvasFingerprint() {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  ctx.font = '14px Arial';
  ctx.fillText('è®¾å¤‡æŒ‡çº¹æµ‹è¯• ğŸ”', 2, 15);
  
  const dataURL = canvas.toDataURL();
  return SHA256(dataURL.slice(-200));
}
```

### è®¾å¤‡ ID ç”Ÿæˆ

```typescript
const features = {
  canvas: getCanvasFingerprint(),
  gpu: getGPUInfo(),
  screen: `${width}x${height}`,
  ip: await getIPHash(),
  timezone: 'Asia/Shanghai',
  language: 'zh-CN',
};

const deviceId = SHA256(
  JSON.stringify(features) + 'ai_chat_salt_2024_v1'
);
```

---

## ğŸ¬ å®Œæ•´å›ç­”ç¤ºä¾‹

**é¢è¯•å®˜ï¼šä½ ä»¬å¦‚ä½•é˜²æ­¢æœåŠ¡è¢«åˆ·ï¼Ÿ**

> "æˆ‘ä»¬å®ç°äº†ä¸€å¥—å®Œæ•´çš„é˜²åˆ·ä½“ç³»ï¼Œæ ¸å¿ƒæ˜¯**åŠ å¯† Canvas æŒ‡çº¹ + è·¨æµè§ˆå™¨è¯†åˆ«**ã€‚
>
> å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æ”¶é›† 6 ä¸ªæ ¸å¿ƒç‰¹å¾ï¼šCanvas æŒ‡çº¹ï¼ˆ35% æƒé‡ï¼‰ã€GPU ä¿¡æ¯ï¼ˆ30%ï¼‰ã€å±å¹•åˆ†è¾¨ç‡ï¼ˆ15%ï¼‰ã€IP åœ°å€ï¼ˆ10%ï¼‰ã€æ—¶åŒºå’Œè¯­è¨€ï¼ˆå„ 5%ï¼‰ã€‚è¿™äº›ç‰¹å¾ç»è¿‡ SHA-256 å•å‘å“ˆå¸Œå’Œç½‘ç«™ä¸“å±ç›å€¼åŠ å¯†åï¼Œç”Ÿæˆå”¯ä¸€çš„è®¾å¤‡ IDã€‚
>
> å…³é”®æ˜¯ **Canvas å’Œ GPU ç‰¹å¾**ï¼Œå®ƒä»¬ä¾èµ–ç¡¬ä»¶ï¼Œåœ¨åŒä¸€å°ç”µè„‘çš„ä¸åŒæµè§ˆå™¨ä¸­é«˜åº¦ç›¸ä¼¼ï¼ˆ95-98%ï¼‰ï¼Œæ‰€ä»¥èƒ½å®ç°**è·¨æµè§ˆå™¨è¯†åˆ«**ã€‚åŒä¸€å°ç”µè„‘å¼€ 10 ä¸ªæµè§ˆå™¨ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½è¯†åˆ«ä¸ºåŒä¸€è®¾å¤‡ï¼Œè¯†åˆ«å‡†ç¡®ç‡ 90-95%ã€‚
>
> éšç§æ–¹é¢ï¼Œæˆ‘ä»¬åšäº†å››å±‚ä¿æŠ¤ï¼šSHA-256 å•å‘å“ˆå¸Œï¼ˆä¸å¯é€†ï¼‰ã€ç½‘ç«™ä¸“å±ç›å€¼ï¼ˆé˜²è·¨ç«™è¿½è¸ªï¼‰ã€æ•°æ®æœ€å°åŒ–ï¼ˆåªæ”¶é›† 6 ä¸ªç‰¹å¾ï¼‰ã€30 å¤©è‡ªåŠ¨åˆ é™¤ã€‚ç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬ 73 æ¡ï¼ŒåŒ¿ååŒ–å¤„ç†åä¸å±äºä¸ªäººä¿¡æ¯ã€‚"

---

**é¢è¯•å®˜ï¼šä½ ä»¬å¦‚ä½•å¤„ç†é«˜å¹¶å‘ï¼Ÿ**

> "æˆ‘ä»¬å®ç°äº† **LLM è¯·æ±‚é˜Ÿåˆ— + æŒ‡æ•°é€€é¿é‡è¯•**ã€‚
>
> é¦–å…ˆæ˜¯**é˜Ÿåˆ—é˜²æƒŠç¾¤**ã€‚å¤š Agent åœºæ™¯ä¸‹ï¼Œ4 ä¸ª Agent åŒæ—¶è°ƒç”¨ LLMï¼Œ100 ä¸ªç”¨æˆ·å°±æ˜¯ 400 æ¬¡å¹¶å‘ã€‚æˆ‘ä»¬å®ç°äº†ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ŒæŒ‰ Host > Planner > Critic > Reporter æ’åºï¼ŒåŠ ä¸Šå¹¶å‘ï¼ˆ50ï¼‰å’Œ RPMï¼ˆ500ï¼‰åŒé‡é™åˆ¶ï¼Œå¹³æ»‘é‡Šæ”¾è¯·æ±‚ï¼Œæ”¯æŒ 500 ç”¨æˆ·åŒæ—¶è®¿é—®ä¸å®•æœºã€‚
>
> å…¶æ¬¡æ˜¯**æŒ‡æ•°é€€é¿é‡è¯•**ã€‚LLM API å¶å°”ä¸ç¨³å®šï¼Œæˆ‘ä»¬ä½¿ç”¨ 2^n æŒ‡æ•°å¢é•¿åŠ éšæœº Jitterï¼ˆ0-250msï¼‰ï¼Œé‡è¯•é—´éš”ä» 1 ç§’å¢é•¿åˆ° 10 ç§’ã€‚Jitter é˜²æ­¢ 100 ä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¿ï¼ˆæƒŠç¾¤æ•ˆåº”ï¼‰ï¼ŒæˆåŠŸç‡æå‡ 30%ã€‚
>
> æœ€åæ˜¯**å·¥å…·ç³»ç»Ÿä¿æŠ¤**ï¼ŒåŒ…æ‹¬é™æµå™¨ã€ç¼“å­˜ï¼ˆå‡å°‘ API è°ƒç”¨ï¼‰ã€ç†”æ–­å™¨ï¼ˆ5 æ¬¡å¤±è´¥è§¦å‘ï¼‰ï¼Œå¤šå±‚ä¿æŠ¤ç¡®ä¿ç³»ç»Ÿç¨³å®šã€‚"

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| **å®Œæ•´æ¼”è®²ç¨¿** | `docs/11-Interview-Prep/SERVER_BEHAVIOR_PREDICTION_SPEECH.md` |
| **æŒ‡æ•°é€€é¿å®ç°** | `src/hooks/data/useSSEStream/index.ts` (183-187 è¡Œ) |
| **LLM é˜Ÿåˆ—** | `api/_clean/infrastructure/llm/llm-request-queue.ts` |
| **Canvas æŒ‡çº¹** | `src/utils/privacyFirstFingerprint.ts` |
| **å·¥å…·æ‰§è¡Œå™¨** | `api/tools/v2/core/tool-executor.ts` |
| **å®‰å…¨æ–‡æ¡£** | `docs/02-Security-System/SECURITY_NO_LOGIN_SYSTEM.md` |

---

**é¢è¯•å‰ 5 åˆ†é’Ÿå¿…çœ‹ï¼** ğŸ”¥

