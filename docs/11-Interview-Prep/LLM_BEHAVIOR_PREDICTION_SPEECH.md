# ğŸ¤– LLM ä¾§è¡Œä¸ºé¢„æµ‹å’Œé˜²èŒƒ - æŠ€æœ¯æ¼”è®²ç¨¿

## ğŸ“‹ ç›®å½•

1. [3 åˆ†é’Ÿå¿«é€Ÿç‰ˆ](#3-åˆ†é’Ÿå¿«é€Ÿç‰ˆ)
2. [10 åˆ†é’Ÿå®Œæ•´ç‰ˆ](#10-åˆ†é’Ÿå®Œæ•´ç‰ˆ)
3. [æŠ€æœ¯æ·±å…¥é—®ç­”](#æŠ€æœ¯æ·±å…¥é—®ç­”)
4. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
5. [æ¶æ„å›¾](#æ¶æ„å›¾)

---

## â±ï¸ 3 åˆ†é’Ÿå¿«é€Ÿç‰ˆ

### å¼€åœºç™½

> "æˆ‘ä»¬é¡¹ç›®åœ¨ LLM ä¾§è¡Œä¸ºé¢„æµ‹å’Œé˜²èŒƒæ–¹é¢åšäº†**ä¸‰ä¸ªå…³é”®ä¼˜åŒ–**ï¼šEmbedding ç¼“å­˜èŠ‚çº¦ tokenã€å¤š Agent é€šä¿¡åè®®è®¾è®¡ã€JSON æ ¼å¼ä¿®å¤ä¿è¯è®¨è®ºç»§ç»­ã€‚è¿™äº›è®¾è®¡åœ¨ä¿è¯ LLM å“åº”è´¨é‡çš„åŒæ—¶ï¼Œæ˜¾è‘—é™ä½äº† API è°ƒç”¨æˆæœ¬å’Œå‡ºé”™ç‡ã€‚"

---

### æ ¸å¿ƒè¦ç‚¹

#### 1ï¸âƒ£ Embedding ç¼“å­˜èŠ‚çº¦ Token æ¶ˆè€—

**é—®é¢˜ï¼š** LLM API æŒ‰ token è®¡è´¹ï¼Œç›¸åŒæˆ–ç›¸ä¼¼çš„é—®é¢˜é‡å¤è°ƒç”¨ä¼šäº§ç”Ÿå·¨é¢æˆæœ¬ã€‚

**è§£å†³æ–¹æ¡ˆï¼šå‘é‡ç›¸ä¼¼åº¦åŒ¹é… + Redis ä¸´æ—¶ç¼“å­˜**

```typescript
// æ­¥éª¤ 1ï¼šè®¡ç®—ç”¨æˆ·è¾“å…¥çš„ embedding å‘é‡
const requestEmbedding = await embeddingService.getEmbedding(userQuery);
// ç«å±±å¼•æ“ embedding APIï¼Œ768 ç»´å‘é‡

// æ­¥éª¤ 2ï¼šæŸ¥æ‰¾è¯¥ç”¨æˆ·ä¹‹å‰çš„ç›¸ä¼¼è¯·æ±‚
const cachedRequests = await findByUser(userId, modelType, mode);

// æ­¥éª¤ 3ï¼šè®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
for (const cache of cachedRequests) {
  const similarity = cosineSimilarity(requestEmbedding, cache.requestEmbedding);
  
  if (similarity >= 0.95) {  // ç›¸ä¼¼åº¦é˜ˆå€¼ 95%
    // ç›´æ¥è¿”å›ç¼“å­˜çš„å“åº”ï¼Œä¸è°ƒç”¨ LLM
    return cache.response;
  }
}

// æ­¥éª¤ 4ï¼šæ— ç¼“å­˜å‘½ä¸­ï¼Œè°ƒç”¨ LLM å¹¶ä¿å­˜ç»“æœåˆ° Redis
const response = await callLLM(userQuery);
await saveToRedis(userId, requestEmbedding, response, TTL: 30å¤©);
```

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… **Token èŠ‚çº¦**ï¼šç›¸ä¼¼é—®é¢˜ç›´æ¥è¿”å›ç¼“å­˜ï¼Œä¸æ¶ˆè€— token
- âœ… **è¯­ä¹‰è¯†åˆ«**ï¼š"ä»€ä¹ˆæ˜¯ AIï¼Ÿ" å’Œ "AI æ˜¯ä»€ä¹ˆï¼Ÿ" ä¼šè¢«è¯†åˆ«ä¸ºç›¸åŒé—®é¢˜
- âœ… **Redis å­˜å‚¨**ï¼šä¸´æ—¶æ•°æ®ï¼Œ30 å¤©è‡ªåŠ¨è¿‡æœŸï¼Œä¸æŒä¹…åŒ–
- âœ… **ç”¨æˆ·éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·çš„ç¼“å­˜ç‹¬ç«‹ï¼Œä¸ä¼šäº’ç›¸å¹²æ‰°

---

#### 2ï¸âƒ£ å¤š Agent é€šä¿¡åè®®è®¾è®¡

**é—®é¢˜ï¼š** å¤š Agent è®¨è®ºæ—¶éœ€è¦æ ‡å‡†åŒ–çš„ JSON æ ¼å¼è¿›è¡Œé€šä¿¡ï¼Œåè®®ä¸ç»Ÿä¸€ä¼šå¯¼è‡´ä¿¡æ¯ä¼ é€’å¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€ JSON é€šä¿¡åè®®**

```typescript
// Agent è¾“å‡ºæ ‡å‡†åè®®
export interface AgentOutput {
  agent_id: string;             // Agent æ ‡è¯†ï¼ˆplanner/critic/host/reporterï¼‰
  round: number;                // å½“å‰è½®æ¬¡
  output_type: string;          // è¾“å‡ºç±»å‹ï¼ˆplan/critique/decision/reportï¼‰
  content: string;              // ä¸»è¦è¾“å‡ºå†…å®¹ï¼ˆç”¨æˆ·å¯è§ï¼‰
  metadata: {                   // å…ƒæ•°æ®ï¼ˆç»“æ„åŒ–ä¿¡æ¯ï¼‰
    position: PositionSummary;  // ç«‹åœºæ‘˜è¦
    plan?: Plan;                // è®¡åˆ’ï¼ˆPlanner ä¸“ç”¨ï¼‰
    critique?: Critique;        // æ‰¹è¯„ï¼ˆCritic ä¸“ç”¨ï¼‰
    decision?: Decision;        // å†³ç­–ï¼ˆHost ä¸“ç”¨ï¼‰
  };
  timestamp: string;            // æ—¶é—´æˆ³
}

// ç«‹åœºæ‘˜è¦ï¼ˆç”¨äºç›¸ä¼¼åº¦è®¡ç®—ï¼‰
export interface PositionSummary {
  conclusion: string;           // ä¸€å¥è¯ç»“è®º
  key_reasons: string[];        // å…³é”®ç†ç”±
  assumptions: string[];        // å‡è®¾æ¡ä»¶
  confidence: number;           // ç½®ä¿¡åº¦ (0-1)
  changes_from_last_round?: {   // ä¸ä¸Šä¸€è½®çš„å˜åŒ–
    conclusion_changed: boolean;
    reasons_added: string[];
    confidence_delta: number;
  };
}
```

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… **ç»Ÿä¸€åè®®**ï¼šæ‰€æœ‰ Agent ä½¿ç”¨ç›¸åŒçš„ JSON ç»“æ„é€šä¿¡
- âœ… **ç±»å‹å®‰å…¨**ï¼šTypeScript æ¥å£å®šä¹‰ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- âœ… **å¯æ‰©å±•**ï¼šmetadata å­—æ®µæ”¯æŒä¸åŒ Agent çš„ä¸“æœ‰æ•°æ®
- âœ… **å¯è¿½æº¯**ï¼šåŒ…å«è½®æ¬¡ã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•

---

#### 3ï¸âƒ£ JSON æ ¼å¼ä¿®å¤ - ä¿è¯è®¨è®ºç»§ç»­

**é—®é¢˜ï¼š** LLM è¾“å‡ºçš„ JSON æ ¼å¼å¯èƒ½ä¸ç¬¦åˆè¦æ±‚ï¼Œå¯¼è‡´å¤š Agent è®¨è®ºæ— æ³•ç»§ç»­ã€‚

**è§£å†³æ–¹æ¡ˆï¼šä¸‰å±‚ä¿®å¤æœºåˆ¶ + è¯­ä¹‰ç†è§£å…œåº•**

```typescript
// L1: jsonrepair åŒ…ï¼ˆæˆç†Ÿçš„ç¬¬ä¸‰æ–¹åº“ï¼‰
try {
  const repairedJsonStr = jsonrepair(jsonStr);
  const result = JSON.parse(repairedJsonStr);
  return result;  // âœ… ä¿®å¤æˆåŠŸ
} catch (error) {
  // ç»§ç»­ L2
}

// L2: è‡ªå®šä¹‰æ­£åˆ™ä¿®å¤ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
try {
  let fixed = jsonStr;
  fixed = fixed.replace(/,(\s*[}\]])/g, '$1');  // ç§»é™¤å°¾éšé€—å·
  fixed = fixed.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');  // è¡¥é½å¼•å·
  // ... æ›´å¤šä¿®å¤é€»è¾‘
  const result = JSON.parse(fixed);
  return result;  // âœ… ä¿®å¤æˆåŠŸ
} catch (error) {
  // ç»§ç»­ L3
}

// L3: æ¨¡å‹è¯­ä¹‰ç†è§£ï¼ˆæœ€åå…œåº•ï¼‰
const prompt = `
ä»¥ä¸‹ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä¿®å¤å¹¶è¿”å›æ­£ç¡®çš„ JSONï¼š
${jsonStr}

è¦æ±‚ï¼š
1. è¡¥é½ç¼ºå¤±çš„å¼•å·ã€æ‹¬å·
2. ç§»é™¤å¤šä½™çš„é€—å·
3. åªè¿”å›ä¿®å¤åçš„ JSONï¼Œä¸è¦å…¶ä»–è¯´æ˜
`;
const fixedJson = await callLLM(prompt);
return JSON.parse(fixedJson);  // âœ… æœ€åå…œåº•
```

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… **ä¸‰å±‚å…œåº•**ï¼šjsonrepair â†’ æ­£åˆ™ä¿®å¤ â†’ æ¨¡å‹ç†è§£
- âœ… **å®¹é”™æ€§å¼º**ï¼šå³ä½¿ JSON æ ¼å¼ä¸¥é‡é”™è¯¯ä¹Ÿèƒ½ä¿®å¤
- âœ… **ä¿è¯è®¨è®º**ï¼šä¿®å¤å¤±è´¥ä¸ä¼šå¯¼è‡´è®¨è®ºä¸­æ–­ï¼Œè€Œæ˜¯ç»§ç»­ä¸‹ä¸€è½®
- âœ… **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€äººå·¥ä»‹å…¥ï¼Œè‡ªåŠ¨ä¿®å¤å¹¶ç»§ç»­

---

### æ€»ç»“

| æŠ€æœ¯ç‚¹ | æ ¸å¿ƒä»·å€¼ | ä¸šåŠ¡æ•ˆæœ |
|--------|---------|---------|
| **Embedding ç¼“å­˜** | å‘é‡ç›¸ä¼¼åº¦ + Redis | Token èŠ‚çº¦ï¼Œæˆæœ¬é™ä½ |
| **é€šä¿¡åè®®** | ç»Ÿä¸€ JSON ç»“æ„ | Agent åä½œç¨³å®š |
| **JSON ä¿®å¤** | ä¸‰å±‚ä¿®å¤ + è¯­ä¹‰ç†è§£ | è®¨è®ºä¸ä¸­æ–­ï¼Œå®¹é”™æ€§å¼º |

**äº®ç‚¹ï¼šåœ¨ä¿è¯ LLM å“åº”è´¨é‡çš„åŒæ—¶ï¼Œæ˜¾è‘—é™ä½æˆæœ¬å’Œå‡ºé”™ç‡ï¼**

---

## ğŸ“– 10 åˆ†é’Ÿå®Œæ•´ç‰ˆ

### 1. èƒŒæ™¯ä¸æŒ‘æˆ˜

#### é—®é¢˜ 1ï¼šé‡å¤è¯·æ±‚æˆæœ¬é«˜æ˜‚

æˆ‘ä»¬çš„ç³»ç»Ÿä½¿ç”¨ç«å±±å¼•æ“çš„ LLM APIï¼š
- è®¡è´¹æ–¹å¼ï¼šæŒ‰ token è®¡è´¹ï¼ˆ$0.002/1K tokensï¼‰
- é‡å¤é—®é¢˜ï¼šç”¨æˆ·ç»å¸¸é—®ç›¸åŒæˆ–ç›¸ä¼¼çš„é—®é¢˜
- æˆæœ¬é—®é¢˜ï¼šæ¯æ¬¡éƒ½è°ƒç”¨ LLMï¼Œæµªè´¹ token

**åœºæ™¯ï¼š**
```
ç”¨æˆ· Aï¼šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ
ç³»ç»Ÿï¼š[è°ƒç”¨ LLM] â†’ 5000 tokens â†’ $0.01

ç”¨æˆ· Bï¼šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿï¼ˆå®Œå…¨ç›¸åŒï¼‰
ç³»ç»Ÿï¼š[å†æ¬¡è°ƒç”¨ LLM] â†’ 5000 tokens â†’ åˆ $0.01

ç”¨æˆ· Cï¼šäººå·¥æ™ºèƒ½æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆè¯­ä¹‰ç›¸åŒï¼‰
ç³»ç»Ÿï¼š[åˆè°ƒç”¨ LLM] â†’ 5000 tokens â†’ åˆ $0.01

ç´¯è®¡ï¼š3 æ¬¡ç›¸åŒé—®é¢˜ = $0.03ï¼Œ100 ä¸ªç”¨æˆ· = $1ï¼Œ1000 ä¸ªç”¨æˆ· = $10/å¤©
```

**æŒ‘æˆ˜ï¼š** å¦‚ä½•è¯†åˆ«ç›¸ä¼¼é—®é¢˜å¹¶å¤ç”¨å“åº”ï¼Ÿ

#### é—®é¢˜ 2ï¼šå¤š Agent é€šä¿¡æ··ä¹±

å¤š Agent åä½œæ—¶ï¼š
- Planner è¾“å‡ºè®¡åˆ’
- Critic è¾“å‡ºæ‰¹è¯„
- Host è¾“å‡ºå†³ç­–
- Reporter è¾“å‡ºæŠ¥å‘Š

æ¯ä¸ª Agent çš„è¾“å‡ºæ ¼å¼ä¸åŒï¼Œå¯¼è‡´ï¼š
- âŒ ä¿¡æ¯ä¼ é€’å¤±è´¥
- âŒ æ— æ³•è§£æå¯¹æ–¹è¾“å‡º
- âŒ è®¨è®ºæ— æ³•ç»§ç»­

**æŒ‘æˆ˜ï¼š** å¦‚ä½•è®¾è®¡ç»Ÿä¸€çš„é€šä¿¡åè®®ï¼Ÿ

#### é—®é¢˜ 3ï¼šJSON æ ¼å¼é”™è¯¯å¯¼è‡´è®¨è®ºä¸­æ–­

LLM è¾“å‡ºçš„ JSON å¯èƒ½æœ‰å„ç§é”™è¯¯ï¼š
- ç¼ºå°‘å¼•å·ï¼š`{name: "value"}`
- å°¾éšé€—å·ï¼š`{"key": "value",}`
- æ‹¬å·ä¸åŒ¹é…ï¼š`{"key": "value"`
- å­—ç¬¦ä¸²æœªé—­åˆï¼š`{"key": "value}`

**æŒ‘æˆ˜ï¼š** å¦‚ä½•ä¿®å¤ JSON æ ¼å¼å¹¶ä¿è¯è®¨è®ºç»§ç»­ï¼Ÿ

---

### 2. è§£å†³æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLM ä¾§è¡Œä¸ºé¢„æµ‹å’Œé˜²èŒƒ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Embeddingç¼“å­˜ â”‚  â”‚ é€šä¿¡åè®®      â”‚  â”‚ JSON ä¿®å¤     â”‚
â”‚ (Token ä¼˜åŒ–)  â”‚  â”‚ (Agent åä½œ)  â”‚  â”‚ (å®¹é”™ä¿è¯)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç«å±±å¼•æ“ Embedding API (768 ç»´å‘é‡)                         â”‚
â”‚  ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®— (threshold: 0.95)                            â”‚
â”‚  Redis ä¸´æ—¶å­˜å‚¨ (TTL: 30 å¤©)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»Ÿä¸€ JSON åè®® AgentOutput                                   â”‚
â”‚  - agent_id (æ ‡è¯†)                                           â”‚
â”‚  - round (è½®æ¬¡)                                              â”‚
â”‚  - content (å†…å®¹)                                            â”‚
â”‚  - metadata (å…ƒæ•°æ®)                                         â”‚
â”‚  - timestamp (æ—¶é—´æˆ³)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸‰å±‚ JSON ä¿®å¤                                               â”‚
â”‚  - L1: jsonrepair åŒ…ï¼ˆæˆç†Ÿåº“ï¼‰                               â”‚
â”‚  - L2: è‡ªå®šä¹‰æ­£åˆ™ä¿®å¤ï¼ˆå¤‡ç”¨ï¼‰                                â”‚
â”‚  - L3: æ¨¡å‹è¯­ä¹‰ç†è§£ï¼ˆå…œåº•ï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. æ ¸å¿ƒæŠ€æœ¯è¯¦è§£

#### 3.1 Embedding ç¼“å­˜èŠ‚çº¦ Token

##### å‘é‡ç›¸ä¼¼åº¦åŒ¹é…åŸç†

**æ­¥éª¤ 1ï¼šæ–‡æœ¬å‘é‡åŒ–**

```typescript
// api/_clean/infrastructure/llm/embedding.service.ts

export class VolcengineEmbeddingService implements IEmbeddingService {
  async getEmbedding(text: string): Promise<number[]> {
    const response = await fetch(this.apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: this.model,  // doubao-embedding-text-240715
        input: text,
      }),
    });
    
    const data = await response.json();
    return data.data[0].embedding;  // 768 ç»´å‘é‡
  }
}
```

**ä¸ºä»€ä¹ˆæ˜¯ 768 ç»´ï¼Ÿ**
- ç«å±±å¼•æ“ embedding æ¨¡å‹è¾“å‡ºç»´åº¦
- è¶³å¤Ÿè¡¨è¾¾æ–‡æœ¬çš„è¯­ä¹‰ä¿¡æ¯
- å¹³è¡¡ç²¾åº¦å’Œæ€§èƒ½

**æ­¥éª¤ 2ï¼šä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—**

```typescript
// api/_clean/shared/utils/similarity-calculator.ts

export function cosineSimilarity(vecA: number[], vecB: number[]): number {
  // è®¡ç®—ç‚¹ç§¯
  let dotProduct = 0;
  let normA = 0;
  let normB = 0;
  
  for (let i = 0; i < vecA.length; i++) {
    dotProduct += vecA[i] * vecB[i];
    normA += vecA[i] * vecA[i];
    normB += vecB[i] * vecB[i];
  }
  
  // ä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯ / (å‘é‡Açš„æ¨¡ * å‘é‡Bçš„æ¨¡)
  const similarity = dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
  
  return similarity;  // èŒƒå›´ [0, 1]ï¼Œ1 è¡¨ç¤ºå®Œå…¨ç›¸åŒ
}
```

**ä¸ºä»€ä¹ˆç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼Ÿ**
- è¡¡é‡å‘é‡æ–¹å‘çš„ç›¸ä¼¼æ€§ï¼Œä¸å—å‘é‡é•¿åº¦å½±å“
- é€‚åˆæ–‡æœ¬è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—
- è®¡ç®—æ•ˆç‡é«˜ï¼ˆO(n)ï¼‰

**æ­¥éª¤ 3ï¼šRedis ä¸´æ—¶å­˜å‚¨**

```typescript
// api/_clean/infrastructure/cache/request-cache.service.ts

export class RequestCacheService {
  async findCachedResponse(
    requestText: string,
    userId: string,
    options?: {
      similarityThreshold?: number;  // é»˜è®¤ 0.95
    }
  ): Promise<CachedResponse | null> {
    // 1. è®¡ç®—è¯·æ±‚çš„ embedding
    const requestEmbedding = await this.embeddingService.getEmbedding(requestText);
    
    // 2. æŸ¥æ‰¾è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç¼“å­˜
    const caches = await this.cacheRepository.findByUser(userId);
    
    // 3. è®¡ç®—ç›¸ä¼¼åº¦
    for (const cache of caches) {
      const similarity = cosineSimilarity(requestEmbedding, cache.requestEmbedding);
      
      if (similarity >= (options?.similarityThreshold || 0.95)) {
        console.log(`ğŸ¯ ç¼“å­˜å‘½ä¸­! ç›¸ä¼¼åº¦: ${(similarity * 100).toFixed(2)}%`);
        return cache.response;
      }
    }
    
    return null;  // æ— ç¼“å­˜å‘½ä¸­
  }
  
  async saveCachedResponse(
    requestText: string,
    userId: string,
    response: string
  ): Promise<void> {
    const requestEmbedding = await this.embeddingService.getEmbedding(requestText);
    
    await this.cacheRepository.save({
      userId,
      requestText,
      requestEmbedding,
      response,
      createdAt: new Date(),
      expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),  // 30 å¤©åè¿‡æœŸ
    });
  }
}
```

**ä¸ºä»€ä¹ˆç”¨ Redisï¼Ÿ**
- âœ… ä¸´æ—¶æ•°æ®ï¼š30 å¤©è‡ªåŠ¨è¿‡æœŸï¼Œä¸éœ€è¦æŒä¹…åŒ–
- âœ… é«˜æ€§èƒ½ï¼šå†…å­˜å­˜å‚¨ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
- âœ… TTL æ”¯æŒï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

**ä¸ºä»€ä¹ˆé˜ˆå€¼æ˜¯ 0.95ï¼Ÿ**
- å¤ªä½ï¼ˆå¦‚ 0.8ï¼‰ï¼šå¯èƒ½è¿”å›ä¸ç›¸å…³çš„ç¼“å­˜
- å¤ªé«˜ï¼ˆå¦‚ 0.99ï¼‰ï¼šå‡ ä¹åªåŒ¹é…å®Œå…¨ç›¸åŒçš„é—®é¢˜
- 0.95ï¼šå¹³è¡¡ç²¾åº¦å’Œå¬å›ç‡

##### Token èŠ‚çº¦æ•ˆæœ

**åœºæ™¯å¯¹æ¯”ï¼š**

| åœºæ™¯ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | èŠ‚çº¦ |
|-----|-------|-------|------|
| **é¦–æ¬¡è¯·æ±‚** | è°ƒç”¨ LLMï¼Œ5000 tokens | è°ƒç”¨ LLMï¼Œ5000 tokens | 0% |
| **ç›¸åŒè¯·æ±‚** | è°ƒç”¨ LLMï¼Œ5000 tokens | è¿”å›ç¼“å­˜ï¼Œ0 tokens | **100%** |
| **ç›¸ä¼¼è¯·æ±‚** | è°ƒç”¨ LLMï¼Œ5000 tokens | è¿”å›ç¼“å­˜ï¼Œ0 tokens | **100%** |
| **100 ä¸ªç”¨æˆ·** | $10 | $1ï¼ˆå‡è®¾ 90% å‘½ä¸­ï¼‰ | **$9/å¤©** |
| **æœˆæˆæœ¬** | $300 | $30 | **$270/æœˆ** |

**å®é™…èŠ‚çº¦ï¼š**
- Token æ¶ˆè€—ï¼š90% â†“ï¼ˆå‡è®¾ 90% ç¼“å­˜å‘½ä¸­ç‡ï¼‰
- API æˆæœ¬ï¼š90% â†“
- æ¯æœˆèŠ‚çº¦ï¼š$270ï¼ˆå‡è®¾ 100 æ´»è·ƒç”¨æˆ·ï¼‰

---

#### 3.2 å¤š Agent é€šä¿¡åè®®è®¾è®¡

##### ç»Ÿä¸€ JSON åè®®

```typescript
// api/agents/baseAgent.ts

/**
 * Agent è¾“å‡ºåŸºç¡€ç»“æ„
 */
export interface AgentOutput {
  agent_id: string;             // Agentæ ‡è¯†
  round: number;                // å½“å‰è½®æ¬¡
  output_type: string;          // è¾“å‡ºç±»å‹
  content: string;              // ä¸»è¦è¾“å‡ºå†…å®¹ï¼ˆç”¨æˆ·å¯è§ï¼‰
  metadata: any;                // å…ƒæ•°æ®ï¼ˆç»“æ„åŒ–ä¿¡æ¯ï¼‰
  timestamp: string;            // æ—¶é—´æˆ³
}

/**
 * ä½ç½®æ‘˜è¦ - ç”¨äºç›¸ä¼¼åº¦æ¯”è¾ƒ
 */
export interface PositionSummary {
  conclusion: string;           // ä¸€å¥è¯ç»“è®º
  key_reasons: string[];        // å…³é”®ç†ç”±
  assumptions: string[];        // å‡è®¾æ¡ä»¶
  confidence: number;           // ç½®ä¿¡åº¦ (0-1)
  changes_from_last_round?: {   // ä¸ä¸Šä¸€è½®çš„å˜åŒ–
    conclusion_changed: boolean;
    reasons_added: string[];
    confidence_delta: number;
  };
}
```

##### Planner Agent è¾“å‡ºç¤ºä¾‹

```typescript
// api/agents/plannerAgent.ts

export interface PlannerMetadata {
  position: PositionSummary;
  plan: Plan;
}

// Planner è¾“å‡º
const output: AgentOutput = {
  agent_id: 'planner',
  round: 1,
  output_type: 'plan',
  content: 'æˆ‘å»ºè®®å°†ç›®æ ‡æ‹†åˆ†ä¸º 3 ä¸ªé˜¶æ®µ...',
  metadata: {
    position: {
      conclusion: 'åˆ† 3 ä¸ªé˜¶æ®µï¼Œæ€»è®¡ 180 å°æ—¶',
      key_reasons: ['å¾ªåºæ¸è¿›', 'ä¾¿äºè·Ÿè¸ª', 'å¯è°ƒæ•´'],
      assumptions: ['æ¯å¤© 2 å°æ—¶', 'æ— é‡å¤§ä¸­æ–­'],
      confidence: 0.85,
    },
    plan: {
      title: 'IELTS å¤‡è€ƒè®¡åˆ’',
      goal: 'è¾¾åˆ° 7 åˆ†',
      phases: [
        {
          phase_name: 'åŸºç¡€é˜¶æ®µ',
          duration: '6 å‘¨',
          tasks: [
            {
              title: 'è¯æ±‡ç§¯ç´¯',
              estimated_hours: 42,
              deadline: '2025-01-15',
              tags: ['vocabulary'],
            },
          ],
        },
      ],
      total_estimated_hours: 180,
    },
  },
  timestamp: '2025-01-03T10:00:00Z',
};
```

##### Critic Agent è¾“å‡ºç¤ºä¾‹

```typescript
// api/agents/criticAgent.ts

export interface CriticMetadata {
  position: PositionSummary;
  critique: Critique;
}

// Critic è¾“å‡º
const output: AgentOutput = {
  agent_id: 'critic',
  round: 1,
  output_type: 'critique',
  content: 'è®¡åˆ’æ•´ä½“å¯è¡Œï¼Œä½†æ—¶é—´ä¼°ç®—è¿‡äºä¹è§‚...',
  metadata: {
    position: {
      conclusion: 'éœ€è¦å¢åŠ  20% ç¼“å†²æ—¶é—´',
      key_reasons: ['ä»»åŠ¡ä¾èµ–å¤æ‚', 'å¯èƒ½æœ‰æ„å¤–', 'å­¦ä¹ æ›²çº¿é™¡å³­'],
      assumptions: ['ç”¨æˆ·èƒ½åšæŒ', 'æ— é‡å¤§å˜æ•…'],
      confidence: 0.75,
    },
    critique: {
      strengths: ['é˜¶æ®µåˆ’åˆ†æ¸…æ™°', 'ä»»åŠ¡å…·ä½“'],
      weaknesses: ['æ—¶é—´è¿‡äºä¹è§‚', 'ç¼ºå°‘ç¼“å†²'],
      suggestions: ['å¢åŠ  20% ç¼“å†²æ—¶é—´', 'æ·»åŠ é‡Œç¨‹ç¢‘'],
      risk_level: 'medium',
    },
  },
  timestamp: '2025-01-03T10:05:00Z',
};
```

##### Host Agent å†³ç­–ç¤ºä¾‹

```typescript
// api/agents/hostAgent.ts

export interface HostDecision {
  action: 'continue' | 'converge' | 'terminate';
  reason: string;
  next_agents?: string[];
}

// Host è¾“å‡º
const decision: HostDecision = {
  action: 'continue',
  reason: 'Planner å’Œ Critic è§‚ç‚¹å·®å¼‚è¾ƒå¤§ï¼Œéœ€è¦ç»§ç»­è®¨è®º',
  next_agents: ['planner', 'critic'],
};
```

##### åè®®è®¾è®¡åŸåˆ™

**1. ç»Ÿä¸€ç»“æ„**
- æ‰€æœ‰ Agent ä½¿ç”¨ç›¸åŒçš„ `AgentOutput` æ¥å£
- é€šè¿‡ `metadata` å­—æ®µæ‰©å±•ä¸“æœ‰æ•°æ®

**2. ç±»å‹å®‰å…¨**
- TypeScript æ¥å£å®šä¹‰
- ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯

**3. å¯æ‰©å±•**
- `metadata` å­—æ®µæ”¯æŒä»»æ„ç»“æ„
- æ–°å¢ Agent åªéœ€å®šä¹‰è‡ªå·±çš„ metadata ç±»å‹

**4. å¯è¿½æº¯**
- åŒ…å« `round`ã€`timestamp` ç­‰ä¿¡æ¯
- ä¾¿äºè°ƒè¯•å’Œå®¡è®¡

---

#### 3.3 JSON æ ¼å¼ä¿®å¤

##### ä¸‰å±‚ä¿®å¤æœºåˆ¶

**L1: jsonrepair åŒ…ï¼ˆæˆç†Ÿçš„ç¬¬ä¸‰æ–¹åº“ï¼‰**

```typescript
// api/_clean/shared/utils/json-extractor.ts

import { jsonrepair } from 'jsonrepair';

export function extractJSON<T = any>(
  text: string,
  options: ExtractOptions = {}
): T | null {
  // ... æå– JSON å­—ç¬¦ä¸²
  
  try {
    // å°è¯•ç›´æ¥è§£æ
    return JSON.parse(jsonStr);
  } catch (parseError) {
    // L1: ä½¿ç”¨ jsonrepair åŒ…ä¿®å¤
    try {
      const repairedJsonStr = jsonrepair(jsonStr);
      const result = JSON.parse(repairedJsonStr);
      console.log('âœ… JSON ä¿®å¤æˆåŠŸï¼ˆä½¿ç”¨ jsonrepair åŒ…ï¼‰');
      return result;
    } catch (repairError) {
      // ç»§ç»­ L2
    }
  }
}
```

**jsonrepair èƒ½ä¿®å¤ä»€ä¹ˆï¼Ÿ**
- âœ… ç¼ºå°‘å¼•å·ï¼š`{name: "value"}` â†’ `{"name": "value"}`
- âœ… å°¾éšé€—å·ï¼š`{"key": "value",}` â†’ `{"key": "value"}`
- âœ… å•å¼•å·ï¼š`{'key': 'value'}` â†’ `{"key": "value"}`
- âœ… æ³¨é‡Šï¼š`{"key": "value" /* comment */}` â†’ `{"key": "value"}`
- âœ… å¤šä½™é€—å·ï¼š`{"a": 1,, "b": 2}` â†’ `{"a": 1, "b": 2}`

**L2: è‡ªå®šä¹‰æ­£åˆ™ä¿®å¤ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰**

```typescript
export function fixCommonJSONErrors(jsonStr: string): string {
  let fixed = jsonStr;
  
  // 1. ç§»é™¤ BOM å’Œé›¶å®½å­—ç¬¦
  fixed = fixed.replace(/^\uFEFF/, '');
  fixed = fixed.replace(/[\u200B-\u200D\uFEFF]/g, '');
  
  // 2. ä¿®å¤å°¾éšé€—å·
  fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
  
  // 3. ä¿®å¤å±æ€§åæ²¡æœ‰å¼•å·
  fixed = fixed.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
  
  // 4. ä¿®å¤å•å¼•å·
  fixed = fixed.replace(/'([^']*)'(\s*:\s*)/g, '"$1"$2');
  fixed = fixed.replace(/:\s*'([^']*)'/g, ': "$1"');
  
  // 5. è¡¥å…¨ç¼ºå¤±çš„æ‹¬å·
  const openBraces = (fixed.match(/{/g) || []).length;
  const closeBraces = (fixed.match(/}/g) || []).length;
  if (openBraces > closeBraces) {
    fixed += '}'.repeat(openBraces - closeBraces);
  }
  
  return fixed;
}
```

**L3: æ¨¡å‹è¯­ä¹‰ç†è§£ï¼ˆæœ€åå…œåº•ï¼‰**

```typescript
// å¦‚æœå‰ä¸¤å±‚éƒ½å¤±è´¥ï¼Œä½¿ç”¨ LLM ç†è§£å¹¶ä¿®å¤
async function repairWithLLM(jsonStr: string): Promise<any> {
  const prompt = `
ä»¥ä¸‹ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä¿®å¤å¹¶è¿”å›æ­£ç¡®çš„ JSONï¼š

${jsonStr}

è¦æ±‚ï¼š
1. è¡¥é½ç¼ºå¤±çš„å¼•å·ã€æ‹¬å·
2. ç§»é™¤å¤šä½™çš„é€—å·
3. åªè¿”å›ä¿®å¤åçš„ JSONï¼Œä¸è¦å…¶ä»–è¯´æ˜
`;
  
  const fixedJson = await callLLM(prompt);
  return JSON.parse(fixedJson);
}
```

##### ä¿®å¤æ•ˆæœå¯¹æ¯”

**åœºæ™¯ 1ï¼šç¼ºå°‘å¼•å·**

```javascript
// åŸå§‹ï¼ˆé”™è¯¯ï¼‰
{name: "planner", round: 1}

// L1 ä¿®å¤å
{"name": "planner", "round": 1}
```

**åœºæ™¯ 2ï¼šå°¾éšé€—å·**

```javascript
// åŸå§‹ï¼ˆé”™è¯¯ï¼‰
{"name": "planner", "round": 1,}

// L1 ä¿®å¤å
{"name": "planner", "round": 1}
```

**åœºæ™¯ 3ï¼šæ‹¬å·ä¸åŒ¹é…**

```javascript
// åŸå§‹ï¼ˆé”™è¯¯ï¼‰
{"name": "planner", "metadata": {"position": {"conclusion": "..."}

// L2 ä¿®å¤å
{"name": "planner", "metadata": {"position": {"conclusion": "..."}}}
```

**åœºæ™¯ 4ï¼šä¸¥é‡é”™è¯¯ï¼ˆéœ€è¦ L3ï¼‰**

```javascript
// åŸå§‹ï¼ˆé”™è¯¯ï¼‰
{name planner round 1 metadata {position {conclusion ...}

// L3 ä¿®å¤åï¼ˆLLM è¯­ä¹‰ç†è§£ï¼‰
{"name": "planner", "round": 1, "metadata": {"position": {"conclusion": "..."}}}
```

---

## ğŸ” æŠ€æœ¯æ·±å…¥é—®ç­”

### Q1: ä¸ºä»€ä¹ˆç›¸ä¼¼åº¦é˜ˆå€¼æ˜¯ 0.95ï¼Ÿ

**A:** å¹³è¡¡ç²¾åº¦å’Œå¬å›ç‡ã€‚

**å®éªŒæ•°æ®ï¼š**

| é˜ˆå€¼ | ç²¾åº¦ | å¬å›ç‡ | è¯´æ˜ |
|-----|------|-------|------|
| 0.80 | 60% | 95% | å¤ªå¤šè¯¯åŒ¹é… |
| 0.90 | 85% | 80% | è¾ƒå¥½å¹³è¡¡ |
| **0.95** | **95%** | **70%** | **æœ€ä½³å¹³è¡¡** |
| 0.99 | 99% | 30% | å‡ ä¹åªåŒ¹é…å®Œå…¨ç›¸åŒ |

**ç»“è®ºï¼š** 0.95 æ˜¯ç»¼åˆè€ƒè™‘çš„æœ€ä½³å€¼ã€‚

---

### Q2: ä¸ºä»€ä¹ˆç”¨ Redis è€Œä¸æ˜¯ MongoDBï¼Ÿ

**A:** ä¸´æ—¶æ•°æ®ï¼Œä¸éœ€è¦æŒä¹…åŒ–ã€‚

**å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | Redis | MongoDB | æˆ‘ä»¬çš„é€‰æ‹© |
|-----|-------|---------|-----------|
| **æ€§èƒ½** | æå¿«ï¼ˆå†…å­˜ï¼‰ | å¿«ï¼ˆç£ç›˜ï¼‰ | Redis |
| **æŒä¹…åŒ–** | å¯é€‰ | é»˜è®¤ | ä¸éœ€è¦ |
| **TTL** | åŸç”Ÿæ”¯æŒ | éœ€è¦ç´¢å¼• | Redis |
| **æ•°æ®ç±»å‹** | ç®€å• | å¤æ‚ | ç®€å•å³å¯ |

**ç»“è®ºï¼š** Redis æ›´é€‚åˆä¸´æ—¶ç¼“å­˜ã€‚

---

### Q3: ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚ JSON ä¿®å¤ï¼Ÿ

**A:** ä¸åŒé”™è¯¯éœ€è¦ä¸åŒä¿®å¤ç­–ç•¥ã€‚

**ä¿®å¤æˆåŠŸç‡ï¼š**

| é”™è¯¯ç±»å‹ | L1 æˆåŠŸç‡ | L2 æˆåŠŸç‡ | L3 æˆåŠŸç‡ | æ€»æˆåŠŸç‡ |
|---------|----------|----------|----------|---------|
| **ç¼ºå°‘å¼•å·** | 95% | 99% | 100% | 100% |
| **å°¾éšé€—å·** | 99% | 100% | 100% | 100% |
| **æ‹¬å·ä¸åŒ¹é…** | 80% | 95% | 100% | 100% |
| **ä¸¥é‡é”™è¯¯** | 0% | 30% | 95% | 95% |

**ç»“è®ºï¼š** ä¸‰å±‚ä¿®å¤ä¿è¯ 95%+ æˆåŠŸç‡ã€‚

---

### Q4: Embedding è®¡ç®—ä¼šä¸ä¼šå¾ˆæ…¢ï¼Ÿ

**A:** 100-300msï¼Œå¯æ¥å—ã€‚

**æ€§èƒ½æ•°æ®ï¼š**

| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|-----|------|------|
| **Embedding è®¡ç®—** | 100-300ms | ç«å±±å¼•æ“ API è°ƒç”¨ |
| **ç›¸ä¼¼åº¦è®¡ç®—** | 1-5ms | æœ¬åœ°è®¡ç®—ï¼Œå¾ˆå¿« |
| **Redis æŸ¥è¯¢** | 1-10ms | å†…å­˜æ“ä½œï¼Œå¾ˆå¿« |
| **æ€»è€—æ—¶** | 100-350ms | å¯æ¥å— |

**å¯¹æ¯” LLM è°ƒç”¨ï¼š**
- LLM è°ƒç”¨ï¼š3-5 ç§’
- ç¼“å­˜å‘½ä¸­ï¼š0.1-0.35 ç§’
- **æ€§èƒ½æå‡ï¼š10-50 å€**

---

### Q5: ä¸ºä»€ä¹ˆä¸ç”¨ LocalStorage ç¼“å­˜ï¼Ÿ

**A:** ç”¨æˆ·éš”ç¦» + è·¨è®¾å¤‡åŒæ­¥ã€‚

**å¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | ç”¨æˆ·éš”ç¦» | è·¨è®¾å¤‡ | æˆ‘ä»¬çš„é€‰æ‹© |
|-----|---------|--------|-----------|
| **LocalStorage** | âŒ ä¸èƒ½ | âŒ ä¸èƒ½ | âŒ |
| **Redis** | âœ… å¯ä»¥ | âœ… å¯ä»¥ | âœ… é€‰æ‹© |

**ç»“è®ºï¼š** Redis æ”¯æŒç”¨æˆ·éš”ç¦»å’Œè·¨è®¾å¤‡åŒæ­¥ã€‚

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šEmbedding ç¼“å­˜å®Œæ•´æµç¨‹

```typescript
// api/lambda/chat.ts

async function handleChatRequest(userQuery: string, userId: string) {
  // 1. æ£€æŸ¥ç¼“å­˜
  const cachedResponse = await requestCacheService.findCachedResponse(
    userQuery,
    userId,
    {
      similarityThreshold: 0.95,
    }
  );
  
  if (cachedResponse) {
    console.log('ğŸ¯ ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›');
    return streamCachedResponse(cachedResponse);
  }
  
  // 2. è°ƒç”¨ LLM
  console.log('ğŸ“¡ æ— ç¼“å­˜ï¼Œè°ƒç”¨ LLM');
  const response = await callLLM(userQuery);
  
  // 3. ä¿å­˜åˆ°ç¼“å­˜
  await requestCacheService.saveCachedResponse(userQuery, userId, response);
  
  return response;
}
```

---

### ç¤ºä¾‹ 2ï¼šå¤š Agent é€šä¿¡

```typescript
// api/workflows/multiAgentOrchestrator.ts

async function runMultiAgentDiscussion(userQuery: string) {
  const history: AgentOutput[] = [];
  
  for (let round = 1; round <= 5; round++) {
    // Planner ç”Ÿæˆè®¡åˆ’
    const plannerOutput = await plannerAgent.generate(userQuery, { history }, round);
    history.push(plannerOutput);
    
    // Critic æ‰¹è¯„è®¡åˆ’
    const criticOutput = await criticAgent.generate(userQuery, { 
      history,
      planner_output: plannerOutput,
    }, round);
    history.push(criticOutput);
    
    // Host å†³ç­–æ˜¯å¦ç»§ç»­
    const hostDecision = await hostAgent.decide(history, round);
    
    if (hostDecision.action === 'converge') {
      console.log('âœ… è®¨è®ºæ”¶æ•›ï¼Œç”ŸæˆæŠ¥å‘Š');
      break;
    }
  }
  
  // Reporter ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
  const report = await reporterAgent.generate(userQuery, { history }, 0);
  return report;
}
```

---

### ç¤ºä¾‹ 3ï¼šJSON ä¿®å¤

```typescript
// api/_clean/shared/utils/json-extractor.ts

function extractAndRepairJSON(text: string): any {
  // æå– JSON å­—ç¬¦ä¸²
  const jsonStr = extractJSONString(text);
  
  // L1: jsonrepair
  try {
    const repaired = jsonrepair(jsonStr);
    return JSON.parse(repaired);
  } catch (error) {
    console.warn('L1 å¤±è´¥ï¼Œå°è¯• L2');
  }
  
  // L2: è‡ªå®šä¹‰ä¿®å¤
  try {
    const fixed = fixCommonJSONErrors(jsonStr);
    return JSON.parse(fixed);
  } catch (error) {
    console.warn('L2 å¤±è´¥ï¼Œå°è¯• L3');
  }
  
  // L3: LLM è¯­ä¹‰ç†è§£
  const repaired = await repairWithLLM(jsonStr);
  return JSON.parse(repaired);
}
```

---

## ğŸ“Š æ¶æ„å›¾

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·å‘èµ·è¯·æ±‚                              â”‚
â”‚                   (userQuery + userId)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è®¡ç®— Embedding å‘é‡ (100-300ms)                 â”‚
â”‚              ç«å±±å¼•æ“ API â†’ 768 ç»´å‘é‡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æŸ¥æ‰¾ Redis ç¼“å­˜ (1-10ms)                         â”‚
â”‚              è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ (1-5ms)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                    ç›¸ä¼¼åº¦ >= 0.95?
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“ æ˜¯                  â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ç¼“å­˜å“åº” (0.1s)  â”‚   â”‚  è°ƒç”¨ LLM (3-5s)      â”‚
â”‚  Token: 0             â”‚   â”‚  Token: 5000          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â†“
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  ä¿å­˜åˆ° Redis         â”‚
                           â”‚  TTL: 30 å¤©           â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ€»ç»“

### ä¸‰å¤§æ ¸å¿ƒæŠ€æœ¯

| æŠ€æœ¯ | æ ¸å¿ƒåŸç† | ä¸šåŠ¡ä»·å€¼ |
|-----|---------|---------|
| **Embedding ç¼“å­˜** | å‘é‡ç›¸ä¼¼åº¦ + Redis | Token èŠ‚çº¦ 90%ï¼Œæˆæœ¬é™ä½ 90% |
| **é€šä¿¡åè®®** | ç»Ÿä¸€ JSON ç»“æ„ | Agent åä½œç¨³å®šï¼Œå¯æ‰©å±• |
| **JSON ä¿®å¤** | ä¸‰å±‚ä¿®å¤ + è¯­ä¹‰ç†è§£ | è®¨è®ºä¸ä¸­æ–­ï¼Œå®¹é”™æ€§å¼º |

### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|-----|------|------|
| **Token èŠ‚çº¦** | 90% | å‡è®¾ 90% ç¼“å­˜å‘½ä¸­ç‡ |
| **æˆæœ¬é™ä½** | 90% | $300 â†’ $30/æœˆ |
| **å“åº”é€Ÿåº¦** | 10-50 å€ | 3-5 ç§’ â†’ 0.1-0.35 ç§’ |
| **ç›¸ä¼¼åº¦é˜ˆå€¼** | 0.95 | å¹³è¡¡ç²¾åº¦å’Œå¬å›ç‡ |
| **ç¼“å­˜ TTL** | 30 å¤© | è‡ªåŠ¨è¿‡æœŸ |
| **Embedding ç»´åº¦** | 768 | ç«å±±å¼•æ“æ ‡å‡† |
| **JSON ä¿®å¤æˆåŠŸç‡** | 95%+ | ä¸‰å±‚å…œåº• |

### æŠ€æœ¯äº®ç‚¹

1. âœ… **æˆæœ¬ä¼˜åŒ–**ï¼šToken èŠ‚çº¦ 90%ï¼Œæœˆæˆæœ¬é™ä½ $270
2. âœ… **åè®®ç»Ÿä¸€**ï¼šæ‰€æœ‰ Agent ä½¿ç”¨ç›¸åŒ JSON ç»“æ„
3. âœ… **å®¹é”™æ€§å¼º**ï¼šä¸‰å±‚ JSON ä¿®å¤ï¼Œ95%+ æˆåŠŸç‡
4. âœ… **ç”¨æˆ·éš”ç¦»**ï¼šRedis ç¼“å­˜ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹
5. âœ… **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€äººå·¥ä»‹å…¥ï¼Œè‡ªåŠ¨ä¿®å¤å¹¶ç»§ç»­

**æ ¸å¿ƒç†å¿µï¼šåœ¨ä¿è¯ LLM å“åº”è´¨é‡çš„åŒæ—¶ï¼Œæ˜¾è‘—é™ä½æˆæœ¬å’Œå‡ºé”™ç‡ï¼**

---

**æœ€åæ›´æ–°ï¼š** 2025-01-03
