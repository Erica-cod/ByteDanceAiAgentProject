# ğŸ¨ è®¡åˆ’å¡ç‰‡æ¸²æŸ“ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

`update_plan` å·¥å…·æ‰§è¡ŒæˆåŠŸåï¼ŒAIè¿”å›çš„è®¡åˆ’æ•°æ®**æ˜¾ç¤ºä¸ºJSONæ–‡æœ¬**ï¼Œè€Œä¸æ˜¯æ¼‚äº®çš„**è®¡åˆ’å¡ç‰‡**ã€‚

### ç”¨æˆ·çœ‹åˆ°çš„

```
### ä¸‰ã€æ›´æ–°åè®¡åˆ’è¯¦æƒ…ï¼ˆ8ä¸ªæœˆç‰ˆï¼‰
```json
{
  "plan_id": "cdbc3b7b-0b30-476e-9792-5161e0f4dbba",
  "title": "8ä¸ªæœˆIELTS7åˆ†å¤‡è€ƒè®¡åˆ’",
  "goal": "8ä¸ªæœˆå†…é›…æ€æ€»åˆ†è¾¾åˆ°7åˆ†ï¼ˆå°åˆ†ä¸ä½äº6.5ï¼‰",
  ...
}
```
```

âŒ JSONä»¥çº¯æ–‡æœ¬æ˜¾ç¤ºï¼Œæ²¡æœ‰æ¸²æŸ“æˆå¡ç‰‡

---

## ğŸ” æ ¹æœ¬åŸå› 

### 1. **åªè¯†åˆ« `create_plan`**

`extractPlanData` å‡½æ•°ï¼ˆç¬¬293è¡Œï¼‰ï¼š

```typescript
// âŒ æ—§ä»£ç ï¼šåªæ£€æŸ¥ create_plan
if (text.includes('"tool"') && text.includes('create_plan')) {
```

**é—®é¢˜ï¼š**
- `update_plan` è¿”å›çš„JSONè¢«å¿½ç•¥
- `get_plan` è¿”å›çš„JSONä¹Ÿè¢«å¿½ç•¥
- å‰ç«¯æ— æ³•è¯†åˆ«è¿™äº›å·¥å…·çš„ç»“æœ

### 2. **æ— æ³•ä»Markdownä»£ç å—æå–**

AIç»å¸¸æŠŠè®¡åˆ’æ•°æ®æ”¾åœ¨ ```json ... ``` ä»£ç å—ä¸­ï¼Œä½†æå–é€»è¾‘æ²¡æœ‰ä¸“é—¨å¤„ç†è¿™ç§æƒ…å†µã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1ï¼š**æ”¯æŒæ‰€æœ‰è®¡åˆ’å·¥å…·**

```typescript
// âœ… æ–°ä»£ç ï¼šæ”¯æŒæ‰€æœ‰è®¡åˆ’å·¥å…·
const isValidTool = ['create_plan', 'update_plan', 'get_plan'].includes(planData.tool);

if (isValidTool && planData.title && planData.goal && planData.tasks) {
  return planData;
}

// âœ… ä¹Ÿæ”¯æŒæ²¡æœ‰toolå­—æ®µçš„çº¯è®¡åˆ’æ•°æ®
if (!planData.tool && planData.plan_id && planData.title && planData.goal) {
  return planData;
}
```

### ä¿®å¤2ï¼š**ä»Markdownä»£ç å—æå–**

```typescript
// âœ… æ–°å¢ï¼šä» ```json ... ``` ä»£ç å—ä¸­æå–
const codeBlockMatch = text.match(/```(?:json)?\s*\n?(\{[\s\S]*?\})\s*\n?```/);
if (codeBlockMatch) {
  const jsonStr = codeBlockMatch[1].trim();
  const planData = JSON.parse(jsonStr);
  
  if (planData.plan_id && planData.title && planData.goal) {
    return planData;  // âœ… æ¸²æŸ“æˆå¡ç‰‡
  }
}
```

### ä¿®å¤3ï¼š**æ”¾å®½æ£€æµ‹æ¡ä»¶**

```typescript
// âŒ æ—§ï¼šåªæ£€æŸ¥ create_plan
if (text.includes('"tool"') && text.includes('create_plan')) {

// âœ… æ–°ï¼šæ£€æŸ¥é€šç”¨çš„è®¡åˆ’æ ‡è¯†
const hasPlanIndicators = text.includes('"tool"') || 
                          text.includes('plan_id') || 
                          text.includes('"title"');
if (hasPlanIndicators) {
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
âœ… update_plan å·¥å…·æ‰§è¡ŒæˆåŠŸ
ğŸ“¤ AIè¾“å‡ºï¼š
   ```json
   { "plan_id": "...", "title": "...", ... }
   ```

âŒ å‰ç«¯ï¼šæ˜¾ç¤ºä¸ºçº¯æ–‡æœ¬JSON
```

### ä¿®å¤å

```
âœ… update_plan å·¥å…·æ‰§è¡ŒæˆåŠŸ
ğŸ“¤ AIè¾“å‡ºï¼š
   ```json
   { "plan_id": "...", "title": "...", ... }
   ```

âœ… å‰ç«¯ï¼š
   ğŸ” ä»Markdownä»£ç å—ä¸­æå–è®¡åˆ’æ•°æ®
   ğŸ¨ æ¸²æŸ“æˆæ¼‚äº®çš„è®¡åˆ’å¡ç‰‡
```

---

## ğŸ¯ æ”¯æŒçš„åœºæ™¯

ç°åœ¨å‰ç«¯å¯ä»¥è¯†åˆ«å¹¶æ¸²æŸ“ï¼š

### 1. **create_plan ç»“æœ**
```json
{
  "tool": "create_plan",
  "title": "IELTSå¤‡è€ƒè®¡åˆ’",
  "goal": "è¾¾åˆ°7åˆ†",
  "tasks": [...]
}
```
âœ… æ¸²æŸ“æˆå¡ç‰‡

### 2. **update_plan ç»“æœ**
```json
{
  "tool": "update_plan",  
  "plan_id": "cdbc3b7b-...",
  "title": "8ä¸ªæœˆIELTS7åˆ†å¤‡è€ƒè®¡åˆ’",
  "goal": "8ä¸ªæœˆå†…è¾¾åˆ°7åˆ†",
  "tasks": [...]
}
```
âœ… æ¸²æŸ“æˆå¡ç‰‡ â† **æœ¬æ¬¡ä¿®å¤**

### 3. **get_plan ç»“æœ**
```json
{
  "tool": "get_plan",
  "plan_id": "...",
  "title": "...",
  "tasks": [...]
}
```
âœ… æ¸²æŸ“æˆå¡ç‰‡

### 4. **çº¯è®¡åˆ’æ•°æ®ï¼ˆæ— toolå­—æ®µï¼‰**
```json
{
  "plan_id": "...",
  "title": "...",
  "goal": "...",
  "tasks": [...]
}
```
âœ… æ¸²æŸ“æˆå¡ç‰‡ â† **æ–°å¢æ”¯æŒ**

### 5. **Markdownä»£ç å—ä¸­çš„è®¡åˆ’**
````markdown
```json
{
  "plan_id": "...",
  "title": "...",
  ...
}
```
````
âœ… æ¸²æŸ“æˆå¡ç‰‡ â† **æ–°å¢æ”¯æŒ**

---

## ğŸ” æå–ä¼˜å…ˆçº§

ç°åœ¨çš„æå–é€»è¾‘æŒ‰ä»¥ä¸‹é¡ºåºï¼š

1. **ä» `<tool_result>` æ ‡ç­¾æå–** ï¼ˆæœ€ä¼˜å…ˆï¼‰
2. **ä» Markdown ä»£ç å—æå–** ï¼ˆæ–°å¢ï¼‰
3. **ç›´æ¥æœç´¢JSONå¯¹è±¡** ï¼ˆå…œåº•ï¼‰

è¿™ç¡®ä¿äº†æ— è®ºAIä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡ºï¼Œéƒ½èƒ½è¢«æ­£ç¡®è¯†åˆ«ï¼

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

- **`src/components/PlanCard.tsx`**
  - æ”¯æŒ `update_plan`ã€`get_plan`
  - æ”¯æŒçº¯è®¡åˆ’æ•°æ®ï¼ˆæ— toolå­—æ®µï¼‰
  - æ–°å¢ä»Markdownä»£ç å—æå–çš„é€»è¾‘
  - æ”¾å®½æ£€æµ‹æ¡ä»¶ï¼ˆä¸å†é™åˆ¶åªæœ‰create_planï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **æµ‹è¯•update_planæ¸²æŸ“**
   - æ›´æ–°è®¡åˆ’åï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºä¸ºå¡ç‰‡

2. **æµ‹è¯•ä»£ç å—æ ¼å¼**
   - AIåœ¨ ```json ä¸­è¾“å‡ºè®¡åˆ’
   - åº”è¯¥èƒ½è¯†åˆ«å¹¶æ¸²æŸ“

3. **æµ‹è¯•çº¯æ•°æ®æ ¼å¼**
   - AIç›´æ¥è¾“å‡ºæ²¡æœ‰toolå­—æ®µçš„è®¡åˆ’JSON
   - åº”è¯¥èƒ½è¯†åˆ«å¹¶æ¸²æŸ“

---

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œå‰ç«¯çš„è®¡åˆ’è¯†åˆ«èƒ½åŠ›å¤§å¤§å¢å¼ºï¼š

- âœ… æ”¯æŒæ‰€æœ‰è®¡åˆ’å·¥å…·ï¼ˆcreate/update/getï¼‰
- âœ… æ”¯æŒMarkdownä»£ç å—æ ¼å¼
- âœ… æ”¯æŒçº¯è®¡åˆ’æ•°æ®æ ¼å¼
- âœ… æ›´å®½æ¾çš„æ£€æµ‹æ¡ä»¶

ç°åœ¨ç”¨æˆ·æ— è®ºå¦‚ä½•æ›´æ–°è®¡åˆ’ï¼Œéƒ½èƒ½çœ‹åˆ°æ¼‚äº®çš„å¡ç‰‡è€Œä¸æ˜¯æ¯ç‡¥çš„JSONï¼ğŸš€

