# å®Œæ•´çš„å¤§æ–‡æœ¬å¤„ç†æ–¹æ¡ˆ

## ğŸ¯ æ–¹æ¡ˆæ¦‚è§ˆ

ä¸€ä¸ªç«¯åˆ°ç«¯çš„å¤§æ–‡æœ¬å¤„ç†è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
1. **ä¸Šä¼ é˜¶æ®µ**ï¼šæ¸è¿›å¼ä¸Šä¼ ï¼ˆå‹ç¼© + å¯é€‰åˆ†ç‰‡ï¼‰
2. **å­˜å‚¨é˜¶æ®µ**ï¼šæ™ºèƒ½å­˜å‚¨ï¼ˆå®Œæ•´å†…å®¹ + é¢„è§ˆï¼‰
3. **æ˜¾ç¤ºé˜¶æ®µ**ï¼šæ¸è¿›å¼åŠ è½½ï¼ˆæŒ‰éœ€ä»åç«¯è·å–ï¼‰

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·è¾“å…¥å¤§æ–‡æœ¬                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 1: æ¸è¿›å¼ä¸Šä¼                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æµ‹æ–‡æœ¬å¤§å°                                                 â”‚
â”‚   â”œâ”€ <10KB    â†’ ç›´æ¥ä¸Šä¼                                     â”‚
â”‚   â”œâ”€ 10KB-5MB â†’ å‹ç¼©ä¸Šä¼  âœ… æ¨è                            â”‚
â”‚   â”œâ”€ 5MB-10MB â†’ å‹ç¼© + åˆ¤æ–­æ˜¯å¦åˆ†ç‰‡                         â”‚
â”‚   â””â”€ >10MB    â†’ è­¦å‘Šç”¨æˆ· + å‹ç¼©åˆ†ç‰‡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 2: åç«¯å¤„ç†ä¸å­˜å‚¨                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¥æ”¶æ•°æ®                                                     â”‚
â”‚   â”œâ”€ å¦‚æœæ˜¯å‹ç¼©çš„ â†’ è§£å‹                                    â”‚
â”‚   â””â”€ å¦‚æœæ˜¯åˆ†ç‰‡çš„ â†’ åˆå¹¶                                    â”‚
â”‚                                                              â”‚
â”‚ å­˜å‚¨åˆ°æ•°æ®åº“                                                 â”‚
â”‚   â”œâ”€ content          â†’ å®Œæ•´å†…å®¹ï¼ˆ1MBï¼‰                     â”‚
â”‚   â”œâ”€ content_preview  â†’ å‰ 1000 å­—ç¬¦ âœ… æ–°å¢               â”‚
â”‚   â””â”€ content_length   â†’ å®Œæ•´é•¿åº¦ âœ… æ–°å¢                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 3: åˆ‡æ¢å¯¹è¯åŠ è½½                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API è¿”å›æ¶ˆæ¯åˆ—è¡¨                                             â”‚
â”‚   â”œâ”€ é»˜è®¤åªè¿”å› content_previewï¼ˆ1000 å­—ç¬¦ï¼‰âœ…             â”‚
â”‚   â””â”€ ä¸è¿”å›å®Œæ•´ contentï¼ˆèŠ‚çœ 95% ä¼ è¾“é‡ï¼‰                  â”‚
â”‚                                                              â”‚
â”‚ å‰ç«¯æ¸²æŸ“                                                     â”‚
â”‚   â””â”€ æ˜¾ç¤ºé¢„è§ˆå†…å®¹ï¼ˆå¿«é€Ÿï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 4: æ¸è¿›å¼å±•å¼€ï¼ˆç”¨æˆ·ä¸»åŠ¨ï¼‰                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·ç‚¹å‡»"åŠ è½½ä¸‹ä¸€å—"                                         â”‚
â”‚   â†“                                                          â”‚
â”‚ GET /api/messages/:id/content?start=1000&length=1000        â”‚
â”‚   â†“                                                          â”‚
â”‚ è¿”å›: ç¬¬ 1000-2000 å­—ç¬¦                                     â”‚
â”‚   â†“                                                          â”‚
â”‚ å‰ç«¯æ‹¼æ¥æ˜¾ç¤º                                                 â”‚
â”‚   â†“                                                          â”‚
â”‚ ç”¨æˆ·ç»§ç»­ç‚¹å‡»æˆ–é€‰æ‹©"å…¨éƒ¨å±•å¼€"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å®æ–½æ–¹æ¡ˆ

### ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸Šä¼ é˜¶æ®µï¼ˆæ¸è¿›å¼ä¸Šä¼ ï¼‰

#### 1.1 é˜ˆå€¼é…ç½®

```typescript
// src/constants/uploadThresholds.ts (æ–°å»º)

export const UPLOAD_THRESHOLDS = {
  // ç›´æ¥ä¸Šä¼ ï¼š< 10KB
  DIRECT_UPLOAD_MAX: 10 * 1024,
  
  // å‹ç¼©ä¸Šä¼ ï¼š10KB - 5MB
  COMPRESSION_MAX: 5 * 1024 * 1024,
  
  // å‹ç¼©åå¦‚æœ > 5MB æ‰åˆ†ç‰‡
  COMPRESSED_CHUNK_THRESHOLD: 5 * 1024 * 1024,
  
  // ç»å¯¹ä¸Šé™ï¼š10MB
  ABSOLUTE_MAX: 10 * 1024 * 1024,
  
  // åˆ†ç‰‡å¤§å°ï¼š100KB
  CHUNK_SIZE: 100 * 1024,
} as const;
```

#### 1.2 å‹ç¼©å·¥å…·

```typescript
// src/utils/compression.ts (æ–°å»º)

/**
 * å‹ç¼©æ–‡æœ¬
 */
export async function compressText(text: string): Promise<Blob> {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  
  // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ CompressionStream API
  const stream = new Blob([data]).stream();
  const compressedStream = stream.pipeThrough(
    new CompressionStream('gzip')
  );
  
  const blob = await new Response(compressedStream).blob();
  
  const ratio = ((1 - blob.size / data.length) * 100).toFixed(1);
  console.log(`ğŸ“¦ å‹ç¼©ç‡: ${ratio}%`);
  
  return blob;
}

/**
 * æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒå‹ç¼©
 */
export function isCompressionSupported(): boolean {
  return typeof CompressionStream !== 'undefined';
}
```

#### 1.3 åˆ†ç‰‡ä¸Šä¼ å™¨ï¼ˆæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰

```typescript
// src/utils/chunkUploader.ts (æ–°å»º)

export class ChunkUploader {
  private static readonly CHUNK_SIZE = 100 * 1024; // 100KB
  
  /**
   * ä¸Šä¼ å¤§ Blobï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
   */
  static async uploadLargeBlob(
    blob: Blob,
    userId: string,
    onProgress?: (percent: number) => void,
    existingSessionId?: string  // âœ… æ–­ç‚¹ç»­ä¼ 
  ): Promise<string> {
    const totalChunks = Math.ceil(blob.size / this.CHUNK_SIZE);
    
    let sessionId: string;
    let uploadedChunks: number[] = [];
    
    // âœ… æ£€æŸ¥å·²æœ‰ä¼šè¯
    if (existingSessionId) {
      const status = await this.getUploadStatus(existingSessionId);
      if (status && !status.isComplete) {
        sessionId = existingSessionId;
        uploadedChunks = status.uploadedChunks;
        console.log(`ğŸ“¦ ç»­ä¼ : ${uploadedChunks.length}/${totalChunks}`);
      } else {
        sessionId = await this.createSession(userId, totalChunks, blob.size);
      }
    } else {
      sessionId = await this.createSession(userId, totalChunks, blob.size);
    }
    
    // ä¸Šä¼ åˆ†ç‰‡ï¼ˆè·³è¿‡å·²ä¸Šä¼ çš„ï¼‰
    for (let i = 0; i < totalChunks; i++) {
      if (uploadedChunks.includes(i)) {
        console.log(`â­ï¸ è·³è¿‡åˆ†ç‰‡ ${i}`);
        onProgress?.(Math.round(((i + 1) / totalChunks) * 100));
        continue;
      }
      
      const start = i * this.CHUNK_SIZE;
      const end = Math.min(start + this.CHUNK_SIZE, blob.size);
      const chunk = blob.slice(start, end);
      
      await this.uploadChunkWithRetry(sessionId, i, chunk, 3);
      onProgress?.(Math.round(((i + 1) / totalChunks) * 100));
    }
    
    await this.completeUpload(sessionId);
    return sessionId;
  }
  
  // ... å…¶ä»–æ–¹æ³•ï¼ˆåˆ›å»ºä¼šè¯ã€ä¸Šä¼ åˆ†ç‰‡ã€æŸ¥è¯¢çŠ¶æ€ç­‰ï¼‰
}
```

#### 1.4 ä¸Šä¼ ç­–ç•¥é€‰æ‹©å™¨

```typescript
// src/utils/uploadStrategy.ts (æ–°å»º)

export type UploadStrategy = 
  | 'direct'
  | 'compression'
  | 'chunking'
  | 'too-large';

export function selectUploadStrategy(text: string): {
  strategy: UploadStrategy;
  warning?: string;
  requiresConfirmation: boolean;
} {
  const size = text.length;
  
  // å°æ–‡æœ¬ï¼šç›´æ¥ä¸Šä¼ 
  if (size < UPLOAD_THRESHOLDS.DIRECT_UPLOAD_MAX) {
    return { strategy: 'direct', requiresConfirmation: false };
  }
  
  // è¶…å¤§æ–‡æœ¬ï¼šè­¦å‘Š
  if (size > UPLOAD_THRESHOLDS.ABSOLUTE_MAX) {
    return {
      strategy: 'too-large',
      warning: 'æ–‡æœ¬è¿‡å¤§ï¼Œå»ºè®®ç®€åŒ–å†…å®¹',
      requiresConfirmation: true,
    };
  }
  
  // ä¸­ç­‰æ–‡æœ¬ï¼šå‹ç¼©
  if (size < UPLOAD_THRESHOLDS.COMPRESSION_MAX) {
    return {
      strategy: 'compression',
      warning: 'æ­£åœ¨å‹ç¼©ä¸Šä¼ ...',
      requiresConfirmation: false,
    };
  }
  
  // å¤§æ–‡æœ¬ï¼šå‹ç¼©ååˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†ç‰‡
  const estimatedCompressedSize = size * 0.3;
  if (estimatedCompressedSize < UPLOAD_THRESHOLDS.COMPRESSED_CHUNK_THRESHOLD) {
    return { strategy: 'compression', requiresConfirmation: false };
  }
  
  // å‹ç¼©åä»å¾ˆå¤§ï¼šåˆ†ç‰‡
  return {
    strategy: 'chunking',
    warning: 'æ–‡æœ¬å¾ˆå¤§ï¼Œæ­£åœ¨åˆ†ç‰‡ä¸Šä¼ ...',
    requiresConfirmation: false,
  };
}
```

---

### ç¬¬äºŒéƒ¨åˆ†ï¼šåç«¯å­˜å‚¨ï¼ˆæ•°æ®åº“ Schemaï¼‰

#### 2.1 æ•°æ®åº“ Schema ä¿®æ”¹

```sql
-- api/db/migrations/add_content_preview.sql (æ–°å»º)

-- æ·»åŠ é¢„è§ˆå­—æ®µ
ALTER TABLE messages ADD COLUMN content_preview TEXT;
ALTER TABLE messages ADD COLUMN content_length INT;

-- ä¸ºç°æœ‰æ•°æ®ç”Ÿæˆé¢„è§ˆ
UPDATE messages 
SET 
  content_preview = SUBSTRING(content, 1, 1000),
  content_length = LENGTH(content);

-- æ·»åŠ ç´¢å¼•ï¼ˆå¯é€‰ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX idx_messages_content_length ON messages(content_length);
```

#### 2.2 MessageService ä¿®æ”¹

```typescript
// api/services/messageService.ts (ä¿®æ”¹)

export class MessageService {
  /**
   * æ·»åŠ æ¶ˆæ¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆé¢„è§ˆï¼‰
   */
  static async addMessage(
    conversationId: string,
    userId: string,
    role: 'user' | 'assistant',
    content: string,
    clientMessageId?: string,
    thinking?: string,
    modelType?: 'local' | 'volcano'
  ): Promise<Message> {
    // âœ… ç”Ÿæˆé¢„è§ˆ
    const contentPreview = content.length > 1000 
      ? content.slice(0, 1000)
      : content;
    
    const contentLength = content.length;
    
    const result = await db.query(
      `INSERT INTO messages (
        id, conversation_id, user_id, role, content, 
        content_preview, content_length,
        client_message_id, thinking, model_type
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        id,
        conversationId,
        userId,
        role,
        content,
        contentPreview,
        contentLength,
        clientMessageId,
        thinking,
        modelType,
      ]
    );
    
    return { /* ... */ };
  }
  
  /**
   * è·å–æ¶ˆæ¯åˆ—è¡¨ï¼ˆé»˜è®¤åªè¿”å›é¢„è§ˆï¼‰
   */
  static async getMessages(
    conversationId: string,
    userId: string,
    options: {
      limit?: number;
      skip?: number;
      preview?: boolean;  // âœ… é»˜è®¤ true
    } = {}
  ): Promise<Message[]> {
    const { limit = 50, skip = 0, preview = true } = options;
    
    // âœ… å¦‚æœåªéœ€è¦é¢„è§ˆï¼Œä¸æŸ¥è¯¢å®Œæ•´ content
    const contentField = preview 
      ? 'content_preview AS content'
      : 'content';
    
    const result = await db.query(
      `SELECT 
        id, conversation_id, user_id, role, 
        ${contentField},
        content_length,
        thinking, sources, created_at, model_type
      FROM messages
      WHERE conversation_id = ? AND user_id = ?
      ORDER BY created_at ASC
      LIMIT ? OFFSET ?`,
      [conversationId, userId, limit, skip]
    );
    
    return result.rows.map(row => ({
      id: row.id,
      role: row.role,
      content: row.content,
      contentLength: row.content_length,
      // ...
    }));
  }
  
  /**
   * è·å–æ¶ˆæ¯çš„æŒ‡å®šèŒƒå›´å†…å®¹ï¼ˆæ¸è¿›å¼åŠ è½½ï¼‰
   */
  static async getMessageContentRange(
    messageId: string,
    userId: string,
    start: number,
    length: number
  ): Promise<{
    content: string;
    start: number;
    length: number;
    total: number;
    hasMore: boolean;
  } | null> {
    // ä½¿ç”¨ SQL SUBSTRING
    const result = await db.query(
      `SELECT 
        SUBSTRING(content, ?, ?) AS content_slice,
        LENGTH(content) AS total_length
       FROM messages
       WHERE id = ? AND user_id = ?`,
      [start + 1, length, messageId, userId]
    );
    
    if (result.rows.length === 0) {
      return null;
    }
    
    const row = result.rows[0];
    const totalLength = row.total_length;
    const contentSlice = row.content_slice;
    const actualLength = contentSlice.length;
    const hasMore = start + actualLength < totalLength;
    
    return {
      content: contentSlice,
      start,
      length: actualLength,
      total: totalLength,
      hasMore,
    };
  }
}
```

---

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šåç«¯ API

#### 3.1 ä¸Šä¼ ç›¸å…³ API

```typescript
// api/lambda/upload.ts (æ–°å»º)

/**
 * POST /api/upload/session - åˆ›å»ºä¸Šä¼ ä¼šè¯
 */
export async function post_session({ data }) {
  const { userId, totalChunks, fileSize } = data;
  
  const sessionId = await FileChunkStore.createSession(
    userId,
    totalChunks,
    fileSize
  );
  
  return { sessionId };
}

/**
 * POST /api/upload/chunk - ä¸Šä¼ å•ä¸ªåˆ†ç‰‡
 */
export async function post_chunk({ data }) {
  const { sessionId, chunkIndex, chunk } = data;
  
  await FileChunkStore.saveChunk(sessionId, chunkIndex, chunk);
  
  const uploadedChunks = await FileChunkStore.getUploadedChunks(sessionId);
  
  return {
    success: true,
    uploadedCount: uploadedChunks.length,
  };
}

/**
 * GET /api/upload/status/:sessionId - æŸ¥è¯¢ä¸Šä¼ çŠ¶æ€
 */
export async function get_status({ params }) {
  const { sessionId } = params;
  
  const meta = await FileChunkStore.getSessionMeta(sessionId);
  const uploadedChunks = await FileChunkStore.getUploadedChunks(sessionId);
  const isComplete = await FileChunkStore.isComplete(sessionId);
  
  return {
    sessionId,
    uploadedChunks,
    totalChunks: meta.totalChunks,
    isComplete,
  };
}

/**
 * POST /api/upload/complete - å®Œæˆä¸Šä¼ 
 */
export async function post_complete({ data }) {
  const { sessionId } = data;
  
  const isComplete = await FileChunkStore.isComplete(sessionId);
  if (!isComplete) {
    return {
      status: 400,
      data: { error: 'åˆ†ç‰‡ä¸å®Œæ•´' },
    };
  }
  
  const result = await FileChunkStore.assembleChunks(sessionId);
  
  return {
    success: true,
    totalSize: result.length,
  };
}
```

#### 3.2 æ¶ˆæ¯å†…å®¹ API

```typescript
// api/lambda/messages.ts (æ–°å»º)

/**
 * GET /api/messages/:messageId/content - è·å–æ¶ˆæ¯å†…å®¹ï¼ˆåˆ†æ®µï¼‰
 */
export async function get_content({ params, query }) {
  const { messageId } = params;
  const { userId, start = 0, length = 1000 } = query;
  
  const result = await MessageService.getMessageContentRange(
    messageId,
    userId,
    parseInt(start),
    parseInt(length)
  );
  
  if (!result) {
    return {
      status: 404,
      data: { error: 'æ¶ˆæ¯ä¸å­˜åœ¨' },
    };
  }
  
  return {
    content: result.content,
    start: result.start,
    length: result.length,
    total: result.total,
    hasMore: result.hasMore,
  };
}
```

#### 3.3 Chat API ä¿®æ”¹

```typescript
// api/lambda/chat.ts (ä¿®æ”¹)

import { gunzipAsync } from '../utils/compression';
import { FileChunkStore } from '../services/fileChunkStore';

export async function post({ data }) {
  const {
    message,
    uploadSessionId,  // âœ… æ”¯æŒä¸Šä¼ ä¼šè¯
    isCompressed,
    // ...
  } = data;
  
  let messageText: string;
  
  // âœ… å¤„ç†ä¸åŒçš„ä¸Šä¼ æ–¹å¼
  if (uploadSessionId) {
    // ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–
    const buffer = await FileChunkStore.assembleChunks(uploadSessionId);
    
    // å¦‚æœæ˜¯å‹ç¼©çš„ï¼Œè§£å‹
    if (isCompressed) {
      const decompressed = await gunzipAsync(buffer);
      messageText = decompressed.toString('utf-8');
    } else {
      messageText = buffer.toString('utf-8');
    }
    
    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    await FileChunkStore.cleanupSession(uploadSessionId);
    
  } else if (message) {
    messageText = message;
  } else {
    return {
      status: 400,
      data: { error: 'ç¼ºå°‘ message æˆ– uploadSessionId' },
    };
  }
  
  // åç»­å¤„ç†...
  // æ³¨æ„ï¼šä¿å­˜æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ content_preview
}
```

---

### ç¬¬å››éƒ¨åˆ†ï¼šå‰ç«¯æ˜¾ç¤ºï¼ˆæ¸è¿›å¼åŠ è½½ï¼‰

#### 4.1 æ¸è¿›å¼æ¶ˆæ¯ç»„ä»¶

```typescript
// src/components/ProgressiveMessageServer.tsx (æ–°å»º)

import React, { useState, useCallback } from 'react';
import StreamingMarkdown from './StreamingMarkdown';
import './ProgressiveMessage.css';

interface ProgressiveMessageServerProps {
  messageId: string;
  userId: string;
  initialContent: string;  // é¢„è§ˆå†…å®¹ï¼ˆ1000 å­—ç¬¦ï¼‰
  totalLength: number;     // å®Œæ•´é•¿åº¦
  chunkSize?: number;      // æ¯æ¬¡åŠ è½½å¤§å°
}

export const ProgressiveMessageServer: React.FC<ProgressiveMessageServerProps> = ({
  messageId,
  userId,
  initialContent,
  totalLength,
  chunkSize = 1000,
}) => {
  // å·²åŠ è½½çš„å†…å®¹ç‰‡æ®µ
  const [contentChunks, setContentChunks] = useState<string[]>([initialContent]);
  
  // å½“å‰åŠ è½½åˆ°çš„ä½ç½®
  const [loadedLength, setLoadedLength] = useState(initialContent.length);
  
  // æ˜¯å¦æ­£åœ¨åŠ è½½
  const [isLoading, setIsLoading] = useState(false);
  
  // å®Œæ•´å†…å®¹ï¼ˆæ‹¼æ¥ï¼‰
  const fullContent = contentChunks.join('');
  
  // æ˜¯å¦å·²å…¨éƒ¨åŠ è½½
  const isFullyLoaded = loadedLength >= totalLength;
  
  // è®¡ç®—è¿›åº¦
  const progress = Math.round((loadedLength / totalLength) * 100);
  const remainingLength = totalLength - loadedLength;
  const remainingChunks = Math.ceil(remainingLength / chunkSize);
  
  /**
   * åŠ è½½ä¸‹ä¸€å—
   */
  const loadMore = useCallback(async () => {
    if (isLoading || isFullyLoaded) return;
    
    setIsLoading(true);
    
    try {
      const response = await fetch(
        `/api/messages/${messageId}/content?` +
        `userId=${userId}&start=${loadedLength}&length=${chunkSize}`
      );
      
      if (!response.ok) {
        throw new Error('åŠ è½½å¤±è´¥');
      }
      
      const data = await response.json();
      
      // æ·»åŠ æ–°å†…å®¹
      setContentChunks(prev => [...prev, data.content]);
      setLoadedLength(prev => prev + data.length);
      
      console.log(`âœ… åŠ è½½ ${data.length} å­—ç¬¦`);
    } catch (error) {
      console.error('âŒ åŠ è½½å¤±è´¥:', error);
      alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsLoading(false);
    }
  }, [messageId, userId, loadedLength, chunkSize, isLoading, isFullyLoaded]);
  
  /**
   * åŠ è½½å‰©ä½™æ‰€æœ‰
   */
  const loadAll = useCallback(async () => {
    if (isLoading || isFullyLoaded) return;
    
    setIsLoading(true);
    
    try {
      const remaining = totalLength - loadedLength;
      const chunks = Math.ceil(remaining / chunkSize);
      
      // å¹¶å‘åŠ è½½æ‰€æœ‰å‰©ä½™å—
      const requests = [];
      for (let i = 0; i < chunks; i++) {
        const start = loadedLength + i * chunkSize;
        const length = Math.min(chunkSize, totalLength - start);
        
        requests.push(
          fetch(
            `/api/messages/${messageId}/content?` +
            `userId=${userId}&start=${start}&length=${length}`
          ).then(res => res.json())
        );
      }
      
      const results = await Promise.all(requests);
      const newChunks = results.map(r => r.content);
      
      setContentChunks(prev => [...prev, ...newChunks]);
      setLoadedLength(totalLength);
      
      console.log(`âœ… å…¨éƒ¨åŠ è½½å®Œæˆ`);
    } catch (error) {
      console.error('âŒ åŠ è½½å…¨éƒ¨å¤±è´¥:', error);
      alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsLoading(false);
    }
  }, [messageId, userId, loadedLength, chunkSize, totalLength, isLoading, isFullyLoaded]);
  
  /**
   * æ”¶èµ·
   */
  const collapse = useCallback(() => {
    setContentChunks([contentChunks[0]]);
    setLoadedLength(contentChunks[0].length);
  }, [contentChunks]);
  
  return (
    <div className="progressive-message">
      {/* å†…å®¹ */}
      <div className="progressive-content">
        <StreamingMarkdown content={fullContent} />
      </div>
      
      {/* åŠ è½½ä¸­ */}
      {isLoading && (
        <div className="loading-indicator">
          <div className="spinner"></div>
          <span>åŠ è½½ä¸­...</span>
        </div>
      )}
      
      {/* æ§åˆ¶åŒº */}
      {!isFullyLoaded && !isLoading && (
        <div className="progressive-controls">
          {/* è¿›åº¦æ¡ */}
          <div className="progress-bar-container">
            <div 
              className="progress-bar-fill" 
              style={{ width: `${progress}%` }}
            />
            <span className="progress-text">{progress}%</span>
          </div>
          
          {/* ç»Ÿè®¡ */}
          <div className="progressive-stats">
            <span className="stat-item">
              å·²åŠ è½½: {loadedLength.toLocaleString()} / {totalLength.toLocaleString()}
            </span>
          </div>
          
          {/* æŒ‰é’® */}
          <div className="progressive-actions">
            <button 
              className="progressive-btn primary"
              onClick={loadMore}
            >
              åŠ è½½ä¸‹ä¸€å—
              <span className="btn-info">+{Math.min(chunkSize, remainingLength)} å­—ç¬¦</span>
            </button>
            
            <button 
              className="progressive-btn secondary"
              onClick={loadAll}
            >
              å…¨éƒ¨åŠ è½½
              <span className="btn-info">{remainingChunks} å—</span>
            </button>
          </div>
        </div>
      )}
      
      {/* å·²å…¨éƒ¨åŠ è½½ */}
      {isFullyLoaded && loadedLength > initialContent.length && (
        <div className="progressive-controls">
          <div className="progressive-stats">
            <span className="stat-item success">
              âœ… å·²åŠ è½½å®Œæ•´å†…å®¹
            </span>
          </div>
          
          <button 
            className="progressive-btn secondary"
            onClick={collapse}
          >
            æ”¶èµ·
          </button>
        </div>
      )}
    </div>
  );
};
```

#### 4.2 MessageList é›†æˆ

```typescript
// src/components/MessageList.tsx (ä¿®æ”¹)

import { ProgressiveMessageServer } from './ProgressiveMessageServer';

// åœ¨ rowRenderer ä¸­
<div className="message-text">
  {message.content ? (
    message.role === 'assistant' ? (
      // âœ… å¦‚æœæœ‰å®Œæ•´é•¿åº¦ä¿¡æ¯ï¼Œä½¿ç”¨æ¸è¿›å¼åŠ è½½
      message.contentLength && message.contentLength > 1000 ? (
        <ProgressiveMessageServer
          messageId={message.id}
          userId={userId}
          initialContent={message.content}  // é¢„è§ˆå†…å®¹
          totalLength={message.contentLength}
          chunkSize={1000}
        />
      ) : (
        <StreamingMarkdown content={message.content} />
      )
    ) : (
      message.content
    )
  ) : (
    'æ­£åœ¨æ€è€ƒ...'
  )}
</div>
```

---

## ğŸ“Š å®Œæ•´æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·å‘é€ 5MB æ–‡æœ¬

```
1. ç”¨æˆ·ç²˜è´´ 5MB æ–‡æœ¬åˆ°è¾“å…¥æ¡†
   â†“
2. å‰ç«¯æ£€æµ‹: 5MB â†’ é€‰æ‹©"å‹ç¼©ä¸Šä¼ "ç­–ç•¥
   â†“
3. å‹ç¼©: 5MB â†’ 1.5MB (å‹ç¼©ç‡ 70%)
   â†“
4. ä¸Šä¼ : POST /api/chat (body: 1.5MB å‹ç¼©æ•°æ®)
   è€—æ—¶: 3 ç§’ (500KB/s ç½‘ç»œ)
   â†“
5. åç«¯è§£å‹: 1.5MB â†’ 5MB
   è€—æ—¶: 0.5 ç§’
   â†“
6. ä¿å­˜åˆ°æ•°æ®åº“:
   - content: 5MB å®Œæ•´æ–‡æœ¬
   - content_preview: å‰ 1000 å­—ç¬¦
   - content_length: 5242880
   â†“
7. è¿”å›å“åº”ç»™ç”¨æˆ·ï¼ˆæ­£å¸¸ SSE æµï¼‰
```

### åœºæ™¯ï¼šç”¨æˆ·åˆ‡æ¢åˆ°è¯¥å¯¹è¯

```
1. ç”¨æˆ·ç‚¹å‡»å¯¹è¯
   â†“
2. å‰ç«¯: GET /api/conversations/:id/messages?preview=true
   â†“
3. åç«¯: åªè¿”å› content_preview (1000 å­—ç¬¦)
   ä¼ è¾“é‡: 50KB (è€Œä¸æ˜¯ 5MB)
   è€—æ—¶: 0.1 ç§’ âœ…
   â†“
4. å‰ç«¯æ¸²æŸ“é¢„è§ˆå†…å®¹
   æ¸²æŸ“æ—¶é—´: 0.1 ç§’ âœ…
   â†“
5. æ˜¾ç¤º"åŠ è½½æ›´å¤š"æŒ‰é’®
```

### åœºæ™¯ï¼šç”¨æˆ·å±•å¼€å†…å®¹

```
1. ç”¨æˆ·ç‚¹å‡»"åŠ è½½ä¸‹ä¸€å—"
   â†“
2. GET /api/messages/:id/content?start=1000&length=1000
   â†“
3. è¿”å›: ç¬¬ 1000-2000 å­—ç¬¦
   è€—æ—¶: 0.5 ç§’
   â†“
4. å‰ç«¯æ‹¼æ¥æ˜¾ç¤º (0-2000 å­—ç¬¦)
   æ¸²æŸ“æ—¶é—´: 0.1 ç§’
   â†“
5. ç”¨æˆ·ç»§ç»­ç‚¹å‡»æˆ–é€‰æ‹©"å…¨éƒ¨åŠ è½½"
   â†“
6. å…¨éƒ¨åŠ è½½: å¹¶å‘è¯·æ±‚å‰©ä½™æ‰€æœ‰å—
   è€—æ—¶: 2-3 ç§’
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿæ–¹æ¡ˆ | å®Œæ•´æ–¹æ¡ˆ | æå‡ |
|------|---------|---------|------|
| **ä¸Šä¼  5MB** | 10 ç§’ | 3.5 ç§’ | **3 å€** |
| **åˆ‡æ¢å¯¹è¯** | 10-15 ç§’ | 0.2 ç§’ | **50-75 å€** |
| **é¦–å±æ¸²æŸ“** | 5 ç§’ | 0.1 ç§’ | **50 å€** |
| **å±•å¼€ä¸€å—** | - | 0.6 ç§’ | âœ… æµç•… |
| **ç½‘ç»œä¼ è¾“** | 5MB | 50KB | **100 å€** |

---

## ğŸ’» ä»£ç é‡ä¼°ç®—

### å‰ç«¯

| æ–‡ä»¶ | ä»£ç é‡ | è¯´æ˜ |
|------|--------|------|
| `uploadThresholds.ts` | 30 è¡Œ | é˜ˆå€¼é…ç½® |
| `compression.ts` | 50 è¡Œ | å‹ç¼©å·¥å…· |
| `chunkUploader.ts` | 300 è¡Œ | åˆ†ç‰‡ä¸Šä¼ å™¨ |
| `uploadStrategy.ts` | 150 è¡Œ | ç­–ç•¥é€‰æ‹© |
| `ProgressiveMessageServer.tsx` | 250 è¡Œ | æ¸è¿›å¼æ˜¾ç¤º |
| `ProgressiveMessage.css` | 150 è¡Œ | æ ·å¼ |
| `useSSEStream.ts` ä¿®æ”¹ | +150 è¡Œ | é›†æˆä¸Šä¼  |
| `MessageList.tsx` ä¿®æ”¹ | +30 è¡Œ | é›†æˆæ˜¾ç¤º |
| **å‰ç«¯å°è®¡** | **~1,110 è¡Œ** | - |

### åç«¯

| æ–‡ä»¶ | ä»£ç é‡ | è¯´æ˜ |
|------|--------|------|
| æ•°æ®åº“è¿ç§» SQL | 20 è¡Œ | Schema ä¿®æ”¹ |
| `fileChunkStore.ts` | 350 è¡Œ | æ–‡ä»¶å­˜å‚¨ |
| `messageService.ts` ä¿®æ”¹ | +200 è¡Œ | é¢„è§ˆ+åˆ†æ®µ |
| `upload.ts` | 200 è¡Œ | ä¸Šä¼  API |
| `messages.ts` | 100 è¡Œ | å†…å®¹ API |
| `chat.ts` ä¿®æ”¹ | +80 è¡Œ | é›†æˆ |
| **åç«¯å°è®¡** | **~950 è¡Œ** | - |

### æ€»è®¡

**~2,060 è¡Œä»£ç **

---

## â±ï¸ å®æ–½æ—¶é—´è¡¨

### Week 1: ä¸Šä¼ ä¼˜åŒ–ï¼ˆ5 å¤©ï¼‰

```
Day 1-2: åŸºç¡€æ¶æ„
  - é˜ˆå€¼é…ç½®
  - ç­–ç•¥é€‰æ‹©å™¨
  - å‹ç¼©å·¥å…·

Day 3-4: åˆ†ç‰‡ä¸Šä¼ 
  - fileChunkStore.ts
  - upload.ts API
  - å‰ç«¯é›†æˆ

Day 5: æµ‹è¯•ä¼˜åŒ–
  - ç«¯åˆ°ç«¯æµ‹è¯•
  - æ€§èƒ½æµ‹è¯•
```

### Week 2: å­˜å‚¨å’Œæ˜¾ç¤ºä¼˜åŒ–ï¼ˆ4 å¤©ï¼‰

```
Day 1: æ•°æ®åº“ä¿®æ”¹
  - Schema è¿ç§»
  - MessageService ä¿®æ”¹
  - æ•°æ®è¿ç§»è„šæœ¬

Day 2-3: æ¸è¿›å¼æ˜¾ç¤º
  - ProgressiveMessageServer.tsx
  - messages.ts API
  - MessageList é›†æˆ

Day 4: æµ‹è¯•ä¼˜åŒ–
  - ç«¯åˆ°ç«¯æµ‹è¯•
  - æ€§èƒ½æµ‹è¯•
  - UI/UX ä¼˜åŒ–
```

### æ€»è®¡ï¼š**9 å¤©**

---

## ğŸ¯ åˆ†é˜¶æ®µå®æ–½ï¼ˆæ¨èï¼‰

### é˜¶æ®µ 1: ä¸Šä¼ ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

```
å®æ–½: Week 1
æ”¶ç›Š: ç«‹å³è§æ•ˆ
å½±å“: è§£å†³ç”¨æˆ·ä¸Šä¼ æ…¢çš„é—®é¢˜
```

### é˜¶æ®µ 2: æ˜¾ç¤ºä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ä¸­ç­‰ï¼‰

```
å®æ–½: Week 2
æ”¶ç›Š: ç«‹å³è§æ•ˆ
å½±å“: è§£å†³åˆ‡æ¢å¯¹è¯æ…¢çš„é—®é¢˜
```

### è§‚å¯ŸæœŸ: ç›‘æ§æ•°æ®

```
æ—¶é•¿: 2-4 å‘¨
ç›‘æ§:
  - ä¸Šä¼ æˆåŠŸç‡
  - å¹³å‡ä¸Šä¼ æ—¶é—´
  - åˆ‡æ¢å¯¹è¯åŠ è½½æ—¶é—´
  - ç”¨æˆ·å±•å¼€è¡Œä¸º
```

---

## ğŸ“ æ€»ç»“

### å®Œæ•´æ–¹æ¡ˆä¼˜åŠ¿

1. **ç«¯åˆ°ç«¯ä¼˜åŒ–**ï¼šä»ä¸Šä¼ åˆ°æ˜¾ç¤ºå…¨æµç¨‹ä¼˜åŒ–
2. **æ€§èƒ½æå‡æ˜¾è‘—**ï¼š50-100 å€æ€§èƒ½æå‡
3. **ç”¨æˆ·ä½“éªŒä¼˜ç§€**ï¼šæ¸è¿›å¼ï¼Œå¯æ§
4. **å®æ–½å¯æ§**ï¼šåˆ†é˜¶æ®µï¼Œå¯è§‚æµ‹

### æ ¸å¿ƒæŠ€æœ¯

- âœ… å‹ç¼©ä¸Šä¼ ï¼ˆå‡å°‘ 70-80% ä¼ è¾“é‡ï¼‰
- âœ… åˆ†ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
- âœ… é¢„è§ˆå­˜å‚¨ï¼ˆå‡å°‘ 95% æŸ¥è¯¢é‡ï¼‰
- âœ… æŒ‰éœ€åŠ è½½ï¼ˆæ¸è¿›å¼å±•å¼€ï¼‰

### æŠ•å…¥äº§å‡ºæ¯”

- ä»£ç é‡ï¼š~2,060 è¡Œ
- å·¥ä½œé‡ï¼š9 å¤©
- æ”¶ç›Šï¼š50-100 å€æ€§èƒ½æå‡
- ROIï¼šâ­â­â­â­â­

---

**ä½œè€…**: AI Assistant  
**æ—¥æœŸ**: 2024-12-30  
**ç‰ˆæœ¬**: 1.0.0

