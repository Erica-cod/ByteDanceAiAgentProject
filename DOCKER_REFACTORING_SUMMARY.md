# Docker é…ç½®é‡æ„æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Dockerfile æ‹†åˆ†

æˆåŠŸå°†åŸæ¥çš„å•ä¸€ Dockerfile æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„æœåŠ¡ Dockerfileï¼š

```
dockerfiles/
â”œâ”€â”€ app.Dockerfile      # ä¸»åº”ç”¨æœåŠ¡ (Modern.js)
â”œâ”€â”€ idp.Dockerfile      # IDP è®¤è¯æœåŠ¡ (OIDC Provider)
â””â”€â”€ README.md           # è¯¦ç»†æ–‡æ¡£
```

### 2. Docker Compose é…ç½®æ›´æ–°

#### å¼€å‘ç¯å¢ƒ (`docker-compose.yml`)
- âœ… æ·»åŠ äº† IDP æœåŠ¡é…ç½®
- âœ… æ›´æ–°äº† app æœåŠ¡ä½¿ç”¨æ–°çš„ Dockerfile
- âœ… é…ç½®äº†æœåŠ¡ä¾èµ–å…³ç³»
- âœ… æ·»åŠ äº†å¥åº·æ£€æŸ¥

#### ç”Ÿäº§ç¯å¢ƒ (`docker-compose.prod.yml`)
- âœ… æ›´æ–°æ‰€æœ‰æœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„ Dockerfile
- âœ… é…ç½®æ„å»ºä¸Šä¸‹æ–‡å’Œé•œåƒæ ‡ç­¾
- âœ… å®Œæ•´çš„æœåŠ¡ç¼–æ’ï¼ˆRedisã€MongoDBã€Ollamaã€IDPã€Appï¼‰

### 3. é…ç½®æ–‡ä»¶åˆ›å»º

- âœ… `deploy/env.example` - ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿
- âœ… `DOCKER_MIGRATION_GUIDE.md` - è¯¦ç»†çš„è¿ç§»æŒ‡å—
- âœ… `dockerfiles/README.md` - Dockerfile ä½¿ç”¨æ–‡æ¡£

### 4. æˆåŠŸå¯åŠ¨çš„æœåŠ¡

| æœåŠ¡ | çŠ¶æ€ | ç«¯å£ | è¯´æ˜ |
|------|------|------|------|
| **App** | âœ… è¿è¡Œæ­£å¸¸ | 8080 | Modern.js ä¸»åº”ç”¨ |
| **Redis** | âœ… è¿è¡Œæ­£å¸¸ | 6379 | ç¼“å­˜å’Œä¼šè¯å­˜å‚¨ |
| **MongoDB** | âœ… è¿è¡Œæ­£å¸¸ | 27017 | ä¸»æ•°æ®åº“ï¼ˆmongodb-globalï¼‰ |
| **IDP** | âš ï¸ éƒ¨åˆ†é—®é¢˜ | 9000 | OIDC è®¤è¯æœåŠ¡ï¼ˆè§ä¸‹æ–¹ï¼‰ |

### 5. Bug ä¿®å¤

- âœ… ä¿®å¤äº† MongoDB è¿æ¥é—®é¢˜ï¼ˆå®¹å™¨å‘½åå’Œç½‘ç»œé…ç½®ï¼‰
- âœ… ä¿®å¤äº† MongoDB ç´¢å¼•åˆ›å»ºé”™è¯¯ï¼ˆ`partialFilterExpression` ä¸æ”¯æŒ `$ne`ï¼‰
- âœ… æ›´æ–°äº† `.dockerignore` ä¼˜åŒ–é•œåƒå¤§å°

---

## âš ï¸ IDP æœåŠ¡å·²çŸ¥é—®é¢˜

### é—®é¢˜æè¿°

IDP æœåŠ¡åœ¨ Docker å®¹å™¨ä¸­é‡åˆ°ä¾èµ–å†²çªé”™è¯¯ï¼š

```
TypeError: getGeneratorFunction is not a function
    at isGeneratorFunction (/app/node_modules/is-generator-function/index.js:29:26)
    at Application.use (/app/node_modules/koa/lib/application.js:130:9)
    at Provider.initializeApp (file:///app/node_modules/oidc-provider/lib/helpers/initialize_app.js:222:12)
```

### æ ¹æœ¬åŸå› 

è¿™æ˜¯ `oidc-provider` + `koa` + `is-generator-function` åŒ…åœ¨ Docker ç¯å¢ƒä¸­çš„å·²çŸ¥å…¼å®¹æ€§é—®é¢˜ã€‚ä¸»è¦åŸå› ï¼š
1. `is-generator-function@1.0.x` åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•æ­£ç¡®æ£€æµ‹ç”Ÿæˆå™¨å‡½æ•°
2. Node.js 20 çš„æ¨¡å—è§£ææœºåˆ¶ä¸è¿™äº›æ—§ç‰ˆæœ¬åŒ…å­˜åœ¨å†²çª
3. åœ¨æœ¬åœ°ç¯å¢ƒè¿è¡Œæ­£å¸¸ï¼Œä½†åœ¨ Docker éš”ç¦»ç¯å¢ƒä¸­ä¼šè§¦å‘æ­¤é—®é¢˜

### å°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆ

1. âŒ ä½¿ç”¨ Node.js 18 â†’ é¡¹ç›®ä¾èµ–éœ€è¦ Node.js 20+
2. âŒ å®‰è£…æœ€æ–°ç‰ˆ `is-generator-function` â†’ ä»ç„¶æŠ¥é”™
3. âŒ ä»…å®‰è£…ç”Ÿäº§ä¾èµ– â†’ tsx ä¾èµ–æ ‘ä¸å®Œæ•´
4. âŒ å®‰è£…å®Œæ•´ä¾èµ– â†’ ä¾èµ–å†²çªä¾ç„¶å­˜åœ¨

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆé€‰é¡¹

### æ–¹æ¡ˆ 1ï¼šæœ¬åœ°è¿è¡Œ IDPï¼ˆæ¨èç”¨äºå¼€å‘ï¼‰

å¦‚æœåªæ˜¯å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼Œå¯ä»¥åœ¨å®¿ä¸»æœºæœ¬åœ°è¿è¡Œ IDPï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
npm run dev:idp
```

**ä¼˜ç‚¹ï¼š**
- é¿å… Docker ç¯å¢ƒé—®é¢˜
- å¼€å‘è°ƒè¯•æ›´æ–¹ä¾¿
- å¯åŠ¨é€Ÿåº¦å¿«

**ç¼ºç‚¹ï¼š**
- éœ€è¦æœ¬åœ°å®‰è£… Node.js å’Œä¾èµ–
- ä¸æ˜¯å®Œå…¨çš„å®¹å™¨åŒ–éƒ¨ç½²

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨é¢„æ„å»ºçš„ IDP é•œåƒ

å¦‚æœæœ‰å·²ç»éªŒè¯å¯ç”¨çš„ IDP é•œåƒï¼Œå¯ä»¥åœ¨ `docker-compose.yml` ä¸­ç›´æ¥ä½¿ç”¨ï¼š

```yaml
idp:
  image: your-registry/bytedance-idp:stable
  # ä¸éœ€è¦ build é…ç½®
```

### æ–¹æ¡ˆ 3ï¼šä¿®å¤ä¾èµ–ç‰ˆæœ¬ï¼ˆéœ€è¦ä¿®æ”¹ package.jsonï¼‰

åœ¨ `package.json` ä¸­æ·»åŠ  `overrides` (npm 8.3+) æˆ– `resolutions` (yarn)ï¼š

```json
{
  "overrides": {
    "is-generator-function": "^1.0.10",
    "has-symbols": "^1.1.0"
  }
}
```

ç„¶åé‡æ–°æ„å»ºï¼š
```bash
npm install
docker-compose build --no-cache idp
docker-compose up -d idp
```

### æ–¹æ¡ˆ 4ï¼šæš‚æ—¶è·³è¿‡ IDPï¼ˆå¦‚æœä¸éœ€è¦è®¤è¯ï¼‰

å¦‚æœé¡¹ç›®å½“å‰ä¸éœ€è¦ OIDC è®¤è¯ï¼Œå¯ä»¥æš‚æ—¶ä¸å¯åŠ¨ IDP æœåŠ¡ï¼š

```bash
# åªå¯åŠ¨ä¸»åº”ç”¨å’ŒåŸºç¡€æœåŠ¡
docker-compose up -d app redis

# æˆ–è€…ä» docker-compose.yml ä¸­æ³¨é‡Šæ‰ IDP æœåŠ¡
```

---

## ğŸ“‹ å½“å‰æœåŠ¡æ¶æ„

### å¼€å‘ç¯å¢ƒç½‘ç»œæ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         shared-network (bridge)          â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Redis      â”‚   â”‚   MongoDB      â”‚ â”‚
â”‚  â”‚   :6379      â”‚   â”‚   :27017       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                   â–²           â”‚
â”‚         â”‚                   â”‚           â”‚
â”‚         â”‚                   â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ IDP (å¾…ä¿®å¤)â”‚      â”‚     App      â”‚ â”‚
â”‚  â”‚  :9000     â”‚â—„â”€â”€â”€â”€â”€â”‚    :8080     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                             â–²          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  Ollama (Host) â”‚
                      â”‚   :11434       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é•œåƒä¿¡æ¯

| é•œåƒ | å¤§å° | è¯´æ˜ |
|------|------|------|
| `bytedanceaiagentproject-app` | 1.56GB | åŒ…å« Modern.js å‰ç«¯å’Œ BFF API |
| `bytedanceaiagentproject-idp` | 1.03GB | OIDC è®¤è¯æœåŠ¡ï¼ˆå¾…ä¿®å¤ï¼‰ |
| `redis:7-alpine` | 60.7MB | Redis ç¼“å­˜ |
| `mongo:7` | 1.14GB | MongoDB æ•°æ®åº“ |
| `ollama/ollama` | 5.82GB | AI æ¨¡å‹æœåŠ¡ |

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### å¯åŠ¨ä¸»è¦æœåŠ¡ï¼ˆä¸å« IDPï¼‰

```bash
# 1. å¯åŠ¨ MongoDBï¼ˆå¦‚æœè¿˜æ²¡è¿è¡Œï¼‰
docker run -d --name mongodb-global --network shared-network -p 27017:27017 mongo:7

# 2. å¯åŠ¨åº”ç”¨æœåŠ¡
docker-compose up -d app redis

# 3. éªŒè¯æœåŠ¡
docker-compose ps
curl http://localhost:8080  # ä¸»åº”ç”¨
```

### æœ¬åœ°è¿è¡Œ IDP

```bash
# åœ¨æ–°çš„ç»ˆç«¯çª—å£
npm run dev:idp

# éªŒè¯ IDP
curl http://localhost:9000/.well-known/openid-configuration
```

### å®Œæ•´å¯åŠ¨ï¼ˆå¾… IDP ä¿®å¤åï¼‰

```bash
docker-compose up -d
```

---

## ğŸ§¹ æ¸…ç†æ—§é•œåƒ

```powershell
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# åˆ é™¤æ—§çš„ bytedance-ai-agent é•œåƒï¼ˆtag 5-19ï¼‰
docker images | Select-String "bytedance-ai-agent" | ForEach-Object {
    $line = $_ -split '\s+'
    $repo = $line[0]
    $tag = $line[1]
    if ($tag -ne "latest") {
        Write-Host "åˆ é™¤: $repo:$tag"
        docker rmi "$repo:$tag" -f
    }
}

# æ¸…ç†æ‚¬ç©ºé•œåƒ
docker image prune -f

# æ¸…ç†æ„å»ºç¼“å­˜
docker builder prune -f
```

---

## ğŸ“Š é¡¹ç›®æ”¹è¿›æ•ˆæœ

### ä¼˜åŠ¿

âœ… **æ¨¡å—åŒ–** - æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çš„ Dockerfileï¼Œæ˜“äºç»´æŠ¤  
âœ… **å¯æ‰©å±•** - æ–°æœåŠ¡å¯ä»¥ç‹¬ç«‹æ·»åŠ å’Œé…ç½®  
âœ… **æ„å»ºæ•ˆç‡** - ç¼“å­˜ä¼˜åŒ–ï¼Œå¢é‡æ„å»ºæ›´å¿«  
âœ… **éƒ¨ç½²çµæ´»** - å¯ä»¥é€‰æ‹©æ€§éƒ¨ç½²æœåŠ¡  
âœ… **ç‰ˆæœ¬æ§åˆ¶** - æ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹ç‰ˆæœ¬ç®¡ç†  

### æ”¹è¿›ç©ºé—´

âš ï¸ **IDP ä¾èµ–é—®é¢˜** - éœ€è¦è§£å†³ oidc-provider å…¼å®¹æ€§  
ğŸ“ **æ–‡æ¡£å®Œå–„** - å¯ä»¥æ·»åŠ æ›´å¤šæ•…éšœæ’æŸ¥æŒ‡å—  
ğŸ”’ **å®‰å…¨åŠ å›º** - ç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®æ›´å¼ºçš„å®‰å…¨æªæ–½  

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Dockerfile è¯¦ç»†è¯´æ˜](./dockerfiles/README.md)
- [Docker è¿ç§»æŒ‡å—](./DOCKER_MIGRATION_GUIDE.md)
- [ç¯å¢ƒå˜é‡é…ç½®](./deploy/env.example)
- [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT_GUIDE.md)

---

## ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®

1. **ä¼˜å…ˆä¿®å¤ IDP é—®é¢˜**
   - å°è¯•åœ¨ package.json ä¸­æ·»åŠ ä¾èµ– overrides
   - æˆ–è€ƒè™‘å‡çº§åˆ° oidc-provider æœ€æ–°ç‰ˆæœ¬
   - æˆ–ä½¿ç”¨æ›¿ä»£çš„è®¤è¯æ–¹æ¡ˆ

2. **ä¼˜åŒ–æ„å»ºæ€§èƒ½**
   - ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºçš„æ„å»ºç¼“å­˜
   - è€ƒè™‘ä½¿ç”¨ BuildKit çš„ç¼“å­˜æŒ‚è½½

3. **å¢å¼ºç›‘æ§**
   - æ·»åŠ  Prometheus + Grafana ç›‘æ§
   - é…ç½®æ—¥å¿—èšåˆï¼ˆELK Stackï¼‰

4. **CI/CD é›†æˆ**
   - é…ç½® Jenkins/GitHub Actions è‡ªåŠ¨æ„å»º
   - è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`docker logs [container_name]`
2. æ£€æŸ¥å¥åº·çŠ¶æ€ï¼š`docker inspect [container_name]`
3. éªŒè¯ç½‘ç»œè¿æ¥ï¼š`docker network inspect shared-network`
4. é‡å»ºæœåŠ¡ï¼š`docker-compose up -d --force-recreate [service_name]`

---

**æ›´æ–°æ—¥æœŸ**: 2026-02-04  
**Docker ç‰ˆæœ¬**: Docker Desktop for Windows  
**Node.js ç‰ˆæœ¬**: 20.20.0  
**çŠ¶æ€**: ä¸»åº”ç”¨è¿è¡Œæ­£å¸¸ï¼ŒIDP å¾…ä¿®å¤
