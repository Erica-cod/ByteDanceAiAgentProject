# Handlers ç›®å½• - Presentation Layerï¼ˆå±•ç¤ºå±‚ï¼‰

## ğŸ“ æ¶æ„å®šä½

**Handlers** æ˜¯ Clean Architecture çš„ **Presentation Layerï¼ˆå±•ç¤ºå±‚ï¼‰**ï¼Œè´Ÿè´£å¤„ç† HTTP è¯·æ±‚å’Œ SSE æµå¼å“åº”ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Presentation Layer                       â”‚
â”‚                      (api/handlers/)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ sseHandler   â”‚  â”‚singleAgent   â”‚  â”‚ multiAgent   â”‚      â”‚
â”‚  â”‚              â”‚  â”‚Handler       â”‚  â”‚ Handler      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚                  â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                  â”‚
          â–¼                 â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Application Layer (Use Cases)                  â”‚
â”‚                 (api/_clean/application/)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚CreateMessageUC   â”‚  â”‚UpdateConvUC      â”‚  ...            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ èŒè´£

### âœ… Handlers çš„èŒè´£ï¼ˆåº”è¯¥åšä»€ä¹ˆï¼‰
- æ¥æ”¶ HTTP/SSE è¯·æ±‚
- å‚æ•°éªŒè¯å’Œè½¬æ¢
- è°ƒç”¨ **Application Layer Use Cases** æ‰§è¡Œä¸šåŠ¡é€»è¾‘
- å¤„ç† SSE æµå¼è¾“å‡º
- é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼åŒ–
- å¹¶å‘æ§åˆ¶ï¼ˆSSE é™æµï¼‰

### âŒ Handlers ä¸åº”è¯¥åšä»€ä¹ˆ
- âŒ ç›´æ¥è®¿é—®æ•°æ®åº“
- âŒ åŒ…å«ä¸šåŠ¡é€»è¾‘
- âŒ è°ƒç”¨æ—§çš„ Servicesï¼ˆå·²å…¨éƒ¨è¿ç§»åˆ° Use Casesï¼‰

## ğŸ“‚ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒ Handlers

| æ–‡ä»¶ | ä½œç”¨ | è°ƒç”¨çš„ Use Cases |
|------|------|------------------|
| `sseHandler.ts` | ä¸» SSE æµå¤„ç†å™¨ï¼Œå¤„ç†å• Agent æ¨¡å¼çš„æµå¼å“åº” | `CreateMessageUseCase`<br>`UpdateConversationUseCase`<br>`GetConversationUseCase` |
| `singleAgentHandler.ts` | å• Agent å¤„ç†å™¨ï¼ˆæœ¬åœ°/ç«å±±å¼•æ“æ¨¡å‹ï¼‰ | `CreateMessageUseCase`<br>`UpdateConversationUseCase` |
| `multiAgentHandler.ts` | å¤š Agent åä½œå¤„ç†å™¨ | `SaveSessionUseCase`<br>`LoadSessionUseCase`<br>`CreateMessageUseCase` |
| `workflowProcessor.ts` | å·¥ä½œæµå¤„ç†å™¨ï¼ˆå·¥å…·è°ƒç”¨ã€å¤šè½®å¯¹è¯ï¼‰ | - |

### è¾…åŠ©æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `sseStreamWriter.ts` | SSE æµå†™å…¥è¾…åŠ©ç±»ï¼ˆå¿ƒè·³ã€é”™è¯¯å¤„ç†ï¼‰ |
| `sseLocalHandler.ts` | æœ¬åœ°æ¨¡å‹ SSE å¤„ç†å™¨ |
| `sseVolcanoHandler.ts` | ç«å±±å¼•æ“æ¨¡å‹ SSE å¤„ç†å™¨ |
| `sseHandler.refactored.ts` | é‡æ„å‚è€ƒæ–‡ä»¶ï¼ˆå¯åˆ é™¤ï¼‰ |

## ğŸ”— ä¸ Clean Architecture çš„åä½œ

```typescript
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šHandler è°ƒç”¨ Use Case
// æ–‡ä»¶ï¼šsseHandler.ts

import { getContainer } from '../_clean/di-container.js';

// 1. è·å– DI å®¹å™¨
const container = getContainer();

// 2. è·å– Use Case
const createMessageUseCase = container.getCreateMessageUseCase();
const updateConversationUseCase = container.getUpdateConversationUseCase();

// 3. è°ƒç”¨ Use Case æ‰§è¡Œä¸šåŠ¡é€»è¾‘
await createMessageUseCase.execute(
  conversationId,
  userId,
  'assistant',
  content,
  clientAssistantMessageId,
  modelType
);
```

## ğŸš« ä¸ºä»€ä¹ˆä¸è¿ç§»åˆ° `_clean/`ï¼Ÿ

### åŸå›  1ï¼šHandlers æœ¬èº«å°±æ˜¯æ¶æ„çš„ä¸€éƒ¨åˆ†
Handlers æ˜¯ **Presentation Layer**ï¼ŒClean Architecture çš„æœ€å¤–å±‚ï¼Œå®ƒä»¬çš„ä½ç½®æ˜¯æ­£ç¡®çš„ã€‚

### åŸå›  2ï¼šå·²ç»å®Œå…¨è§£è€¦
- âœ… æ‰€æœ‰ Handlers éƒ½é€šè¿‡ DI å®¹å™¨è·å– Use Cases
- âœ… ä¸ä¾èµ–ä»»ä½•æ—§çš„ Services
- âœ… åªè´Ÿè´£ HTTP/SSE åè®®å¤„ç†

### åŸå›  3ï¼šèŒè´£æ¸…æ™°
```
api/handlers/    â† Presentation Layerï¼ˆä½ åœ¨è¿™é‡Œï¼‰
    â†“ è°ƒç”¨
api/_clean/application/use-cases/  â† Application Layer
    â†“ è°ƒç”¨
api/_clean/domain/entities/        â† Domain Layer
```

## ğŸ“Š è¿ç§»å®ŒæˆçŠ¶æ€

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| âœ… ä½¿ç”¨ Use Cases | 100% | æ‰€æœ‰ Handlers éƒ½å·²è¿ç§» |
| âœ… ç§»é™¤æ—§ Services | 100% | é›¶ä¾èµ–æ—§ä»£ç  |
| âœ… ä¾èµ–æ³¨å…¥ | 100% | é€šè¿‡ DI å®¹å™¨è·å–ä¾èµ– |

## ğŸ‰ ç»“è®º

**Handlers ä¸éœ€è¦è¿ç§»ï¼Œå®ƒä»¬å·²ç»æ˜¯ Clean Architecture çš„ä¸€éƒ¨åˆ†ï¼**

è¿™ä¸ªç›®å½•çš„ä»£ç è´¨é‡å¾ˆé«˜ï¼ŒèŒè´£æ¸…æ™°ï¼Œä¸ Clean Architecture çš„å…¶ä»–å±‚åä½œè‰¯å¥½ã€‚

